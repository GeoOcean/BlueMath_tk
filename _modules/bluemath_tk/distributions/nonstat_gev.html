

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bluemath_tk.distributions.nonstat_gev &mdash; Bluemath-Toolkit  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/thebelab.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Bluemath-Toolkit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">bluemath_tk</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Bluemath-Toolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bluemath_tk.distributions.nonstat_gev</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bluemath_tk.distributions.nonstat_gev</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">root_scalar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">genextreme</span><span class="p">,</span> <span class="n">norm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..core.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlueMathModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.plotting.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_colors</span>

<span class="c1"># @njit(fastmath=True)</span>
<span class="c1"># def search(times: np.ndarray, values: np.ndarray, xs) -&gt; np.ndarray:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Function to search the nearest value of certain time to use in self._parametro function</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     times : np.ndarray</span>
<span class="c1">#         Times when covariates are known</span>
<span class="c1">#     values : np.ndarray</span>
<span class="c1">#         Values of the covariates at those times</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     # n = times.shape[0]</span>
<span class="c1">#     # yin = np.zeros_like(xs)</span>
<span class="c1">#     # pos = 0</span>
<span class="c1">#     # for j in range(xs.size):</span>
<span class="c1">#     #     found = 0</span>
<span class="c1">#     #     while found == 0 and pos &lt; n:</span>
<span class="c1">#     #         if xs[j] &lt; times[pos]:</span>
<span class="c1">#     #             yin[j] = values[pos]</span>
<span class="c1">#     #             found = 1</span>
<span class="c1">#     #         else:</span>
<span class="c1">#     #             pos += 1</span>

<span class="c1">#     # return yin</span>

<span class="c1">#     idx = np.searchsorted(times, xs, side=&#39;right&#39;)</span>
<span class="c1">#     mask = idx &lt; len(times)</span>

<span class="c1">#     return values[idx[mask]]</span>


<div class="viewcode-block" id="NonStatGEV">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NonStatGEV</span><span class="p">(</span><span class="n">BlueMathModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Non-Stationary Generalized Extreme Value Distribution</span>

<span class="sd">    Class to implement the Non-Stationary GEV including trends and/or covariates</span>
<span class="sd">    in the location, scale and shape parameters. This methodology selects the</span>
<span class="sd">    covariates and trends based on which of them minimize the Akaike Information Criteria (AIC).</span>

<span class="sd">    This class is based in the work of R. MÃ­nguez et al. 2010. &quot;Pseudooptimal parameter selection</span>
<span class="sd">    of non-stationary generalized extreme value models for environmental variables&quot;. Environ. Model. Softw. 25, 1592-1607.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xt : np.ndarray</span>
<span class="sd">        Data to fit Non Stationary GEV.</span>
<span class="sd">    t : np.ndarray, default=None.</span>
<span class="sd">        Time associated to the data.</span>
<span class="sd">    covariates: np.ndarray | pd.DataFrame, default=None.</span>
<span class="sd">        Covariates to include for location, scale and shape parameters.</span>
<span class="sd">    kt : np.ndarray, default=None.</span>
<span class="sd">        Frequency of block maxima, if None, it is assumed to be 1.</span>
<span class="sd">    trends: bool, defaul=False.</span>
<span class="sd">        Whether trends should be included, if so, t must be passed.</span>
<span class="sd">    quanval : float, default=0.95.</span>
<span class="sd">        Confidence interval value</span>
<span class="sd">    var_name : str, default=&quot;x&quot;</span>
<span class="sd">        Name of the variable to be used in the model.</span>
<span class="sd">        Used for plotting purposes.</span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    fit:</span>
<span class="sd">        Fit the Non-Stationary GEV with desired Trends and Covariates.</span>
<span class="sd">    auto_adjust:</span>
<span class="sd">        Automatically selects the best covariates and trends based on AIC.</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from bluemath_tk.distributions.nonstat_gev import NonStatGEV</span>
<span class="sd">    &gt;&gt;&gt; nonstat_gev = NonStatGEV(x, t, covariates, trends=True)</span>
<span class="sd">    &gt;&gt;&gt; fit_result = nonstat_gev.auto_adjust()</span>
<span class="sd">    &gt;&gt;&gt; fit_result = nonstat_gev.fit(nmu=2,npsi=2,ngamma=2,ntrend_loc=1,list_loc=&quot;all&quot;,ntrend_sc=1,list_sc=&quot;all&quot;,ntrend_sh=1,list_sh=&quot;all&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">harms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">kt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quanval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiliaze the Non-Stationary GEV.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_logger_name</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing NonStatGEV&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xt</span> <span class="o">=</span> <span class="n">xt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_covariates</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_covariates</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">harms</span> <span class="o">=</span> <span class="n">harms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trends</span> <span class="o">=</span> <span class="n">trends</span>
        <span class="k">if</span> <span class="n">kt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">=</span> <span class="n">kt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span> <span class="o">=</span> <span class="n">quanval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>

        <span class="c1"># Initialize parameters associated to the GEV</span>
        <span class="c1"># Location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Location intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Location harmonic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">betaT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Location trend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Location covariates</span>
        <span class="c1"># Scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Scale intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Scale harmonic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Scale trend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Scale covariates</span>
        <span class="c1"># Shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape harmonic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape trend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape covariates</span>

        <span class="c1"># Initilize the number of parameters used</span>
        <span class="c1"># Location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of harmonic part of location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of covariates part of location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of trend part of location</span>
        <span class="c1"># Scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of harmonic part of scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of covariates part of scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of trend part of scale</span>
        <span class="c1"># Shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1 if shape parameter is included, defaul Weibull or Frechet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of harmonic part of shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of covariates part of shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of trend part of shape</span>

        <span class="c1"># Color palette</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">default_colors</span>

<div class="viewcode-block" id="NonStatGEV.auto_adjust">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.auto_adjust">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">auto_adjust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">stationary_shape</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method automatically select and calculate the parameters which minimize the AIC related to</span>
<span class="sd">        Non-Stationary GEV distribution using the Maximum Likelihood method within an iterative scheme,</span>
<span class="sd">        including one parameter at a time based on a perturbation criteria.</span>
<span class="sd">        The process is repeated until no further improvement in the objective function is achieved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_iter : int, default=1000</span>
<span class="sd">            Number of iteration in optimization process.</span>
<span class="sd">        plot : bool, default=False</span>
<span class="sd">            If plot the adjusted distribution</span>
<span class="sd">        stationary_shape : bool, default=False</span>
<span class="sd">            If True, the shape parameter remain stationary</span>

<span class="sd">        Return</span>
<span class="sd">        ----------</span>
<span class="sd">        fit_result : dict</span>
<span class="sd">            Dictionary with the optimal parameters and values related to the Non-Stationary GEV distribution.</span>
<span class="sd">            The keys of the dictionary are:</span>
<span class="sd">            - x: Optimal solution</span>
<span class="sd">            - beta0, beta, betaT, beta_cov: Location parameters (intercept, harmonic, trend, covariates)</span>
<span class="sd">            - alpha0, alpha, alphaT, alpha_cov: Scale parameters (intercept, harmonic, trend, covariates)</span>
<span class="sd">            - gamma0, gamma, gammaT, gamma_cov: Shape parameters (intercept, harmonic, trend, covariates)</span>
<span class="sd">            - negloglikelihood: Negative log-likelihood value at the optimal solution</span>
<span class="sd">            - loglikelihood: Log-likelihood value at the optimal solution</span>
<span class="sd">            - grad: Gradient of the log-likelihood function at the optimal solution</span>
<span class="sd">            - hessian: Hessian matrix of the log-likelihood function at the optimal solution</span>
<span class="sd">            - AIC: Akaike Information Criterion value at the optimal solution</span>
<span class="sd">            - invI0: Fisher information matrix at the optimal solution</span>
<span class="sd">            - std_param: Standard deviation of parameters at the optimal solution</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>  <span class="c1"># Set maximum number of iterations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span>
        <span class="p">)</span>  <span class="c1"># Initialize the values of AIC in each iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span>
        <span class="p">)</span>  <span class="c1"># Initialize the values of Loglikelihood in each iteration</span>

        <span class="c1">### Step 1: Only stationary parameters</span>
        <span class="n">nmu</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of harmonic part of location</span>
        <span class="n">npsi</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of harmonic part of scale</span>
        <span class="n">ngamma</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of harmonic part of shape</span>
        <span class="n">nind_loc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of covariates part of location</span>
        <span class="n">ntrend_loc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of trend part of location</span>
        <span class="n">nind_sc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of covariates part of scale</span>
        <span class="n">ntrend_sc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of trend part of scale</span>
        <span class="n">nind_sh</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of covariates part of shape</span>
        <span class="n">ntrend_sh</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of parameters of trend part of shape</span>

        <span class="c1">######### HARMONIC Iterative process #########</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">harms</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Harmonic iterative process&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">):</span>
                <span class="c1">### Step 2: Fit for the selected parameters (initial step is stationary)</span>
                <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">nmu</span><span class="p">,</span> <span class="n">npsi</span><span class="p">,</span> <span class="n">ngamma</span><span class="p">)</span>

                <span class="c1"># Check if the model is Gumbel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Compute AIC and Loglikelihood</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>
                <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span>
                <span class="p">)</span>

                <span class="c1">### Step 4: Sensitivity of optimal loglikelihood respect to possible additional harmonics</span>
                <span class="c1"># for the location, scale and shape parameters.</span>
                <span class="c1"># Note that the new parameter values are set to zero since derivatives do not depend on them</span>
                <span class="n">fit_result_aux</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># Location</span>
                <span class="k">if</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="c1"># Scale</span>
                <span class="k">if</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="c1"># Shape</span>
                <span class="k">if</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

                <span class="n">auxf</span><span class="p">,</span> <span class="n">auxJx</span><span class="p">,</span> <span class="n">auxHxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">(</span>
                    <span class="n">beta0</span><span class="o">=</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;beta0&quot;</span><span class="p">],</span>
                    <span class="n">beta</span><span class="o">=</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">],</span>
                    <span class="n">alpha0</span><span class="o">=</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;alpha0&quot;</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
                    <span class="n">gamma0</span><span class="o">=</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">],</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># Inverse of the Information Matrix (auxHxx)</span>
                <span class="n">auxI0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">auxHxx</span><span class="p">)</span>

                <span class="c1"># Updating the best model</span>
                <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># TODO: Implement another criterias (Proflike)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">modelant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nmu</span><span class="p">,</span> <span class="n">npsi</span><span class="p">,</span> <span class="n">ngamma</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">modelant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nmu</span><span class="p">,</span> <span class="n">npsi</span><span class="p">,</span> <span class="n">ngamma</span><span class="p">])</span>

                <span class="c1">### Step 5: Compute maximum perturbation</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># Perturbation for location</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">auxJx</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                    <span class="o">@</span> <span class="n">auxI0</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="o">@</span> <span class="n">auxJx</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="c1"># Perturbation for scale</span>
                <span class="n">auxmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                    <span class="n">auxJx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">T</span>
                    <span class="o">@</span> <span class="n">auxI0</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="o">@</span> <span class="n">auxJx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">auxmax</span> <span class="o">&gt;</span> <span class="n">max_val</span><span class="p">:</span>
                    <span class="n">max_val</span> <span class="o">=</span> <span class="n">auxmax</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">stationary_shape</span><span class="p">:</span>
                    <span class="c1"># Perturbation for shape</span>
                    <span class="n">auxmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                        <span class="n">auxJx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span>
                            <span class="o">+</span> <span class="mi">2</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">T</span>
                        <span class="o">@</span> <span class="n">auxI0</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span>
                            <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span>
                            <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">]</span>
                        <span class="o">@</span> <span class="n">auxJx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="mi">4</span>
                            <span class="o">+</span> <span class="mi">2</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">auxmax</span> <span class="o">&gt;</span> <span class="n">max_val</span><span class="p">:</span>
                        <span class="n">max_val</span> <span class="o">=</span> <span class="n">auxmax</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="mi">3</span>

                <span class="c1"># If maximum perturbation corresponds to location, include a new harmonic</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nmu</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># If maximum perturbation corresponds to scale, include a new harmonic</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">npsi</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># If maximum perturbation corresponds to shape, include a new harmonic</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">ngamma</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iteration: &quot;</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="s2">&quot;- AIC: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">modelant</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># loglikeobjITini = self.loglike_iter[iter - 1]</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nmu</span><span class="p">,</span> <span class="n">npsi</span><span class="p">,</span> <span class="n">ngamma</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span> <span class="o">=</span> <span class="nb">iter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">=</span> <span class="nb">iter</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End of the Harmonic iterative process&quot;</span><span class="p">)</span>

            <span class="c1">######### End of the Harmonic iterative process</span>
            <span class="c1"># Obtaining the MLE for the best model</span>
            <span class="n">nmu</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">npsi</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ngamma</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># CHECKING THE SHAPE PARAMETER</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">0</span>  <span class="c1"># Force the elimination of the constant shape parameter (gamma0)</span>
            <span class="p">)</span>
            <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">nmu</span><span class="p">,</span> <span class="n">npsi</span><span class="p">,</span> <span class="n">ngamma</span><span class="p">)</span>

            <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span>
                <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># The constant shape parameter (gamma0) is significative</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">nmu</span><span class="p">,</span> <span class="n">npsi</span><span class="p">,</span> <span class="n">ngamma</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Harmonic AIC:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">=</span> <span class="n">nmu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">=</span> <span class="n">npsi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">=</span> <span class="n">ngamma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set 0 the number of harmonics parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">)</span>

            <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span> <span class="o">=</span> <span class="nb">iter</span>
            <span class="c1"># Check if the model is Gumbel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Compute AIC and Loglikelihood</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span><span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span><span class="p">)</span>

        <span class="c1">######### COVARIATES Iterative process #########</span>
        <span class="n">final_fit_result</span> <span class="o">=</span> <span class="n">fit_result</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">nind_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Number of covariates</span>

        <span class="c1"># Auxiliar variables related to location parameter</span>
        <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
        <span class="n">list_loc</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of covariates for location</span>
        <span class="c1"># auxcov_loc = self.covariates.iloc[:, list_loc].values</span>
        <span class="c1"># Auxiliar variables related to scale parameter</span>
        <span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
        <span class="n">list_sc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># auxcov_sc = self.covariates.iloc[:, list_sc].values</span>
        <span class="c1"># Auxiliar variables related to shape parameter</span>
        <span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
        <span class="n">list_sh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># auxcov_sh = self.covariates.iloc[:, list_sh].values</span>

        <span class="n">auxlist_cov</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nind_cov</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_covariates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Covariates iterative process&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">auxbeta_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nind_cov</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">auxbeta_cov</span><span class="p">[</span><span class="n">list_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_cov</span>
                <span class="n">auxalpha_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nind_cov</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_sc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">auxalpha_cov</span><span class="p">[</span><span class="n">list_sc</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_cov</span>
                <span class="n">auxgamma_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nind_cov</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_sh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">auxgamma_cov</span><span class="p">[</span><span class="n">list_sh</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_cov</span>

                <span class="c1">### Step 9: Calculate the sensitivities of the optimal log-likelihood objective function with respect to possible</span>
                <span class="c1"># additional covariates for the location and  scale parameters</span>
                <span class="n">auxf</span><span class="p">,</span> <span class="n">auxJx</span><span class="p">,</span> <span class="n">auxHxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">(</span>
                    <span class="n">beta0</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta0&quot;</span><span class="p">],</span>
                    <span class="n">beta</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">],</span>
                    <span class="n">beta_cov</span><span class="o">=</span><span class="n">auxbeta_cov</span><span class="p">,</span>
                    <span class="n">alpha0</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha0&quot;</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
                    <span class="n">alpha_cov</span><span class="o">=</span><span class="n">auxalpha_cov</span><span class="p">,</span>
                    <span class="n">gamma0</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">],</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
                    <span class="n">gamma_cov</span><span class="o">=</span><span class="n">auxgamma_cov</span><span class="p">,</span>
                    <span class="n">list_loc</span><span class="o">=</span><span class="n">auxlist_cov</span><span class="p">,</span>
                    <span class="n">list_sc</span><span class="o">=</span><span class="n">auxlist_cov</span><span class="p">,</span>
                    <span class="n">list_sh</span><span class="o">=</span><span class="n">auxlist_cov</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Step 10: Include in the parameter vector the corresponding covariate</span>
                <span class="n">auxI0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">auxHxx</span><span class="p">)</span>
                <span class="c1"># Perturbation of location</span>
                <span class="n">values1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">auxJx</span><span class="p">[</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_cov</span>
                    <span class="p">]</span>
                    <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
                        <span class="n">auxI0</span><span class="p">[</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">maximo_loc</span><span class="p">,</span> <span class="n">pos_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values1</span><span class="p">)</span>
                <span class="c1"># Perturbation of scale</span>
                <span class="n">values2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">auxJx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_cov</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_cov</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_cov</span>
                    <span class="p">]</span>
                    <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
                        <span class="n">auxI0</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">maximo_sc</span><span class="p">,</span> <span class="n">pos_sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">stationary_shape</span><span class="p">:</span>
                    <span class="c1"># Perturbation of shape</span>
                    <span class="n">values3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                        <span class="n">auxJx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">nind_cov</span>
                        <span class="p">]</span>
                        <span class="o">**</span> <span class="mi">2</span>
                        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
                            <span class="n">auxI0</span><span class="p">[</span>
                                <span class="mi">2</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                                <span class="o">+</span> <span class="n">ntrend_loc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                                <span class="o">+</span> <span class="n">ntrend_sc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                                <span class="o">+</span> <span class="n">ntrend_loc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                                <span class="o">+</span> <span class="n">ntrend_sc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                                <span class="o">+</span> <span class="n">ntrend_sh</span>
                                <span class="o">+</span> <span class="n">nind_cov</span><span class="p">,</span>
                                <span class="mi">2</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                                <span class="o">+</span> <span class="n">ntrend_loc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                                <span class="o">+</span> <span class="n">ntrend_sc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                                <span class="o">+</span> <span class="n">ntrend_loc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                                <span class="o">+</span> <span class="n">ntrend_sc</span>
                                <span class="o">+</span> <span class="n">nind_cov</span>
                                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                                <span class="o">+</span> <span class="n">ntrend_sh</span>
                                <span class="o">+</span> <span class="n">nind_cov</span><span class="p">,</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">maximo_sh</span><span class="p">,</span> <span class="n">pos_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values3</span><span class="p">)</span>


                    <span class="c1"># Select the maximum perturbation</span>
                    <span class="n">posmaxparam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">maximo_loc</span><span class="p">,</span> <span class="n">maximo_sc</span><span class="p">,</span> <span class="n">maximo_sh</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">posmaxparam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">maximo_loc</span><span class="p">,</span> <span class="n">maximo_sc</span><span class="p">])</span>

                <span class="c1"># Initialize auxiliar covariates variables</span>
                <span class="k">if</span> <span class="n">beta_cov</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">beta_cov_init</span> <span class="o">=</span> <span class="n">beta_cov</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">beta_cov_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">alpha_cov</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alpha_cov_init</span> <span class="o">=</span> <span class="n">alpha_cov</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha_cov_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">gamma_cov</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gamma_cov_init</span> <span class="o">=</span> <span class="n">gamma_cov</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gamma_cov_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([])</span>

                <span class="k">if</span> <span class="n">posmaxparam</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Add covariate to location</span>
                    <span class="n">nind_loc</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">list_loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_loc</span><span class="p">))</span>
                    <span class="n">beta_cov_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">beta_cov_init</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># Initialize the new covariate as zero</span>
                <span class="k">elif</span> <span class="n">posmaxparam</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Add covariate to scale</span>
                    <span class="n">nind_sc</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">list_sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_sc</span><span class="p">))</span>
                    <span class="n">alpha_cov_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">alpha_cov_init</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># Initialize the new covariate as zero</span>
                <span class="k">elif</span> <span class="n">posmaxparam</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Add covariate to shape</span>
                    <span class="n">nind_sh</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">list_sh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_sh</span><span class="p">))</span>
                    <span class="n">gamma_cov_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">gamma_cov_init</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># Initialize the new covariate as zero</span>

                <span class="c1"># Update auxiliar covariates</span>
                <span class="c1"># auxcov_loc = self.covariates.iloc[:, list_loc].values</span>
                <span class="c1"># auxcov_sc = self.covariates.iloc[:, list_sc].values</span>
                <span class="c1"># auxcov_sh = self.covariates.iloc[:, list_sh].values</span>

                <span class="c1">### Step 11: Obtain the maximum-likelihood estimators for the selected parameters and</span>
                <span class="c1"># calculate the Akaike Information criterion objective function AIC</span>
                <span class="n">concatvalues</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span><span class="p">],</span>
                    <span class="n">beta_cov_init</span><span class="p">,</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span><span class="p">],</span>
                    <span class="n">alpha_cov_init</span><span class="p">,</span>
                    <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span><span class="p">),</span>
                    <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span><span class="p">),</span>
                    <span class="n">gamma_cov_init</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">xini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">concatvalues</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
                    <span class="n">list_loc</span><span class="p">,</span>
                    <span class="n">ntrend_loc</span><span class="p">,</span>
                    <span class="n">list_sc</span><span class="p">,</span>
                    <span class="n">ntrend_sc</span><span class="p">,</span>
                    <span class="n">list_sh</span><span class="p">,</span>
                    <span class="n">ntrend_sh</span><span class="p">,</span>
                    <span class="n">xini</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Check if model is Gumbel</span>
                <span class="c1"># self.ngamma0 =</span>
                <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iteration: &quot;</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="s2">&quot;- AIC: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="c1"># Update the parameters</span>
                    <span class="n">final_fit_result</span> <span class="o">=</span> <span class="n">fit_result</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result</span><span class="p">)</span>
                    <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;beta_cov&quot;</span><span class="p">)</span>
                    <span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha_cov&quot;</span><span class="p">)</span>
                    <span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma_cov&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span> <span class="o">=</span> <span class="n">list_loc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">=</span> <span class="n">nind_loc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span> <span class="o">=</span> <span class="n">list_sc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">=</span> <span class="n">nind_sc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span> <span class="o">=</span> <span class="n">list_sh</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">=</span> <span class="n">nind_sh</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">posmaxparam</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">list_loc</span> <span class="o">=</span> <span class="n">list_loc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">beta_cov</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">nind_loc</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">posmaxparam</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">list_sc</span> <span class="o">=</span> <span class="n">list_sc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">alpha_cov</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">nind_sc</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">list_sh</span> <span class="o">=</span> <span class="n">list_sh</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">gamma_cov</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">nind_sh</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">final_fit_result</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">niter_cov</span> <span class="o">=</span> <span class="nb">iter</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">niter_harm</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">=</span> <span class="nb">iter</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span> <span class="o">=</span> <span class="n">list_loc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">=</span> <span class="n">nind_loc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span> <span class="o">=</span> <span class="n">list_sc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">=</span> <span class="n">nind_sc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span> <span class="o">=</span> <span class="n">list_sh</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">=</span> <span class="n">nind_sh</span>
                    <span class="k">break</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End of Covariates iterative process&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Covariates AIC:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No covariates provided, skipping Covariates iterative process&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span> <span class="o">=</span> <span class="n">list_loc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">=</span> <span class="n">nind_loc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span> <span class="o">=</span> <span class="n">list_sc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">=</span> <span class="n">nind_sc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span> <span class="o">=</span> <span class="n">list_sh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">=</span> <span class="n">nind_sh</span>

        <span class="c1">######### TRENDS Iterative process #########</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trends</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Trends process&quot;</span><span class="p">)</span>
            <span class="c1"># Location trends</span>
            <span class="n">ntrend_loc</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Initial parameter</span>
            <span class="n">concatvalues</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntrend_loc</span><span class="p">),</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="p">],</span>  <span class="c1"># Location initial parameter beta0, beta, betaT, beta_cov</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="p">],</span>  <span class="c1"># Scale initial parameter alpha0, alpha, alpha_cov</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span><span class="p">),</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="p">:</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span> <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="p">),</span>  <span class="c1"># Shape initial parameter gamma0, gamma, gamma_cov</span>
            <span class="p">]</span>
            <span class="n">xini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">concatvalues</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">fit_result_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">,</span>
                <span class="n">ntrend_loc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">,</span>
                <span class="n">ntrend_sc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">,</span>
                <span class="n">ntrend_sh</span><span class="p">,</span>
                <span class="n">xini</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span>
                <span class="o">-</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result_aux</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Location trend is significative&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Location trend AIC: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span><span class="p">)</span>
                <span class="c1"># Update the parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result_aux</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">=</span> <span class="n">ntrend_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Location trend is NOT significative&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Scale trend</span>
            <span class="n">ntrend_sc</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">concatvalues</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span><span class="p">),</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="p">],</span>  <span class="c1"># Location initial parameter beta0, beta, betaT, beta_cov</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntrend_sc</span><span class="p">),</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="p">:</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="p">],</span>  <span class="c1"># Scale initial parameter alpha0, alpha, alphaT, alpha_cov</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span><span class="p">),</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="p">:</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span> <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="p">),</span>  <span class="c1"># Shape initial parameter gamma0, gamma, gamma_cov</span>
            <span class="p">]</span>
            <span class="n">xini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">concatvalues</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">,</span>
                <span class="n">ntrend_sc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">,</span>
                <span class="n">ntrend_sh</span><span class="p">,</span>
                <span class="n">xini</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span>
                <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scale trend is significative&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scale trend AIC: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span><span class="p">)</span>
                <span class="c1"># Update the parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">=</span> <span class="n">ntrend_sc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scale trend is NOT significative&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Shape trends</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stationary_shape</span><span class="p">:</span>
                <span class="n">ntrend_sh</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">concatvalues</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span><span class="p">),</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="p">],</span>  <span class="c1"># Location initial parameter beta0, beta, betaT, beta_cov</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span><span class="p">),</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>  <span class="c1"># Scale initial parameter alpha0, alpha, alphaT, alpha_cov</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span><span class="p">),</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span><span class="p">),</span>
                    <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntrend_sh</span><span class="p">),</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">]</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                        <span class="n">nind_sh</span>
                    <span class="p">),</span>  <span class="c1"># Shape initial parameter gamma0, gamma, gammaT, gamma_cov</span>
                <span class="p">]</span>
                <span class="n">xini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">concatvalues</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">,</span>
                    <span class="n">ntrend_sh</span><span class="p">,</span>
                    <span class="n">xini</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loglike_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AIC_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nit</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape trend is significative&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape trend AIC: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AICini</span><span class="p">)</span>
                    <span class="c1"># Update the parameters</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">=</span> <span class="n">ntrend_sh</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape trend is NOT significative&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">aux_gamma0</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Final parameters values</span>
        <span class="n">concatvalues</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span><span class="p">),</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="p">],</span>  <span class="c1"># Location initial parameter beta0, beta, betaT, beta_cov</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span><span class="p">),</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="p">],</span>  <span class="c1"># Scale initial parameter alpha0, alpha, alphaT, alpha_cov</span>
            <span class="n">aux_gamma0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span><span class="p">),</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_sc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
            <span class="p">]</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span><span class="p">),</span>
            <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span><span class="p">),</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
            <span class="p">]</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="n">nind_sh</span>
            <span class="p">),</span>  <span class="c1"># Shape initial parameter gamma0, gamma, gammaT, gamma_cov</span>
        <span class="p">]</span>
        <span class="n">xini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">concatvalues</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span><span class="p">,</span>
            <span class="n">xini</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result</span><span class="p">)</span>

        <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span>
        <span class="p">)</span>

        <span class="c1"># Compute the final loglikelihood and the information matrix</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">Jx</span><span class="p">,</span> <span class="n">Hxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">list_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">,</span>
            <span class="n">list_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">,</span>
            <span class="n">list_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;loglikelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;grad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jx</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;hessian&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">Hxx</span><span class="p">)</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;invI0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span>

        <span class="n">std_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_params</span> <span class="o">=</span> <span class="n">std_params</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;std_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_params</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fit_result</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nmu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">npsi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ngamma</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">ntrend_loc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">ntrend_sc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">ntrend_sh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">xini</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auxiliar function to determine the optimal parameters of given Non-Stationary GEV</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nmu : int, default=0</span>
<span class="sd">            Number of parameters of harmonic part of location.</span>
<span class="sd">        npsi : int, default=0</span>
<span class="sd">            Number of parameters of harmonic part of scale.</span>
<span class="sd">        ngamma : int, default=0</span>
<span class="sd">            Number of parameters of harmonic part of shape.</span>
<span class="sd">        list_loc : list, default=[]</span>
<span class="sd">            List of indices of covariates to be included in the location parameter.</span>
<span class="sd">        ntrend_loc : int, default=0</span>
<span class="sd">            If trends in location are included.</span>
<span class="sd">        list_sc : list, default=[]</span>
<span class="sd">            List of indices of covariates to be included in the scale parameter.</span>
<span class="sd">        ntrend_sc : int, default=0</span>
<span class="sd">            If trends in scale are included.</span>
<span class="sd">        list_sh : list, default=[]</span>
<span class="sd">            List of indices of covariates to be included in the shape parameter.</span>
<span class="sd">        ntrend_sh : int, default=0</span>
<span class="sd">            If trends in shape are included.</span>
<span class="sd">        xini : Optional[np.ndarray], default = None</span>
<span class="sd">            Initial parameter if given.</span>
<span class="sd">        options : dict, default={</span>
<span class="sd">                &quot;gtol&quot;: 1e-5,</span>
<span class="sd">                &quot;xtol&quot;: 1e-5,</span>
<span class="sd">                &quot;barrier_tol&quot;: 1e-4,</span>
<span class="sd">                &quot;maxiter&quot;: 200,</span>
<span class="sd">            }</span>
<span class="sd">            Dictionary with the optimization options, see scipy.minimize method &quot;trust-constr&quot; options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fitting options</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">maxiter</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                <span class="c1"># Aim for first-order optimality:</span>
                <span class="n">gtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>          <span class="c1"># or 1e-9 if your scaling is good</span>
                <span class="c1"># Make f-decrease test essentially inactive:</span>
                <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>         <span class="c1"># very small so it wonât trigger early</span>
                <span class="n">maxcor</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>          <span class="c1"># more curvature memory</span>
                <span class="n">maxls</span><span class="o">=</span><span class="mi">100</span>           <span class="c1"># more line-search steps</span>
            <span class="p">)</span>

        <span class="c1"># Total number of parameters to be estimated</span>
        <span class="n">nmu</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmu</span>
        <span class="n">npsi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npsi</span>
        <span class="n">ngamma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ngamma</span>
        <span class="n">nind_loc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_loc</span><span class="p">)</span>
        <span class="n">nind_sc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_sc</span><span class="p">)</span>
        <span class="n">nind_sh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_sh</span><span class="p">)</span>

        <span class="c1"># Initialize the parameters to be fitted</span>
        <span class="n">n_params</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
            <span class="o">+</span> <span class="n">nmu</span>
            <span class="o">+</span> <span class="n">npsi</span>
            <span class="o">+</span> <span class="n">ngamma</span>
            <span class="o">+</span> <span class="n">ntrend_loc</span>
            <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="o">+</span> <span class="n">ntrend_sc</span>
            <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="o">+</span> <span class="n">ntrend_sh</span>
            <span class="o">+</span> <span class="n">nind_sh</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">xini</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xini</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">n_params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Check the initial guess of fitting step (_fit function)&quot;</span>
                <span class="p">)</span>
            <span class="n">x_ini</span> <span class="o">=</span> <span class="n">xini</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_ini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span>
            <span class="n">x_ini</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span>  <span class="c1"># Initial value for intercept location</span>
            <span class="n">x_ini</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># Initial value for intercept scale</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x_ini</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mf">0.1</span>  <span class="c1"># Initial value for intercept shape</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_ini</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                <span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="c1"># If trend in shape is included</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_ini</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                <span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="c1"># If covariates in shape are included</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_ini</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span> <span class="p">:</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">nind_sh</span>
                <span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="c1"># Set bounds for all the parameters</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span>

        <span class="c1"># Initial bounds for the parameters related to the shape, gamma0 and gamma</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lb</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>
            <span class="n">ub</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>

        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lb</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>
            <span class="n">ub</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mf">0.15</span>

        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lb</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>
            <span class="n">ub</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mf">0.15</span>

        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lb</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
            <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>
            <span class="n">ub</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mf">0.15</span>

        <span class="c1"># Initialize the return dictionary</span>
        <span class="n">fit_result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If an inital value for the parameters vector is provided, it is used</span>
        <span class="c1"># if pini is not None and len(pini) &gt; 0:</span>
        <span class="c1">#     x_ini = np.minimum(pini, ub)</span>
        <span class="c1">#     x_ini = np.maximum(x, lb)</span>

        <span class="c1"># Set the bounds properly for scipy.optimize.minimize</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lb_i</span><span class="p">,</span> <span class="n">up_i</span><span class="p">)</span> <span class="k">for</span> <span class="n">lb_i</span><span class="p">,</span> <span class="n">up_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">fun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auxmin_loglikelihood</span><span class="p">,</span>
            <span class="n">x0</span><span class="o">=</span><span class="n">x_ini</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                <span class="n">nmu</span><span class="p">,</span>
                <span class="n">npsi</span><span class="p">,</span>
                <span class="n">ngamma</span><span class="p">,</span> 
                <span class="n">ntrend_loc</span><span class="p">,</span>
                <span class="n">list_loc</span><span class="p">,</span>
                <span class="n">ntrend_sc</span><span class="p">,</span> 
                <span class="n">list_sc</span><span class="p">,</span>
                <span class="n">ntrend_sh</span><span class="p">,</span>
                <span class="n">list_sh</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
            <span class="n">jac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auxmin_loglikelihood_grad</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxiter&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span>
                <span class="s1">&#39;gtol&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gtol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># Optimal parameters vector</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>  <span class="c1"># Optimal loglikelihood</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;AIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span><span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span><span class="p">)</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_params</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">message</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;grad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">grad</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;grad&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;jac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">jac</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;hess_inv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">hess_inv</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;hess_inv&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Check if any of the bounds related to shape parameters become active, if active increase or decrease the bound and call the optimization routine again</span>
        <span class="n">auxlb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.05</span>
                <span class="n">auxlb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.05</span>
                <span class="n">auxub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">auxlb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxub</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                <span class="n">fun</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auxmin_loglikelihood</span><span class="p">,</span>
                <span class="n">x0</span><span class="o">=</span><span class="n">x_ini</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">nmu</span><span class="p">,</span>
                    <span class="n">npsi</span><span class="p">,</span>
                    <span class="n">ngamma</span><span class="p">,</span> 
                    <span class="n">ntrend_loc</span><span class="p">,</span>
                    <span class="n">list_loc</span><span class="p">,</span>
                    <span class="n">ntrend_sc</span><span class="p">,</span> 
                    <span class="n">list_sc</span><span class="p">,</span>
                    <span class="n">ntrend_sh</span><span class="p">,</span>
                    <span class="n">list_sh</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
                <span class="n">jac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auxmin_loglikelihood_grad</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxiter&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                    <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ftol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span>
                    <span class="s1">&#39;gtol&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gtol&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># Optimal parameters vector</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>  <span class="c1"># Optimal loglikelihood</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;AIC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AIC</span><span class="p">(</span><span class="o">-</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;negloglikelihood&quot;</span><span class="p">],</span> <span class="n">n_params</span><span class="p">)</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_params</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">message</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;grad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">grad</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;grad&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;jac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">jac</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;jac&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;hess_inv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">hess_inv</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;hess_inv&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># &#39;hess_inv&#39; is only available if &#39;hess&#39; is provided</span>

            <span class="n">auxlb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">auxub</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.05</span>
                    <span class="n">auxlb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.05</span>
                    <span class="n">auxub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Location parameter</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;betaT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;betaT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta_cov&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta_cov&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Scale parameter</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alphaT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alphaT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha_cov&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha_cov&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Shape parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gammaT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gammaT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma_cov&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">nind_sh</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma_cov&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span> <span class="o">=</span> <span class="n">fit_result</span>

        <span class="k">return</span> <span class="n">fit_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_auxmin_loglikelihood</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">nmu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">npsi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ngamma</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ntrend_loc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">ntrend_sc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">ntrend_sh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function used for minimizing in the &#39;self._fit&#39; where the Negative loglikelihood of the GEV will be minimized</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            Parameter vector to optimize</span>
<span class="sd">        nmu : int, default=0</span>
<span class="sd">            Number of harmonics included in location</span>
<span class="sd">        npsi : int, default=0</span>
<span class="sd">            Number of harmonics included in scale</span>
<span class="sd">        ngamma : int, default=0</span>
<span class="sd">            Number of harmonics included in shape</span>
<span class="sd">        ntrend_loc : int, default=0</span>
<span class="sd">            Whether to include trends in location</span>
<span class="sd">        list_loc : list, default=[]</span>
<span class="sd">            List of covariates indices to include in location</span>
<span class="sd">        ntrend_sc : int, default=0</span>
<span class="sd">            Whether to include trends in scale</span>
<span class="sd">        list_sc : list, default=[]</span>
<span class="sd">            List of covariates indices to include in scale</span>
<span class="sd">        ntrend_sh : int, default=0</span>
<span class="sd">            Whether to include trends in shape</span>
<span class="sd">        list_sh : list, default=[]</span>
<span class="sd">            List of covariates indices to include in shape</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        f : float</span>
<span class="sd">            Negative loglikelihood value of the Non-stationary GEV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cheking the inputs</span>
        <span class="n">covariates_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Check consistency of the data</span>
        <span class="n">na1</span><span class="p">,</span> <span class="n">nind_loc</span> <span class="o">=</span> <span class="n">covariates_loc</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na2</span><span class="p">,</span> <span class="n">nind_sc</span> <span class="o">=</span> <span class="n">covariates_sc</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na3</span><span class="p">,</span> <span class="n">nind_sh</span> <span class="o">=</span> <span class="n">covariates_sh</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluate the location parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">])</span>  <span class="c1"># beta0, beta</span>
        <span class="k">elif</span> <span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                <span class="n">covariates_loc</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, beta_cov</span>
        <span class="k">elif</span> <span class="n">ntrend_loc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, betaT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                <span class="n">covariates_loc</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, betaT, beta_cov</span>

        <span class="c1"># Evaluate the scale parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha</span>
        <span class="k">elif</span> <span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alpha_cov</span>
        <span class="k">elif</span> <span class="n">ntrend_sc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alphaT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alphaT, alpha_cov</span>

        <span class="c1"># Evaluate the shape parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gamma_cov</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gammaT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gammaT, gamma_cov</span>
        <span class="c1"># If intercept in shape is not included</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma, gamma_cov</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma, gammaT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma, gammaT, gamma_cov</span>

        <span class="c1"># The values whose shape parameter is almost 0 correspond to the Gumbel distribution</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># The remaining values correspond to Weibull or Frechet</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># The corresponding Gumbel values are set to 1 to avoid numerical problems, note that in this case, the Gumbel expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Modify the parameters to include the length of the data</span>
        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include the length of the data in Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate auxiliarly variables</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>

        <span class="c1"># Since z-values must be greater than 0 in order to avoid numerical problems, their values are set to be greater than 1e-8</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>

        <span class="c1"># Evaluate the loglikelihood function with the sign changed, not that the general and Gumbel expressions are used</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">zn</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_auxmin_loglikelihood_grad</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">nmu</span><span class="p">,</span>
        <span class="n">npsi</span><span class="p">,</span>
        <span class="n">ngamma</span><span class="p">,</span>
        <span class="n">ntrend_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">ntrend_sc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">ntrend_sh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function used for minimizing in the &#39;self._optimize_parameters&#39; where the Negative loglikelihood of the GEV will be minimized</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            Parameter vector to optimize</span>
<span class="sd">        nmu : int, default=0</span>
<span class="sd">            Number of harmonics included in location</span>
<span class="sd">        npsi : int, default=0</span>
<span class="sd">            Number of harmonics included in scale</span>
<span class="sd">        ngamma : int, default=0</span>
<span class="sd">            Number of harmonics included in shape</span>
<span class="sd">        ntrend_loc : int, default=0</span>
<span class="sd">            Whether to include trends in location</span>
<span class="sd">        list_loc : list, default=[]</span>
<span class="sd">            List of covariates indices to include in location</span>
<span class="sd">        ntrend_sc : int, default=0</span>
<span class="sd">            Whether to include trends in scale</span>
<span class="sd">        list_sc : list, default=[]</span>
<span class="sd">            List of covariates indices to include in scale</span>
<span class="sd">        ntrend_sh : int, default=0</span>
<span class="sd">            Whether to include trends in shape</span>
<span class="sd">        list_sh : list, default=[]</span>
<span class="sd">            List of covariates indices to include in shape</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        Jx : np.ndarray</span>
<span class="sd">            Gradient of negative loglikelihood value of the Non-stationary GEV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cheking the inputs</span>
        <span class="n">covariates_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Check consistency of the data</span>
        <span class="n">na1</span><span class="p">,</span> <span class="n">nind_loc</span> <span class="o">=</span> <span class="n">covariates_loc</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na2</span><span class="p">,</span> <span class="n">nind_sc</span> <span class="o">=</span> <span class="n">covariates_sc</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na3</span><span class="p">,</span> <span class="n">nind_sh</span> <span class="o">=</span> <span class="n">covariates_sh</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluate the location parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">])</span>  <span class="c1"># beta0, beta</span>
        <span class="k">elif</span> <span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                <span class="n">covariates_loc</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, beta_cov</span>
        <span class="k">elif</span> <span class="n">ntrend_loc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, betaT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                <span class="n">covariates_loc</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, betaT, beta_cov</span>

        <span class="c1"># Evaluate the scale parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha</span>
        <span class="k">elif</span> <span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alpha_cov</span>
        <span class="k">elif</span> <span class="n">ntrend_sc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alphaT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alphaT, alpha_cov</span>

        <span class="c1"># Evaluate the shape parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gamma_cov</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gammaT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gammaT, gamma_cov</span>
        <span class="c1"># If intercept in shape is not included</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma, gamma_cov</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma, gammaT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma, gammaT, gamma_cov</span>

        <span class="c1"># The values whose shape parameter is almost 0 correspond to the Gumbel distribution</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to Weibull or Frechet</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># The corresponding Gumbel values are set to 1 to avoid numerical problems, note that in this case, the Gumbel expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Modify the parameters to include the length of the data</span>
        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include the length of the data in Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate auxiliarly variables</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>

        <span class="c1"># Since z-values must be greater than 0 in order to avoid numerical problems, their values are set to be greater than 1e-8</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>

        <span class="c1">### Gradient of the loglikelihood</span>
        <span class="c1"># Derivatives given by equations (A.1)-(A.3) in the paper</span>
        <span class="n">Dmut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">Dpsit</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="n">zn</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">Depst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Gumbel derivatives given by equations (A.4)-(A.5) in the paper</span>
        <span class="n">Dmut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="n">Dpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Depst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## New Derivatives</span>
        <span class="n">Dmutastmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span>
        <span class="n">Dmutastpsit</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
        <span class="n">Dmutastepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Dpsitastpsit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span>
        <span class="n">Dpsitastepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span>

        <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set the Jacobian to zero</span>
        <span class="n">Jx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
            <span class="o">+</span> <span class="n">nmu</span>
            <span class="o">+</span> <span class="n">npsi</span>
            <span class="o">+</span> <span class="n">ngamma</span>
            <span class="o">+</span> <span class="n">ntrend_loc</span>
            <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="o">+</span> <span class="n">ntrend_sc</span>
            <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="o">+</span> <span class="n">ntrend_sh</span>
            <span class="o">+</span> <span class="n">nind_sh</span>
        <span class="p">)</span>
        <span class="c1"># Jacobian elements related to the location parameters beta0 and beta, equation (A.6) in the paper</span>
        <span class="n">Jx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dmut</span><span class="p">,</span> <span class="n">Dmutastmut</span><span class="p">)</span>

        <span class="c1"># If location harmonics are included</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="c1"># Jacobian elements related to the location parameters betaT, beta_cov (equation A.9)</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">)</span>  <span class="c1"># betaT</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span>
                <span class="p">)</span>  <span class="c1"># beta_cov_i</span>

        <span class="c1"># Jacobian elements related to the scale parameters alpha0, alpha (equation A.7)</span>
        <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># alpha0</span>
        <span class="c1"># If scale harmonic are included</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>  <span class="c1"># alpha</span>
        <span class="c1"># Jacobian elements related to the scale parameters alphaT and beta_cov (equation A.10)</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit1</span>
            <span class="p">)</span>  <span class="c1"># alphaT</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">psit1</span>
                <span class="p">)</span>  <span class="c1"># alpha_cov</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma0 and gamma (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
            <span class="p">)</span>
        <span class="c1"># If shape harmonics are included</span>
        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">Depst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="c1"># Jacobian elements related to the shape parameter gamma (defined by Victor)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Depst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma_cov (defined by Victor)</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Depst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="c1"># Change the Jacobian sign since the numerical problem is a minimization problem</span>
        <span class="n">Jx</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jx</span>

        <span class="k">return</span> <span class="n">Jx</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_auxmin_loglikelihood_hess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">nmu</span><span class="p">,</span>
        <span class="n">npsi</span><span class="p">,</span>
        <span class="n">ngamma</span><span class="p">,</span>
        <span class="n">ntrend_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">ntrend_sc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">ntrend_sh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function used for minimizing in the &#39;self._optimize_parameters&#39; where the Negative loglikelihood of the GEV will be minimized</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            Parameter vector to optimize</span>
<span class="sd">        nmu : int, default=0</span>
<span class="sd">            Number of harmonics included in location</span>
<span class="sd">        npsi : int, default=0</span>
<span class="sd">            Number of harmonics included in scale</span>
<span class="sd">        ngamma : int, default=0</span>
<span class="sd">            Number of harmonics included in shape</span>
<span class="sd">        ntrend_loc : int, default=0</span>
<span class="sd">            Whether to include trends in location</span>
<span class="sd">        list_loc : list, default=[]</span>
<span class="sd">            List of covariates indices to include in location</span>
<span class="sd">        ntrend_sc : int, default=0</span>
<span class="sd">            Whether to include trends in scale</span>
<span class="sd">        list_sc : list, default=[]</span>
<span class="sd">            List of covariates indices to include in scale</span>
<span class="sd">        ntrend_sh : int, default=0</span>
<span class="sd">            Whether to include trends in shape</span>
<span class="sd">        list_sh : list, default=[]</span>
<span class="sd">            List of covariates indices to include in shape</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        Jx : np.ndarray</span>
<span class="sd">            Gradient of negative loglikelihood value of the Non-stationary GEV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cheking the inputs</span>
        <span class="n">covariates_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Check consistency of the data</span>
        <span class="n">na1</span><span class="p">,</span> <span class="n">nind_loc</span> <span class="o">=</span> <span class="n">covariates_loc</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na2</span><span class="p">,</span> <span class="n">nind_sc</span> <span class="o">=</span> <span class="n">covariates_sc</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na3</span><span class="p">,</span> <span class="n">nind_sh</span> <span class="o">=</span> <span class="n">covariates_sh</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion aux loglikelihood&quot;</span><span class="p">)</span>

        <span class="c1"># Evaluate the location parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">])</span>  <span class="c1"># beta0, beta</span>
        <span class="k">elif</span> <span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                <span class="n">covariates_loc</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, beta_cov</span>
        <span class="k">elif</span> <span class="n">ntrend_loc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, betaT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                <span class="n">covariates_loc</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># beta0, beta, betaT, beta_cov</span>

        <span class="c1"># Evaluate the scale parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha</span>
        <span class="k">elif</span> <span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alpha_cov</span>
        <span class="k">elif</span> <span class="n">ntrend_sc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alphaT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># alpha0, alpha, alphaT, alpha_cov</span>

        <span class="c1"># Evaluate the shape parameter at each time t as a function of the actual values of the parameters given by x</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gamma_cov</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gammaT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma0, gamma, gammaT, gamma_cov</span>
        <span class="c1"># If intercept in shape is not included</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma, gamma_cov</span>
            <span class="k">elif</span> <span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                <span class="p">)</span>  <span class="c1"># gamma, gammaT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">nind_sh</span>
                    <span class="p">],</span>
                    <span class="n">covariates_sh</span><span class="p">,</span>
                <span class="p">)</span>  <span class="c1"># gamma, gammaT, gamma_cov</span>

        <span class="c1"># The values whose shape parameter is almost 0 correspond to the Gumbel distribution</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to Weibull or Frechet</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># The corresponding Gumbel values are set to 1 to avoid numerical problems, note that in this case, the Gumbel expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Modify the parameters to include the length of the data</span>
        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include the length of the data in Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate auxiliarly variables</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>

        <span class="c1"># Since z-values must be greater than 0 in order to avoid numerical problems, their values are set to be greater than 1e-8</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>

        <span class="c1"># Evaluate the loglikelihood function, not that the general and Gumbel expressions are used</span>
        <span class="c1"># f = -np.sum(</span>
        <span class="c1">#     -np.log(self.kt[pos])</span>
        <span class="c1">#     + np.log(psit[pos])</span>
        <span class="c1">#     + (1 + 1 / epst[pos]) * np.log(z[pos])</span>
        <span class="c1">#     + self.kt[pos] * zn[pos]</span>
        <span class="c1"># ) - np.sum(</span>
        <span class="c1">#     -np.log(self.kt[posG])</span>
        <span class="c1">#     + np.log(psit[posG])</span>
        <span class="c1">#     + xn[posG]</span>
        <span class="c1">#     + self.kt[posG] * np.exp(-xn[posG])</span>
        <span class="c1"># )</span>

        <span class="c1">### Gradient of the loglikelihood</span>
        <span class="c1"># Derivatives given by equations (A.1)-(A.3) in the paper</span>
        <span class="n">Dmut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">Dpsit</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="n">zn</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">Depst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Gumbel derivatives given by equations (A.4)-(A.5) in the paper</span>
        <span class="n">Dmut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="n">Dpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Depst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## New Derivatives</span>
        <span class="n">Dmutastmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span>
        <span class="n">Dmutastpsit</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
        <span class="n">Dmutastepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Dpsitastpsit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span>
        <span class="n">Dpsitastepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span>

        <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set the Jacobian to zero</span>
        <span class="n">Jx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
            <span class="o">+</span> <span class="n">nmu</span>
            <span class="o">+</span> <span class="n">npsi</span>
            <span class="o">+</span> <span class="n">ngamma</span>
            <span class="o">+</span> <span class="n">ntrend_loc</span>
            <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="o">+</span> <span class="n">ntrend_sc</span>
            <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="o">+</span> <span class="n">ntrend_sh</span>
            <span class="o">+</span> <span class="n">nind_sh</span>
        <span class="p">)</span>
        <span class="c1"># Jacobian elements related to the location parameters beta0 and beta, equation (A.6) in the paper</span>
        <span class="n">Jx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dmut</span><span class="p">,</span> <span class="n">Dmutastmut</span><span class="p">)</span>

        <span class="c1"># If location harmonics are included</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="c1"># Jacobian elements related to the location parameters betaT, beta_cov (equation A.9)</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">)</span>  <span class="c1"># betaT</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span>
                <span class="p">)</span>  <span class="c1"># beta_cov_i</span>

        <span class="c1"># Jacobian elements related to the scale parameters alpha0, alpha (equation A.7)</span>
        <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># alpha0</span>
        <span class="c1"># If scale harmonic are included</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>  <span class="c1"># alpha</span>
        <span class="c1"># Jacobian elements related to the scale parameters alphaT and beta_cov (equation A.10)</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit1</span>
            <span class="p">)</span>  <span class="c1"># alphaT</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">psit1</span>
                <span class="p">)</span>  <span class="c1"># alpha_cov</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma0 and gamma (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
            <span class="p">)</span>
        <span class="c1"># If shape harmonics are included</span>
        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">Depst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="c1"># Jacobian elements related to the shape parameters trend (defined by Victor)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Depst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma_cov (defined by Victor)</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Depst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="c1">### Hessian matrix</span>
        <span class="c1"># Derivatives given by equations (A.13)-(A.17) in the paper</span>
        <span class="n">D2mut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">zn</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2psit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">zn</span> <span class="o">*</span> <span class="n">xn</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">xn</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xn</span><span class="p">)</span> <span class="o">-</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="n">xn</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2epst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">xn</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">epst</span><span class="p">)</span>
                    <span class="o">+</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">xn</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">((</span><span class="n">epst</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">Dmutpsit</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="p">)</span> <span class="o">*</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Dmutepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">xn</span> <span class="o">-</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="p">)</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">epst</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">Dpsitepst</span> <span class="o">=</span> <span class="n">xn</span> <span class="o">*</span> <span class="n">Dmutepst</span>

        <span class="c1"># Corresponding Gumbel derivatives given by equations (A.18)-(A.20)</span>
        <span class="n">D2mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Dmutepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Initialize the Hessian matrix</span>
        <span class="n">Hxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span><span class="p">,</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Elements of the Hessian matrix</span>
        <span class="c1"># Sub-blocks following the order shown in Table 4 of the paper</span>

        <span class="c1">## DIAGONAL SUB-BLOCKS</span>
        <span class="c1"># Sub-block number 1, beta0^2</span>
        <span class="n">Hxx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span><span class="p">)</span>
        <span class="c1"># Sub-block number 2, betaT^2</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Sub-block number 3, beta_cov_i*beta_cov_j</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="n">D2mut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="c1"># Sub-block number 4, alphaT^2</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Sub-block number 5, alpha_cov_i*alpha_cov_j</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit</span>
                        <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="c1"># Sub-block number 6, alpha0^2</span>
        <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span>
        <span class="p">)</span>
        <span class="c1"># Sub-block number 7, gamma0^2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If the shape parameter is added but later the result is GUMBEL</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posG</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span><span class="p">)</span>
        <span class="c1"># Sub-block added by Victor, gamma_cov_i*gamma_cov_j</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Add -1 if the model is GUMBEL in all the values</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posG</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
        <span class="c1"># Sub-block number , gammaT^2</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Sub-block number 8 (Scale exponential involved), beta0*alpha0</span>
        <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Sub-block number 9, beta0*gamma0</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Sub-block number 10 (Scale exponential involved), alpha0*gamma0</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 11, beta0*betaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number 12 (Scale exponential involved), beta0*alphaT</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span>
            <span class="p">)</span>
        <span class="c1"># Sub-block number 52 (Scale exponential involved), alphaT*alpha0</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 48 (Scale exponential involved), betaT*alphaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sub-block number, beta0*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># Sub-block number (Scale exponential involved), alpha0*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># Sub-block number, gamma0*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sub-block number, alphaT*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sub-block number, betaT*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Sub-block number 13, beta0*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Sub-block number 14 (Scale exponential involved), beta0*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 53 (Scale exponential involved), alpha0*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 49 (Scale exponential involved), betaT*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 15, betaT*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">D2mut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 16, alphaT*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number (Scale exponential involved), alpha_cov_i*gammaT</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number (Scale exponential involved), beta_cov_i*gammaT</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number, gamma_cov_i*gammaT</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Sub-block number 17, alpha0*betaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span>
            <span class="p">)</span>
        <span class="c1"># Sub-block number 18, gamma0*betaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number 19 (Scale exponential involved), gamma0*alphaT</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 20 (Scale exponential involved), alpha0*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 21, gamma0*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Sub-block number 22 (Scale exponential involved), gamma0*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block added by Victor, gamma0*gamma_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sub-block number 23, beta_i*beta0</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 24, beta_i,beta_j</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 25 (Scale exponential involved), beta_i*alpha0</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 26 (Scale exponential involved), beta_i*gamma0</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 27, betaT*beta_i</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), alphaT*beta_i</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), beta_i*gammaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 28, beta_i*beta_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 47 (Scale exponential involved), beta_i*alpha_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block added by Victor, beta_j*gamma_cov_i</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># Sub-block number 29 (Scale exponential involved), alpha_i*alpha_0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">nmu</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block 30 (Scale exponential involved), alpha_i*alpha_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 31 (Scale exponential involved), alpha_i*gamma0</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 32 (Scale exponential involved), beta0*alpha_i</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 33 (Scale exponential involved), alpha_i*betaT</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 34 (Scale exponential involved), alpha_i*beta_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block added by Victor (scale exponential involved), alpha_i*gamma_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), alpha_i*gammaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="c1"># First element associated to the constant value (first column)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2epst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sub-block number 35, gamma_i*gamma0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># If shape parameters included but later everything is GUMBEL</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">posG</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">):</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">D2epst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 36, gamma_i*gamma_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 37 (Scale exponential involved) gamma_i*alpha0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sub-block number 38, gamma_i*beta0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 39, gamma_i*betaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 44 (Scale exponential involved), gamma_i*alphaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2epst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), gamma_i*gammaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 40, gamma_i*beta_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 45 (Scale exponential involved), gamma_i*alpha_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block added by Victor, gamma_i*gamma_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 50 (Scale exponential involved), beta_cov_i*alphaT</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                    <span class="c1"># Sub-block number 51 (Scale exponential involved), beta_cov_i*alpha_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                    <span class="c1"># Sub-block added by Victor, beta_cov_i*gamma_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ntrend_sh</span>
                        <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                    <span class="c1"># Sub-block added by Victor (scale exponential involved), alpha_cov_i*gamma_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ntrend_sh</span>
                        <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="c1"># aux = 0</span>
                <span class="c1"># for k, tt in enumerate(self.t):</span>
                <span class="c1">#     aux += Dmutepst[k] * tt * covariates_sh[k, i]</span>
                <span class="c1"># Sub-block added by Victor, betaT*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="o">*</span> <span class="n">tt</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># Sub-block number 54 (Scale exponential involved), alpha_i*alphaT</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 55 (Scale exponential involved), alpha_i*alpha_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 41 (Scale exponential involved), beta_j*alpha_i</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 42, beta_j*gamma_i</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 43 (Scale exponential involved), alpha_j*gamma_i</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="c1"># Sub-block added by Victor, beta0*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="c1"># Sub-block added by Victor (scale exponential involved), alpha0*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

                <span class="c1"># aux = 0</span>
                <span class="c1"># for k, tt in enumerate(self.t):</span>
                <span class="c1">#     aux += Dpsitepst[k] * tt * covariates_sh[k, i] * psit[k]</span>
                <span class="c1"># Sub-bloc added by Victor (scale exponential involved), alphaT*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>

        <span class="c1"># Simmetric part of the Hessian</span>
        <span class="n">Hxx</span> <span class="o">=</span> <span class="n">Hxx</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">Hxx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Hxx</span> <span class="o">=</span> <span class="o">-</span><span class="n">Hxx</span>

        <span class="k">return</span> <span class="n">Hxx</span>

<div class="viewcode-block" id="NonStatGEV.fit">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nmu</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">npsi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ngamma</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ntrend_loc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">ntrend_sc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">ntrend_sh</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to determine the optimal parameters of Non-Stationary GEV for given covariates, trends and harmonics.</span>

<span class="sd">        By default the method fits a Non-Stationary GEV including trends in all the parameters, all possible covariates and no harmonics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nmu : int</span>
<span class="sd">            Number of harmonics to be included in the location parameter</span>
<span class="sd">        npsi : int</span>
<span class="sd">            Number of harmonics to be included in the scale parameter</span>
<span class="sd">        ngamma : int</span>
<span class="sd">            Number of harmonics to be included in the shape parameter</span>
<span class="sd">        ntrend_loc : int, default=1</span>
<span class="sd">            If trends in location are included.</span>
<span class="sd">        list_loc : list or str, default=&quot;all&quot;</span>
<span class="sd">            List of indices of covariates to be included in the location parameter.</span>
<span class="sd">            If None,no covariates are included in the location parameter.</span>
<span class="sd">        ntrend_sc : int, default=1</span>
<span class="sd">            If trends in scale are included.</span>
<span class="sd">        list_sc : list or str, default=&quot;all&quot;</span>
<span class="sd">            List of indices of covariates to be included in the scale parameter.</span>
<span class="sd">            If None,no covariates are included in the scale parameter.</span>
<span class="sd">        ntrend_sh : int, default=1</span>
<span class="sd">            If trends in shape are included.</span>
<span class="sd">        list_sh : list or str, default=&quot;all&quot;</span>
<span class="sd">            List of indices of covariates to be included in the shape parameter.</span>
<span class="sd">            If None,no covariates are included in the shape parameter.</span>
<span class="sd">        plot : bool, default=False</span>
<span class="sd">            If True, plot the diagnostic plots</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit_result : dict</span>
<span class="sd">            Dictionary with the optimal parameters and other information about the fit.</span>
<span class="sd">            The keys of the dictionary are:</span>
<span class="sd">            - beta0, beta, betaT, beta_cov: Location parameters (intercept, harmonic, trend, covariates)</span>
<span class="sd">            - alpha0, alpha, alphaT, alpha_cov: Scale parameters (intercept, harmonic, trend, covariates)</span>
<span class="sd">            - gamma0, gamma, gammaT, gamma_cov: Shape parameters (intercept, harmonic, trend, covariates)</span>
<span class="sd">            - negloglikelihood: Negative log-likelihood value at the optimal solution</span>
<span class="sd">            - hessian: Hessian matrix of the log-likelihood function at the optimal solution</span>
<span class="sd">            - invI0: Inverse of Fisher information matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fixed fit (.fit())&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_loc</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">list_loc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">list_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_loc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">list_sc</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">list_sc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">list_sc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_sc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">list_sh</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">list_sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">list_sh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_sh</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">=</span> <span class="n">nmu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">=</span> <span class="n">npsi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">=</span> <span class="n">ngamma</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span> <span class="o">=</span> <span class="n">list_loc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">=</span> <span class="n">ntrend_loc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span> <span class="o">=</span> <span class="n">list_sc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_sc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">=</span> <span class="n">ntrend_sc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span> <span class="o">=</span> <span class="n">list_sh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_sh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">=</span> <span class="n">ntrend_sh</span>

        <span class="n">fit_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
            <span class="n">nmu</span><span class="o">=</span><span class="n">nmu</span><span class="p">,</span>
            <span class="n">npsi</span><span class="o">=</span><span class="n">npsi</span><span class="p">,</span>
            <span class="n">ngamma</span><span class="o">=</span><span class="n">ngamma</span><span class="p">,</span>
            <span class="n">list_loc</span><span class="o">=</span><span class="n">list_loc</span><span class="p">,</span>
            <span class="n">ntrend_loc</span><span class="o">=</span><span class="n">ntrend_loc</span><span class="p">,</span>
            <span class="n">list_sc</span><span class="o">=</span><span class="n">list_sc</span><span class="p">,</span>
            <span class="n">ntrend_sc</span><span class="o">=</span><span class="n">ntrend_sc</span><span class="p">,</span>
            <span class="n">list_sh</span><span class="o">=</span><span class="n">list_sh</span><span class="p">,</span>
            <span class="n">ntrend_sh</span><span class="o">=</span><span class="n">ntrend_sh</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update parameters in the class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_params</span><span class="p">(</span><span class="o">**</span><span class="n">fit_result</span><span class="p">)</span>

        <span class="c1"># Compute the final loglikelihood and the information matrix</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">Jx</span><span class="p">,</span> <span class="n">Hxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">list_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">,</span>
            <span class="n">list_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">,</span>
            <span class="n">list_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;loglikelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;grad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jx</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;hessian&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hxx</span>

        <span class="c1"># if fit_result[&quot;hess_inv&quot;] is not None:</span>
        <span class="c1">#     self.invI0 = fit_result[&quot;hess_inv&quot;]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.invI0 = np.linalg.inv(-Hxx)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">Hxx</span><span class="p">)</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;invI0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span>

        <span class="n">std_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_params</span> <span class="o">=</span> <span class="n">std_params</span>
        <span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;std_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_params</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fit_result</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_AIC</span><span class="p">(</span><span class="n">loglike</span><span class="p">,</span> <span class="n">nparam</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the AIC for a certain loglikelihood value (loglik) and the number of parameters (np)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loglike : float</span>
<span class="sd">            Loglikelihood value</span>
<span class="sd">        nparam : int</span>
<span class="sd">            Number of parameters in the model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        aic : float</span>
<span class="sd">            AIC value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">loglike</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nparam</span>
        <span class="k">return</span> <span class="n">aic</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_loglikelihood</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">beta0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">betaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alphaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gammaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate the loglikelihood function, the Jacobian and the Hessian for a given parameterization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beta0 : float, default=None</span>
<span class="sd">            Optimal constant parameter related to location</span>
<span class="sd">        beta : np.ndarray, default=None</span>
<span class="sd">            Optimal harmonic vector associated with location</span>
<span class="sd">        betaT : float or np.ndarray, default=None</span>
<span class="sd">            Optimal location trend parameter</span>
<span class="sd">        beta_cov : np.ndarray, default=None</span>
<span class="sd">            Optimal location covariate vector</span>
<span class="sd">        alpha0 : float, default=None</span>
<span class="sd">            Optimal constant parameter related to scale</span>
<span class="sd">        alpha : np.ndarray, default=None</span>
<span class="sd">            Optimal harmonic vector associated with scale</span>
<span class="sd">        alphaT : float or np.ndarray, default=None</span>
<span class="sd">            Optimal scale trend parameter</span>
<span class="sd">        alpha_cov : np.ndarray, default=None</span>
<span class="sd">            Optimal scale covariate vector</span>
<span class="sd">        gamma0 : float, default=None</span>
<span class="sd">            Optimal constant parameter related to shape</span>
<span class="sd">        gamma : np.ndarray, default=None</span>
<span class="sd">            Optimal harmonic vector associated with shape</span>
<span class="sd">        gammaT : float or np.ndarray, default=None</span>
<span class="sd">            Optimal shape trend parameter</span>
<span class="sd">        gamma_cov : np.ndarray, default=None</span>
<span class="sd">            Optimal shape covariate vector</span>
<span class="sd">        list_loc : list, default=[]</span>
<span class="sd">            list of covariates included in the location parameter</span>
<span class="sd">        list_sc : list, default=[]</span>
<span class="sd">            list of covariates included in the scale parameter</span>
<span class="sd">        list_sh : list, default=[]</span>
<span class="sd">            list of covariates included in the shape parameter</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        f : np.ndarray</span>
<span class="sd">            Optimal loglikelihood function</span>
<span class="sd">        Jx : np.ndarray</span>
<span class="sd">            Gradient of the log-likelihood function at the optimal solution</span>
<span class="sd">        Hxx : np.ndarray</span>
<span class="sd">            Hessian of the log-likelihood function at the optimal solution</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Location</span>
        <span class="c1"># if beta0 is None:</span>
        <span class="c1">#     beta0 = np.empty(0)</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#     beta = np.empty(0)</span>
            <span class="n">nmu</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nmu</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">betaT</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">betaT</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># betaT = np.empty(0)</span>
            <span class="n">ntrend_loc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrend_loc</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Scale</span>
        <span class="c1"># if alpha0 is None:</span>
        <span class="c1">#     alpha0 = np.empty(0)</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#     alpha = np.empty(0)</span>
            <span class="n">npsi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npsi</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">alphaT</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alphaT</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># alphaT = np.empty(0)</span>
            <span class="n">ntrend_sc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrend_sc</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Shape</span>
        <span class="c1"># if gamma0 is None:</span>
        <span class="c1">#     gamma0 = np.empty(0)</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#     gamma = np.empty(0)</span>
            <span class="n">ngamma</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ngamma</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">gammaT</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gammaT</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># gammaT = np.empty(0)</span>
            <span class="n">ntrend_sh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrend_sh</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">beta_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alpha_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">list_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_loc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">list_sc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_sc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">list_sh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_sh</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">covariates_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">covariates_sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">na1</span><span class="p">,</span> <span class="n">nind_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">covariates_loc</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na2</span><span class="p">,</span> <span class="n">nind_sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">covariates_sc</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">na3</span><span class="p">,</span> <span class="n">nind_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">covariates_sh</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">na3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">na3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Check data x, t, indices: funcion loglikelihood&quot;</span><span class="p">)</span>

        <span class="n">nind_loc</span> <span class="o">=</span> <span class="n">beta_cov</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nind_sc</span> <span class="o">=</span> <span class="n">alpha_cov</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nind_sh</span> <span class="o">=</span> <span class="n">gamma_cov</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="n">covariates_loc</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="n">covariates_sc</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="n">covariates_sh</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost 0 correspond to the Gumbel distribution</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to Weibull or Frechet</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># The corresponding Gumbel values are set to 1 to avoid numerical problems, note that in this case, the Gumbel expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Modify the parameters to include the length of the data</span>
        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include the length of the data in Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate auxiliarly variables</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>

        <span class="c1"># Since z-values must be greater than 0 in order to avoid numerical problems, their values are set to be greater than 1e-8</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>

        <span class="c1"># Evaluate the loglikelihood function, not that the general and Gumbel expressions are used</span>
        <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">zn</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
            <span class="o">+</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1">### Gradient of the loglikelihood</span>
        <span class="c1"># Derivatives given by equations (A.1)-(A.3) in the paper</span>
        <span class="n">Dmut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">Dpsit</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="n">zn</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">Depst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Gumbel derivatives given by equations (A.4)-(A.5) in the paper</span>
        <span class="n">Dmut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="n">Dpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Depst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## New Derivatives</span>
        <span class="n">Dmutastmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span>
        <span class="n">Dmutastpsit</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
        <span class="n">Dmutastepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Dpsitastpsit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span>
        <span class="n">Dpsitastepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span>

        <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set the Jacobian to zero</span>
        <span class="n">Jx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
            <span class="o">+</span> <span class="n">nmu</span>
            <span class="o">+</span> <span class="n">npsi</span>
            <span class="o">+</span> <span class="n">ngamma</span>
            <span class="o">+</span> <span class="n">ntrend_loc</span>
            <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="o">+</span> <span class="n">ntrend_sc</span>
            <span class="o">+</span> <span class="n">nind_sc</span>
            <span class="o">+</span> <span class="n">ntrend_sh</span>
            <span class="o">+</span> <span class="n">nind_sh</span>
        <span class="p">)</span>
        <span class="c1"># Jacobian elements related to the location parameters beta0 and beta, equation (A.6) in the paper</span>
        <span class="n">Jx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dmut</span><span class="p">,</span> <span class="n">Dmutastmut</span><span class="p">)</span>

        <span class="c1"># If location harmonics are included</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="c1"># Jacobian elements related to the location parameters betaT, beta_cov (equation A.9)</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">)</span>  <span class="c1"># betaT</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span>
                <span class="p">)</span>  <span class="c1"># beta_cov_i</span>

        <span class="c1"># Jacobian elements related to the scale parameters alpha0, alpha (equation A.7)</span>
        <span class="n">Jx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># alpha0</span>
        <span class="c1"># If scale harmonic are included</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>  <span class="c1"># alpha</span>
        <span class="c1"># Jacobian elements related to the scale parameters alphaT and beta_cov (equation A.10)</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit1</span>
            <span class="p">)</span>  <span class="c1"># alphaT</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">psit1</span>
                <span class="p">)</span>  <span class="c1"># alpha_cov</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma0 and gamma (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
            <span class="p">)</span>
        <span class="c1"># If shape harmonics are included</span>
        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">Depst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Jx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="c1"># Jacobian elements related to the shape parameters trend (defined by Victor)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Jx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ngamma</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Depst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma_cov (defined by Victor)</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Jx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Depst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="c1">### Hessian matrix</span>
        <span class="c1"># Derivatives given by equations (A.13)-(A.17) in the paper</span>
        <span class="n">D2mut</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">zn</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2psit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">zn</span> <span class="o">*</span> <span class="n">xn</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">xn</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xn</span><span class="p">)</span> <span class="o">-</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="n">xn</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2epst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">xn</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">epst</span><span class="p">)</span>
                    <span class="o">+</span> <span class="mi">2</span>
                    <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">xn</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">2</span> <span class="o">*</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">xn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">((</span><span class="n">epst</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">Dmutpsit</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="p">)</span> <span class="o">*</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Dmutepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">zn</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="n">xn</span> <span class="o">-</span> <span class="n">epst</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="p">)</span> <span class="o">/</span> <span class="n">zn</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">psit</span> <span class="o">*</span> <span class="n">epst</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">Dpsitepst</span> <span class="o">=</span> <span class="n">xn</span> <span class="o">*</span> <span class="n">Dmutepst</span>

        <span class="c1"># Corresponding Gumbel derivatives given by equations (A.18)-(A.20)</span>
        <span class="n">D2mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">*</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">D2epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Dmutepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Initialize the Hessian matrix</span>
        <span class="n">Hxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span><span class="p">,</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span>
                <span class="o">+</span> <span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="n">nind_sh</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Elements of the Hessian matrix</span>
        <span class="c1"># Sub-blocks following the order shown in Table 4 of the paper</span>

        <span class="c1">## DIAGONAL SUB-BLOCKS</span>
        <span class="c1"># Sub-block number 1, beta0^2</span>
        <span class="n">Hxx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span><span class="p">)</span>
        <span class="c1"># Sub-block number 2, betaT^2</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Sub-block number 3, beta_cov_i*beta_cov_j</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="n">D2mut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="c1"># Sub-block number 4, alphaT^2</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Sub-block number 5, alpha_cov_i*alpha_cov_j</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit</span>
                        <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="c1"># Sub-block number 6, alpha0^2</span>
        <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span>
        <span class="p">)</span>
        <span class="c1"># Sub-block number 7, gamma0^2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If the shape parameter is added but later the result is GUMBEL</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posG</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span><span class="p">)</span>
        <span class="c1"># Sub-block added by Victor, gamma_cov_i*gamma_cov_j</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Add -1 if the model is GUMBEL in all the values</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posG</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
        <span class="c1"># Sub-block number , gammaT^2</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Sub-block number 8 (Scale exponential involved), beta0*alpha0</span>
        <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Sub-block number 9, beta0*gamma0</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Sub-block number 10 (Scale exponential involved), alpha0*gamma0</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 11, beta0*betaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number 12 (Scale exponential involved), beta0*alphaT</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span>
            <span class="p">)</span>
        <span class="c1"># Sub-block number 52 (Scale exponential involved), alphaT*alpha0</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 48 (Scale exponential involved), betaT*alphaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sub-block number, beta0*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># Sub-block number (Scale exponential involved), alpha0*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># Sub-block number, gamma0*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sub-block number, betaT*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sub-block number, alphaT*gammaT</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="n">nmu</span>
                <span class="o">+</span> <span class="n">npsi</span>
                <span class="o">+</span> <span class="n">ngamma</span>
                <span class="o">+</span> <span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="n">nind_loc</span>
                <span class="o">+</span> <span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 13, beta0*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2mut</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Sub-block number 14 (Scale exponential involved), beta0*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 53 (Scale exponential involved), alpha0*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 49 (Scale exponential involved), betaT*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 15, betaT*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">D2mut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 16, alphaT*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">D2psit</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number (Scale exponential involved), alpha_cov_i*gammaT</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number (Scale exponential involved), beta_cov_i*gammaT</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number, gamma_cov_i*gammaT</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Sub-block number 17, alpha0*betaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span>
            <span class="p">)</span>
        <span class="c1"># Sub-block number 18, gamma0*betaT</span>
        <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="c1"># Sub-block number 19 (Scale exponential involved), gamma0*alphaT</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Hxx</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block number 20 (Scale exponential involved), alpha0*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                <span class="p">)</span>
        <span class="c1"># Sub-block number 21, gamma0*beta_cov_i</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="c1"># Sub-block number 22 (Scale exponential involved), gamma0*alpha_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>
        <span class="c1"># Sub-block added by Victor, gamma0*gamma_cov_i</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D2epst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sub-block number 23, beta_i*beta0</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 24, beta_i,beta_j</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 25 (Scale exponential involved), beta_i*alpha0</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 26 (Scale exponential involved), beta_i*gamma0</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 27, betaT*beta_i</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), alphaT*beta_i</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), beta_i*gammaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

            <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">D2mut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 28, beta_i*beta_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 47 (Scale exponential involved), beta_i*alpha_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block added by Victor, beta_j*gamma_cov_i</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># Sub-block number 29 (Scale exponential involved), alpha_i*alpha_0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">nmu</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block 30 (Scale exponential involved), alpha_i*alpha_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 31 (Scale exponential involved), alpha_i*gamma0</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 32 (Scale exponential involved), beta0*alpha_i</span>
                <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 33 (Scale exponential involved), alpha_i*betaT</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 34 (Scale exponential involved), alpha_i*beta_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block added by Victor (scale exponential involved), alpha_i*gamma_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), alpha_i*gammaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="c1"># First element associated to the constant value (first column)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2epst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sub-block number 35, gamma_i*gamma0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># If shape parameters included but later everything is GUMBEL</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">posG</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">):</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">D2epst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 36, gamma_i*gamma_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 37 (Scale exponential involved) gamma_i*alpha0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Sub-block number 38, gamma_i*beta0</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 39, gamma_i*betaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="c1"># Sub-block number 44 (Scale exponential involved), gamma_i*alphaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="n">D2epst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Sub-block number 46 (Scale exponential involved), gamma_i*gammaT</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 40, gamma_i*beta_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block number 45 (Scale exponential involved), gamma_i*alpha_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                            <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
            <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="c1"># Sub-block added by Victor, gamma_i*gamma_cov_j</span>
                        <span class="n">Hxx</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ngamma</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="n">nmu</span>
                            <span class="o">+</span> <span class="n">npsi</span>
                            <span class="o">+</span> <span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># Sub-block number 50 (Scale exponential involved), beta_cov_i*alphaT</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                    <span class="c1"># Sub-block number 51 (Scale exponential involved), beta_cov_i*alpha_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="n">Dmutpsit</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                    <span class="c1"># Sub-block added by Victor, beta_cov_i*gamma_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ntrend_sh</span>
                        <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                    <span class="c1"># Sub-block added by Victor (scale exponential involved), alpha_cov_i*gamma_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ngamma</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">ntrend_sh</span>
                        <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                        <span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="c1"># aux = 0</span>
                <span class="c1"># for k, tt in enumerate(self.t):</span>
                <span class="c1">#     aux += Dmutepst[k] * tt * covariates_sh[k, i]</span>
                <span class="c1"># Sub-block added by Victor, betaT*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="o">*</span> <span class="n">tt</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># Sub-block number 54 (Scale exponential involved), alpha_i*alphaT</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span><span class="p">,</span>
                    <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sc</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">D2psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">covariates_sc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 55 (Scale exponential involved), alpha_i*alpha_cov_j</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">Dmutpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 41 (Scale exponential involved), beta_j*alpha_i</span>
                    <span class="n">Hxx</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">Dmutepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 42, beta_j*gamma_i</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>
        <span class="k">if</span> <span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngamma</span><span class="p">):</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                        <span class="n">aux</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">Dpsitepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Sub-block number 43 (Scale exponential involved), alpha_j*gamma_i</span>
                    <span class="n">Hxx</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="n">nmu</span>
                        <span class="o">+</span> <span class="n">npsi</span>
                        <span class="o">+</span> <span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">aux</span>

        <span class="k">if</span> <span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="c1"># Sub-block added by Victor, beta0*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dmutepst</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="c1"># Sub-block added by Victor (scale exponential involved), alpha0*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="n">psit</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

                <span class="c1"># aux = 0</span>
                <span class="c1"># for k, tt in enumerate(self.t):</span>
                <span class="c1">#     aux += Dpsitepst[k] * tt * covariates_sh[k, i] * psit[k]</span>
                <span class="c1"># Sub-bloc added by Victor (scale exponential involved), alphaT*gamma_cov_i</span>
                <span class="n">Hxx</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="n">nmu</span>
                    <span class="o">+</span> <span class="n">npsi</span>
                    <span class="o">+</span> <span class="n">ngamma</span>
                    <span class="o">+</span> <span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="n">nmu</span> <span class="o">+</span> <span class="n">npsi</span> <span class="o">+</span> <span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">nind_loc</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dpsitepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">covariates_sh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">)</span>

        <span class="c1"># Simmetric part of the Hessian</span>
        <span class="n">Hxx</span> <span class="o">=</span> <span class="n">Hxx</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">Hxx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">Jx</span><span class="p">,</span> <span class="n">Hxx</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updating the parameters of the class with the given keyword arguments.</span>
<span class="sd">        Used in the fitting process to update based on fit_result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Dictionary containing the parameters to update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;beta0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">betaT</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;betaT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;beta_cov&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alphaT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha_cov&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># self.ngamma0 = kwargs.get(&quot;ngamma0&quot;, 0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gammaT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma_cov&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xopt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parametro</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">beta0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">betaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">indicesint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">times</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">betaT</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">betaT</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">betaT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ntend</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntend</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">beta_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">indicesint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indicesint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametro</span><span class="p">(</span>
            <span class="n">beta0</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">betaT</span><span class="p">,</span> <span class="n">beta_cov</span><span class="p">,</span> <span class="n">covariates</span><span class="p">,</span> <span class="n">indicesint</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ntend</span>
        <span class="p">)</span>

<div class="viewcode-block" id="NonStatGEV.parametro">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.parametro">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parametro</span><span class="p">(</span>
        <span class="n">beta0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">betaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">indicesint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">times</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ntend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function computes the location, scale and shape parameters for given parameters. Expressions by (2)-(3) in the paper</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beta0 : float, optional</span>
<span class="sd">            Value of the intercept</span>
<span class="sd">        beta : np.ndarray, optional</span>
<span class="sd">            Value of the harmonics terms</span>
<span class="sd">        betaT : float, optional</span>
<span class="sd">            Trend parameter</span>
<span class="sd">        beta_cov : np.ndarray, optional</span>
<span class="sd">            Covariate parameters</span>
<span class="sd">        covariates : np.ndarray, optional</span>
<span class="sd">            Covariate matrix, where each column corresponds to a covariate and each row to a time point</span>
<span class="sd">        indicesint : np.ndarray, optional</span>
<span class="sd">            Covariate mean values in the integral interval</span>
<span class="sd">        times : np.ndarray, optional</span>
<span class="sd">            Times when covariates are known, used to find the nearest value</span>
<span class="sd">        t : np.ndarray, optional</span>
<span class="sd">            Specific time point to evaluate the parameters at, if None, uses the times given</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Values of the parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">na</span><span class="p">,</span> <span class="n">nind</span> <span class="o">=</span> <span class="n">covariates</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nparam</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># Chek if the number of parameters is even</span>
        <span class="k">if</span> <span class="n">nparam</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter number must be even&quot;</span><span class="p">)</span>

        <span class="c1"># Adding the intercept term</span>
        <span class="k">if</span> <span class="n">beta0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">beta0</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">beta0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># Adding the harmonic part</span>
        <span class="k">if</span> <span class="n">nparam</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">nparam</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">y</span>
                    <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Adding the tendency part</span>
        <span class="k">if</span> <span class="n">ntend</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">betaT</span> <span class="o">*</span> <span class="n">x</span>

        <span class="c1"># Adding the covariate part</span>
        <span class="k">if</span> <span class="n">nind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indicesint</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">times</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># for i in prange(nind):</span>
                    <span class="c1">#     y = y + beta_cov[i] * indicesint[i]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">indicesint</span> <span class="o">@</span> <span class="n">beta_cov</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># for i in prange(nind):</span>
                    <span class="c1">#     indicesintaux = search(</span>
                    <span class="c1">#         times, covariates[:, i], x.flatten()</span>
                    <span class="c1">#     )</span>
                    <span class="c1">#     y = y + beta_cov[i] * indicesintaux</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">.</span><span class="n">size</span>

                    <span class="n">y_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
                        <span class="c1"># pick rows from covariates and do one matvec</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="p">:]</span>  <span class="c1"># (k, nind)</span>
                        <span class="n">y_add</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">beta_cov</span>  <span class="c1"># (k,)</span>

                    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">y_add</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for i in prange(nind):</span>
                <span class="c1">#     y = y + beta_cov[i] * covariates[:, i]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">covariates</span> <span class="o">@</span> <span class="n">beta_cov</span>

        <span class="k">return</span> <span class="n">y</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">beta0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">betaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alphaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gammaT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma_cov</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">covariates_loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">covariates_sc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">covariates_sh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to evaluate the parameters in the corresponding values</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beta0 : float, optional</span>
<span class="sd">            Intercept for location parameter</span>
<span class="sd">        beta : np.ndarray, optional</span>
<span class="sd">            Harmonic coefficients for location parameter</span>
<span class="sd">        betaT : float, optional</span>
<span class="sd">            Trend parameter for location parameter</span>
<span class="sd">        beta_cov : np.ndarray, optional</span>
<span class="sd">            Covariate coefficients for location parameter</span>
<span class="sd">        alpha0 : float, optional</span>
<span class="sd">            Intercept for scale parameter</span>
<span class="sd">        alpha : np.ndarray, optional</span>
<span class="sd">            Harmonic coefficients for scale parameter</span>
<span class="sd">        alphaT : float, optional</span>
<span class="sd">            Trend parameter for scale parameter</span>
<span class="sd">        alpha_cov : np.ndarray, optional</span>
<span class="sd">            Covariate coefficients for scale parameter</span>
<span class="sd">        gamma0 : float, optional</span>
<span class="sd">            Intercept for shape parameter</span>
<span class="sd">        gamma : np.ndarray, optional</span>
<span class="sd">            Harmonic coefficients for shape parameter</span>
<span class="sd">        gammaT : float, optional</span>
<span class="sd">            Trend parameter for shape parameter</span>
<span class="sd">        gamma_cov : np.ndarray, optional</span>
<span class="sd">            Covariate coefficients for shape parameter</span>
<span class="sd">        covariates_loc : np.ndarray, optional</span>
<span class="sd">            Covariates for location parameter</span>
<span class="sd">        covariates_sc : np.ndarray, optional</span>
<span class="sd">            Covariates for scale parameter</span>
<span class="sd">        covariates_sh : np.ndarray, optional</span>
<span class="sd">            Covariates for shape parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Evaluate the location parameter at each time t as function of the actual values of the parameters given by p</span>
        <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span><span class="n">beta0</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">betaT</span><span class="p">,</span> <span class="n">beta_cov</span><span class="p">,</span> <span class="n">covariates_loc</span><span class="p">)</span>
        <span class="c1"># Evaluate the scale parameter at each time t as function of the actual values of the parameters given by p</span>
        <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span><span class="n">alpha0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alphaT</span><span class="p">,</span> <span class="n">alpha_cov</span><span class="p">,</span> <span class="n">covariates_sc</span><span class="p">))</span>
        <span class="c1"># Evaluate the shape parameter at each time t as function of the actual values of the parameters given by p</span>
        <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span><span class="n">gamma0</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gammaT</span><span class="p">,</span> <span class="n">gamma_cov</span><span class="p">,</span> <span class="n">covariates_sh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derivative of the location, scale and shape fucntions with respect to harmonic parameters. It corresponds to the rhs in equation (A.11) of the paper</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t : float or np.ndarray</span>
<span class="sd">            Time in yearly scale</span>
<span class="sd">        i : int</span>
<span class="sd">            Harmonic index</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dp : float or np.ndarray</span>
<span class="sd">            Corresponding derivative</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_quantile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">harm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the quantile q associated with a given parameterization, the main input is quanval introduced in __init__ (default 0.95)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        harm : bool, default=False</span>
<span class="sd">            If True, the quantile is calculated for the harmonic parameters only, otherwise it includes the trend and covariates parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Q : np.ndarray</span>
<span class="sd">            Quantile values at each time t</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">harm</span><span class="p">:</span>
            <span class="n">betaT</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">alphaT</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gammaT</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cov_loc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">beta_cov</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cov_sc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">alpha_cov</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cov_sh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gamma_cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">betaT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betaT</span>
            <span class="n">alphaT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span>
            <span class="n">gammaT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span>
            <span class="n">cov_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">beta_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span>
            <span class="n">cov_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">alpha_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span>
            <span class="n">cov_sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">gamma_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span>

        <span class="k">if</span> <span class="n">prob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span>

        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">))</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="n">cov_loc</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="n">cov_sc</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="n">cov_sh</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate the quantile</span>
        <span class="n">Q</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
            <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span>
            <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Q</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">-</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">Q</span>

<div class="viewcode-block" id="NonStatGEV.plot">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">init_year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the location, scale and shape parameters, also the PP plot and QQ plot</span>

<span class="sd">        Return period plot is plotted if and only if no covariates and trends are included</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        return_plot : bool, default=True</span>
<span class="sd">            If True, return period plot is plotted</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            If True, save all the figures in a &quot;Figures/&quot;</span>
<span class="sd">        init_year : int, default=0</span>
<span class="sd">            Initial year for plotting purposes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Parameter Evaluation</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Confidence intervals (TODO: AÃADIR EN OTRA FUNCION QUIZAS)</span>
        <span class="n">Dq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DQuantile</span><span class="p">()</span>
        <span class="n">Dermut</span><span class="p">,</span> <span class="n">Derpsit</span><span class="p">,</span> <span class="n">Derepst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dmupsiepst</span><span class="p">()</span>

        <span class="n">stdmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">Dermut</span><span class="o">.</span><span class="n">T</span>
<div class="viewcode-block" id="NonStatGEV.paramplot">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.paramplot">[docs]</a>
                    <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">[</span>
                        <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">,</span>
                        <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="n">Dermut</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stdpsit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">Derpsit</span><span class="o">.</span><span class="n">T</span>
                    <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">[</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">,</span>
                        <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="p">:</span> <span class="mi">2</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="n">Derpsit</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stdepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">Derepst</span><span class="o">.</span><span class="n">T</span>
                        <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">[</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">,</span>
                            <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="p">:</span> <span class="mi">2</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="n">Derepst</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stdepst</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">stdDq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Dq</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dq</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Confidence interval for mut</span>
        <span class="n">ci_up_mut</span> <span class="o">=</span> <span class="n">mut</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stdmut</span>
        <span class="n">ci_low_mut</span> <span class="o">=</span> <span class="n">mut</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stdmut</span>
        <span class="n">ci_up_psit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stdpsit</span>
        <span class="p">)</span>
        <span class="n">ci_low_psit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stdpsit</span>
        <span class="p">)</span>

        <span class="c1"># Location and Scale parameter plotting</span>
        <span class="n">t_anual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">quan95</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantile</span><span class="p">()</span>
        <span class="n">rp10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">rp100</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

            <span class="c1">#############</span>
            <span class="n">month_initials</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">month_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span>

            <span class="c1"># Reorder the return periods to start from July</span>
            <span class="n">rt_10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">rt_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">rt_100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                <span class="c1"># Map i to the correct month index (July = 0, June = 11)</span>
                <span class="n">month_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span>
                <span class="n">rt_10</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">month_idx</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">month_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
                <span class="p">)</span>
                <span class="n">rt_50</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span> <span class="n">month_idx</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">month_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
                <span class="p">)</span>
                <span class="n">rt_100</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">month_idx</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">month_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
                <span class="p">)</span>

            <span class="n">rt_10</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt_10</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rt_50</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt_50</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rt_100</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt_100</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># For the data points, shift the time values by 0.5 years</span>
            <span class="n">t_shifted</span> <span class="o">=</span> <span class="n">t_anual</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">t_shifted</span><span class="p">[</span><span class="n">t_anual</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span>
            <span class="n">t_shifted</span><span class="p">[</span><span class="n">t_anual</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span>
            <span class="n">t_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">)</span>

            <span class="c1">### Added by Tomas Carlotto</span>
            <span class="c1"># Creating variables to store the evolution of pdf and sf over time</span>
            <span class="n">var_grid_resolution</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="c1"># t_anual_ord = t_anual[t_ord]</span>
            <span class="n">mu_t</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
            <span class="n">psi_t</span> <span class="o">=</span> <span class="n">psit</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
            <span class="n">xi_t</span> <span class="o">=</span> <span class="n">epst</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
            <span class="c1"># Definition of the Hs value grid</span>
            <span class="n">lim_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">lim_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span>
            <span class="n">hvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lim_min</span><span class="p">,</span> <span class="n">lim_max</span><span class="p">,</span> <span class="n">var_grid_resolution</span><span class="p">)</span>
            <span class="n">t_grid</span><span class="p">,</span> <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span> <span class="n">hvar</span><span class="p">)</span>

            <span class="c1"># Calculating the 1-CDF for each grid point (Exceedance Probabilities)</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">genextreme</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=-</span><span class="n">xi_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">psi_t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]))</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># Calculating the Probability Density Function (pdf) for each grid point</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">genextreme</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span>
                        <span class="n">x_grid</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=-</span><span class="n">xi_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">psi_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]))</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">cf</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span> <span class="n">hvar</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Wistia&quot;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Exceedance probability&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="c1"># ===============</span>

            <span class="c1"># Use t_shifted for plotting data points</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Use t_shifted for other lines as well</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">mut</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">mut</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span> <span class="o">-</span> <span class="n">psit</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">mut</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Location $\pm$ Scale&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">month_positions_aux</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">)]</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                <span class="n">month_positions_aux</span><span class="p">,</span>
                <span class="n">rt_10</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;10 years&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                <span class="n">month_positions_aux</span><span class="p">,</span>
                <span class="n">rt_50</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;50 years&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                <span class="n">month_positions_aux</span><span class="p">,</span>
                <span class="n">rt_100</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;100 years&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameters Evolution (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (Months)&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_positions</span><span class="p">,</span> <span class="n">month_initials</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Figures/Adjustment_Evolution_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span>
                <span class="n">mut</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="c1"># color=self.colors[0],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span>
                <span class="n">mut</span> <span class="o">-</span> <span class="n">psit</span><span class="p">,</span>
                <span class="n">mut</span> <span class="o">+</span> <span class="n">psit</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Location $\pm$ Scale&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># ax1.plot(</span>
            <span class="c1">#     self.t + init_year,</span>
            <span class="c1">#     rp10,</span>
            <span class="c1">#     label=&quot;10 years&quot;,</span>
            <span class="c1">#     linewidth=1,</span>
            <span class="c1">#     color=&quot;tab:red&quot;,</span>
            <span class="c1">#     linestyle=&quot;--&quot;,</span>
            <span class="c1">#     alpha=0.9,</span>
            <span class="c1"># )</span>

            <span class="c1"># ax1.plot(</span>
            <span class="c1">#     self.t + init_year,</span>
            <span class="c1">#     rp100,</span>
            <span class="c1">#     label=&quot;100 years&quot;,</span>
            <span class="c1">#     linewidth=1,</span>
            <span class="c1">#     color=&quot;tab:green&quot;,</span>
            <span class="c1">#     linestyle=&quot;--&quot;,</span>
            <span class="c1">#     alpha=0.9,</span>
            <span class="c1"># )</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span>
                <span class="n">epst</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Shape&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Aggregated return period lines</span>
            <span class="k">if</span> <span class="n">return_plot</span><span class="p">:</span>
                <span class="n">n_years</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">rt_10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_years</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_years</span><span class="p">):</span>
                    <span class="n">rt_10</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>  <span class="c1"># 10-year return level at each year</span>
                <span class="n">rt_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_years</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_years</span><span class="p">):</span>
                    <span class="n">rt_50</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>  <span class="c1"># 50-year return level at each year</span>
                <span class="n">rt_100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_years</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_years</span><span class="p">):</span>
                    <span class="n">rt_100</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>  <span class="c1"># 100-year return level at each year</span>

                <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">init_year</span><span class="p">,</span> <span class="n">init_year</span> <span class="o">+</span> <span class="n">n_years</span><span class="p">),</span>
                    <span class="n">rt_10</span><span class="p">,</span>
                    <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;10 years&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">init_year</span><span class="p">,</span> <span class="n">init_year</span> <span class="o">+</span> <span class="n">n_years</span><span class="p">),</span>
                    <span class="n">rt_50</span><span class="p">,</span>
                    <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;50 years&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">init_year</span><span class="p">,</span> <span class="n">init_year</span> <span class="o">+</span> <span class="n">n_years</span><span class="p">),</span>
                    <span class="n">rt_100</span><span class="p">,</span>
                    <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;100 years&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (years)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># ax1.set_title(f&quot;Evolution of location and scale parameters ({self.var_name})&quot;)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evolution of parameters (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="c1"># ax2.set_ylim(0,1.5)</span>
        <span class="c1"># ax1.set_xlim(-0.07, 40)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;Figures&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># plt.savefig(f&quot;Figures/Location_Scale_Parameters_{self.var_name}.png&quot;, dpi=300)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/Adjustment_Evolution_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1">###### 1st Year PLOT</span>
        <span class="n">month_initials</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;May&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">month_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span>

        <span class="c1">#### Creating the first year plot</span>
        <span class="n">mask_year</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span>
            <span class="n">mut</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\mu_t$&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">uppermaxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">mut</span><span class="p">[</span><span class="n">mask_year</span><span class="p">]</span> <span class="o">-</span> <span class="n">psit</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span> <span class="n">mut</span><span class="p">[</span><span class="n">mask_year</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">mask_year</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">lowermins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">mut</span><span class="p">[</span><span class="n">mask_year</span><span class="p">]</span> <span class="o">-</span> <span class="n">psit</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span> <span class="n">mut</span><span class="p">[</span><span class="n">mask_year</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit</span><span class="p">[</span><span class="n">mask_year</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span> <span class="n">lowermins</span><span class="p">,</span> <span class="n">uppermaxs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span>
            <span class="n">quan95</span><span class="p">[</span><span class="n">mask_year</span><span class="p">],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;95th Quantile&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Location and Scale Parameters (First Year) (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_t$&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">month_positions</span><span class="p">,</span> <span class="n">month_initials</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Figures/Location_Scale_Parameters_FirstYear_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1">### FIRST MONTH PLOT Creating the first monthly plot if not monthly or annual data</span>
        <span class="c1"># mask_month = (self.t &gt;= 0) &amp; (self.t &lt;= 1 / 12)</span>
        <span class="c1"># if sum(mask_month) &gt; 1:</span>
        <span class="c1">#     fig, ax1 = plt.subplots(figsize=(10, 6))</span>
        <span class="c1">#     ax1.plot(</span>
        <span class="c1">#         self.t[mask_month],</span>
        <span class="c1">#         self.xt[mask_month],</span>
        <span class="c1">#         marker=&quot;+&quot;,</span>
        <span class="c1">#         linestyle=&quot;None&quot;,</span>
        <span class="c1">#         color=&quot;black&quot;,</span>
        <span class="c1">#         markersize=5,</span>
        <span class="c1">#         label=f&quot;{self.var_name}&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     # ax2 = ax1.twinx()</span>
        <span class="c1">#     ax1.plot(</span>
        <span class="c1">#         self.t[mask_month],</span>
        <span class="c1">#         mut[mask_month],</span>
        <span class="c1">#         label=r&quot;$\mu_t$&quot;,</span>
        <span class="c1">#         linewidth=2,</span>
        <span class="c1">#         color=self.colors[0],</span>
        <span class="c1">#         alpha=1,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     uppermaxs = np.maximum(</span>
        <span class="c1">#         mut[mask_month] - psit[mask_month], mut[mask_month] + psit[mask_month]</span>
        <span class="c1">#     )</span>
        <span class="c1">#     lowermins = np.minimum(</span>
        <span class="c1">#         mut[mask_month] - psit[mask_month], mut[mask_month] + psit[mask_month]</span>
        <span class="c1">#     )</span>
        <span class="c1">#     ax1.fill_between(</span>
        <span class="c1">#         self.t[mask_month],</span>
        <span class="c1">#         lowermins,</span>
        <span class="c1">#         uppermaxs,</span>
        <span class="c1">#         color=self.colors[0],</span>
        <span class="c1">#         alpha=0.3,</span>
        <span class="c1">#         label=&quot;Location +- scale&quot;,</span>
        <span class="c1">#     )</span>

        <span class="c1">#     # ax1.plot(</span>
        <span class="c1">#     #     self.t[mask_month],</span>
        <span class="c1">#     #     rt_10[mask_month],</span>
        <span class="c1">#     #     linestyle=&quot;dashed&quot;,</span>
        <span class="c1">#     #     color=self.colors[2],</span>
        <span class="c1">#     #     label=&quot;10 years&quot;,</span>
        <span class="c1">#     # )</span>
        <span class="c1">#     # ax1.plot(</span>
        <span class="c1">#     #     self.t[mask_month],</span>
        <span class="c1">#     #     rt_50[mask_month],</span>
        <span class="c1">#     #     linestyle=&quot;dashed&quot;,</span>
        <span class="c1">#     #     color=self.colors[2],</span>
        <span class="c1">#     #     label=&quot;50 years&quot;,</span>
        <span class="c1">#     # )</span>
        <span class="c1">#     # ax1.plot(</span>
        <span class="c1">#     #     self.t[mask_month],</span>
        <span class="c1">#     #     rt_100[mask_month],</span>
        <span class="c1">#     #     linestyle=&quot;dashed&quot;,</span>
        <span class="c1">#     #     color=self.colors[2],</span>
        <span class="c1">#     #     label=&quot;100 years&quot;,</span>
        <span class="c1">#     # )</span>
        <span class="c1">#     ax1.set_title(</span>
        <span class="c1">#         f&quot;Location and Scale Parameters (First Month) ({self.var_name})&quot;</span>
        <span class="c1">#     )</span>
        <span class="c1">#     ax1.set_xlabel(&quot;Time (yearly scale)&quot;)</span>
        <span class="c1">#     ax1.set_ylabel(r&quot;$\mu_t$&quot;)</span>
        <span class="c1">#     # ax2.set_ylabel(r&#39;$\psi_t$&#39;)</span>
        <span class="c1">#     ax1.grid(True)</span>
        <span class="c1">#     # handles = [art for art in l0 + l1 + l2 + l3 if not art.get_label().startswith(&#39;_&#39;)]</span>
        <span class="c1">#     ax1.legend(loc=&quot;best&quot;)</span>
        <span class="c1">#     ax1.margins(x=0.01)</span>
        <span class="c1">#     if save:</span>
        <span class="c1">#         plt.savefig(</span>
        <span class="c1">#             f&quot;Figures/Evolution_Location_FirstYear{self.var_name}.png&quot;, dpi=300</span>
        <span class="c1">#         )</span>
        <span class="c1">#     plt.show()</span>

        <span class="c1">#### Shape parameter plot</span>
        <span class="c1"># Confidence interval for epst</span>
        <span class="c1"># ci_up = (</span>
        <span class="c1">#     epst + norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdepst</span>
        <span class="c1"># )</span>
        <span class="c1"># ci_low = (</span>
        <span class="c1">#     epst - norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdepst</span>
        <span class="c1"># )</span>

        <span class="c1">##### LOCATION #####</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span> <span class="n">mut</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
        <span class="c1"># plt.fill_between(</span>
        <span class="c1">#     t_anual[t_ord],</span>
        <span class="c1">#     ci_low[t_ord],</span>
        <span class="c1">#     ci_up[t_ord],</span>
        <span class="c1">#     color=self.colors[0],</span>
        <span class="c1">#     alpha=0.3,</span>
        <span class="c1">#     label=r&quot;$\xi_t$ Confidence Interval&quot;,</span>
        <span class="c1"># )</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Location parameter (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (yearly scale)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mu_t$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/Evolution_Location</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1">##### SCALE #####</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span> <span class="n">psit</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">)</span>
        <span class="c1"># plt.fill_between(</span>
        <span class="c1">#     t_anual[t_ord],</span>
        <span class="c1">#     ci_low[t_ord],</span>
        <span class="c1">#     ci_up[t_ord],</span>
        <span class="c1">#     color=self.colors[0],</span>
        <span class="c1">#     alpha=0.3,</span>
        <span class="c1">#     label=r&quot;$\xi_t$ Confidence Interval&quot;,</span>
        <span class="c1"># )</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scale parameter (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (yearly scale)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\psi_t$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/Evolution_Scale</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1">##### SHAPE #####</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">init_year</span><span class="p">,</span> <span class="n">epst</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
        <span class="c1"># plt.fill_between(</span>
        <span class="c1">#     t_anual[t_ord],</span>
        <span class="c1">#     ci_low[t_ord],</span>
        <span class="c1">#     ci_up[t_ord],</span>
        <span class="c1">#     color=self.colors[0],</span>
        <span class="c1">#     alpha=0.3,</span>
        <span class="c1">#     label=r&quot;$\xi_t$ Confidence Interval&quot;,</span>
        <span class="c1"># )</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape parameter (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (yearly scale)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\xi_t$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/Evolution_Shape</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># ### Harmonic Location parameter plot</span>
        <span class="c1"># if self.nmu &gt; 0:</span>
        <span class="c1">#     t_ord = np.argsort(t_anual)</span>
        <span class="c1">#     quan95_2 = self._quantile(harm=True)</span>

        <span class="c1">#     mut2 = self._parametro(self.beta0, self.beta)</span>
        <span class="c1">#     # Confidence interval for mut</span>
        <span class="c1">#     ci_up = mut2 + norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdmut</span>
        <span class="c1">#     ci_low = (</span>
        <span class="c1">#         mut2 - norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdmut</span>
        <span class="c1">#     )</span>

        <span class="c1">#     plt.figure(figsize=(10, 6))</span>
        <span class="c1">#     plt.plot(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         self.xt[t_ord],</span>
        <span class="c1">#         marker=&quot;+&quot;,</span>
        <span class="c1">#         linestyle=&quot;None&quot;,</span>
        <span class="c1">#         color=&quot;black&quot;,</span>
        <span class="c1">#         markersize=5,</span>
        <span class="c1">#         label=f&quot;{self.var_name}&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     plt.plot(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         mut2[t_ord],</span>
        <span class="c1">#         label=r&quot;$\mu_t$&quot;,</span>
        <span class="c1">#         linewidth=2,</span>
        <span class="c1">#         color=self.colors[0],</span>
        <span class="c1">#     )</span>
        <span class="c1">#     plt.fill_between(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         ci_low[t_ord],</span>
        <span class="c1">#         ci_up[t_ord],</span>
        <span class="c1">#         color=self.colors[0],</span>
        <span class="c1">#         alpha=0.3,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     # Confidence interval for the quantile</span>
        <span class="c1">#     ci_up = (</span>
        <span class="c1">#         quan95_2 + norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdDq</span>
        <span class="c1">#     )</span>
        <span class="c1">#     ci_low = (</span>
        <span class="c1">#         quan95_2 - norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdDq</span>
        <span class="c1">#     )</span>
        <span class="c1">#     plt.plot(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         quan95_2[t_ord],</span>
        <span class="c1">#         linestyle=&quot;dashed&quot;,</span>
        <span class="c1">#         color=self.colors[1],</span>
        <span class="c1">#         markersize=5,</span>
        <span class="c1">#         label=rf&quot;$q_{self.quanval}$&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     plt.fill_between(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         ci_low[t_ord],</span>
        <span class="c1">#         ci_up[t_ord],</span>
        <span class="c1">#         color=self.colors[1],</span>
        <span class="c1">#         alpha=0.3,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     plt.title(f&quot;Harmonic part of Location parameter ({self.var_name})&quot;)</span>
        <span class="c1">#     plt.xlabel(&quot;Time (yearly scale)&quot;)</span>
        <span class="c1">#     plt.ylabel(r&quot;$\mu_t$&quot;)</span>
        <span class="c1">#     plt.xticks(month_positions, month_initials)</span>
        <span class="c1">#     plt.legend(loc=&quot;best&quot;)</span>
        <span class="c1">#     plt.grid(True)</span>
        <span class="c1">#     if save:</span>
        <span class="c1">#         plt.savefig(</span>
        <span class="c1">#             f&quot;Figures/Harmonic_Location_Parameter_{self.var_name}.png&quot;, dpi=300</span>
        <span class="c1">#         )</span>
        <span class="c1">#     plt.show()</span>

        <span class="c1"># ### Scale parameter plot</span>
        <span class="c1"># if self.npsi &gt; 0:</span>
        <span class="c1">#     t_ord = np.argsort(t_anual)</span>

        <span class="c1">#     psit2 = np.exp(self._parametro(self.alpha0, self.alpha))</span>
        <span class="c1">#     # Confidence interval for psit</span>
        <span class="c1">#     ci_up = (</span>
        <span class="c1">#         psit2 + norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdpsit</span>
        <span class="c1">#     )</span>
        <span class="c1">#     ci_low = (</span>
        <span class="c1">#         psit2 - norm.ppf(1 - (1 - self.quanval) / 2, loc=0, scale=1) * stdpsit</span>
        <span class="c1">#     )</span>

        <span class="c1">#     plt.figure(figsize=(10, 6))</span>
        <span class="c1">#     plt.plot(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         psit2[t_ord],</span>
        <span class="c1">#         label=r&quot;$\psi_t$&quot;,</span>
        <span class="c1">#         linewidth=2,</span>
        <span class="c1">#         color=self.colors[0],</span>
        <span class="c1">#     )</span>
        <span class="c1">#     plt.fill_between(</span>
        <span class="c1">#         t_anual[t_ord],</span>
        <span class="c1">#         ci_low[t_ord],</span>
        <span class="c1">#         ci_up[t_ord],</span>
        <span class="c1">#         color=self.colors[0],</span>
        <span class="c1">#         alpha=0.3,</span>
        <span class="c1">#         label=r&quot;$\psi_t$ Confidence Interval&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     # plt.plot(t_anual[t_ord], quan95[t_ord], linestyle=&#39;dashed&#39;, color=self.colors[2], markersize=5, label=fr&quot;$q_{self.quanval}$&quot;)</span>
        <span class="c1">#     plt.title(f&quot;Harmonic part of Scale parameter ({self.var_name})&quot;)</span>
        <span class="c1">#     plt.xlabel(&quot;Time (yearly scale)&quot;)</span>
        <span class="c1">#     plt.xticks(month_positions, month_initials)</span>
        <span class="c1">#     plt.ylabel(r&quot;$\psi_t$&quot;)</span>
        <span class="c1">#     plt.grid(True)</span>
        <span class="c1">#     if save:</span>
        <span class="c1">#         plt.savefig(</span>
        <span class="c1">#             f&quot;Figures/Harmonic_Scale_Parameter_{self.var_name}.png&quot;, dpi=300</span>
        <span class="c1">#         )</span>
        <span class="c1">#     plt.show()</span>

        <span class="c1">#### PP Plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PPplot</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>

        <span class="c1">#### QQ plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QQplot</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>

        <span class="c1">#### Parameters Heatmap plot</span>
        <span class="c1"># self.paramplot(save=save)</span>

        <span class="c1">#### 3D plot of pdf</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">month_initials</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">mu_t</span> <span class="o">=</span> <span class="n">mut</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
            <span class="n">psi_t</span> <span class="o">=</span> <span class="n">psit</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
            <span class="n">xi_t</span> <span class="o">=</span> <span class="n">epst</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
            <span class="c1"># Definition of the Hs value grid</span>
            <span class="n">lim_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">lim_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span>
            <span class="n">hvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lim_min</span><span class="p">,</span> <span class="n">lim_max</span><span class="p">,</span> <span class="n">var_grid_resolution</span><span class="p">)</span>
            <span class="n">t_grid</span><span class="p">,</span> <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span> <span class="n">hvar</span><span class="p">)</span>
            <span class="c1"># Calculating the Probability Density Function (pdf) for each grid point</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">genextreme</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span>
                        <span class="n">x_grid</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=-</span><span class="n">xi_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">psi_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_shifted</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]))</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis_r&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (Months)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;PDF&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_positions</span><span class="p">,</span> <span class="n">month_initials</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">azim</span><span class="o">=-</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1">#### Return periods</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">return_plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returnperiod_plot</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">paramplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a heatmap of parameter sensitivities for location, scale and shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save : bool, False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get parameters</span>
        <span class="n">loc_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta0&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loc_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta0&quot;</span><span class="p">])</span>
            <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]):</span>
                <span class="n">loc_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Harm </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta_cov&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;beta_cov&quot;</span><span class="p">]):</span>
                <span class="n">loc_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;betaT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loc_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;betaT&quot;</span><span class="p">])</span>
            <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Trend&quot;</span><span class="p">)</span>

        <span class="c1"># Scale parameters</span>
        <span class="n">scale_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha0&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha0&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scale_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha_cov&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scale_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alpha_cov&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alphaT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scale_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;alphaT&quot;</span><span class="p">])</span>

        <span class="c1"># Shape parameters</span>
        <span class="n">shape_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma0&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shape_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma_cov&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shape_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gamma_cov&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gammaT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shape_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s2">&quot;gammaT&quot;</span><span class="p">])</span>

        <span class="c1"># Create data matrix</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_params</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_params</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)))</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_params</span><span class="p">)]</span> <span class="o">=</span> <span class="n">loc_params</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_params</span><span class="p">)]</span> <span class="o">=</span> <span class="n">scale_params</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_params</span><span class="p">)]</span> <span class="o">=</span> <span class="n">shape_params</span>

        <span class="c1"># Create figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="c1"># Create heatmap</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Add colorbar</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Coefficient value&quot;</span><span class="p">)</span>

        <span class="c1"># Add text annotations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Configure axes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Scale&quot;</span><span class="p">,</span> <span class="s2">&quot;Shape&quot;</span><span class="p">])</span>

        <span class="c1"># Rotate x labels for better readability</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span><span class="p">)</span>

        <span class="c1"># Add title and adjust layout</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Time-dependent GEV Parameters&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Components&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Figures/Parameters_Heatmap_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="NonStatGEV.QQplot">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.QQplot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">QQplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        QQ plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            If True, save the plot in &quot;Figures/&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ze</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">Zm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Zstandardt</span><span class="p">()</span>
        <span class="c1"># TODO: Chequear intervalos</span>
        <span class="n">Dwei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dzweibull</span><span class="p">()</span>
        <span class="n">stdDwei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Dwei</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dwei</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">Zmsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">Zm</span><span class="p">)</span>
        <span class="n">t_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Zm</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">Ze</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">Ze</span><span class="p">)],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">Ze</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">Ze</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">Ze</span><span class="p">,</span>
            <span class="n">Zmsort</span><span class="p">,</span>
            <span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">markeredgecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">markerfacecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># If no covariables or trends, plot the confidence interval</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">Ze</span><span class="p">,</span>
                <span class="n">Zmsort</span>
                <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stdDwei</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">Zmsort</span>
                <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stdDwei</span><span class="p">[</span><span class="n">t_ord</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># If dashed lines prefered</span>
            <span class="c1"># plt.plot(Ze, Zmsort+norm.ppf(1-(1-self.quanval)/2, loc=0, scale=1)*stdDwei[t_ord], linestyle=&#39;dashed&#39;, color=self.colors[2], markersize=5)</span>
            <span class="c1"># plt.plot(Ze, Zmsort-norm.ppf(1-(1-self.quanval)/2, loc=0, scale=1)*stdDwei[t_ord], linestyle=&#39;dashed&#39;, color=self.colors[2], markersize=5)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best model QQ plot (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Empirical&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Fitted&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;square&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/QQplot_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_Zstandardt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the standardized variable corresponding to the given parameters</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        Zt :</span>
<span class="sd">            Standarized variable of the given parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Zt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">))</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># WEIBULL or FRECHET value</span>
        <span class="n">Zt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># GUMBEL value</span>
        <span class="n">Zt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">-</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Zt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_Dzweibull</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the derivatives of the standardized maximum with respect to parameters</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        Dq : np.ndarray</span>
<span class="sd">            Derivative of standarized variable of the given parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate auxiliarly variables</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>

        <span class="c1"># Since z-values must be greater than 0 in order to avoid numerical problems, their values are set to be greater than 1e-8</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="c1"># zn = z ** (-1 / epst)</span>

        <span class="n">Dmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">Dpsit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">Depst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>

        <span class="c1"># Derivatives of the quantile function with respect to location, scale and shape parameters</span>
        <span class="n">Dmut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="n">Dpsit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">xn</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">Depst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">z</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>

        <span class="c1"># Gumbel derivatives</span>
        <span class="n">Dmut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="n">Dpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>
        <span class="n">Depst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## New Derivatives</span>
        <span class="n">Dmutastmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span>
        <span class="n">Dmutastpsit</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
        <span class="n">Dmutastepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Dpsitastpsit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span>
        <span class="n">Dpsitastepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span>

        <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set the Jacobian to zero matrix</span>
        <span class="n">Dq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">,</span>
                <span class="n">nd</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Jacobian elements related to the location parameters beta0 and beta, equation (A.6) in the paper</span>
        <span class="n">Dq</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastmut</span>

        <span class="c1"># If location harmonics are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dq</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Jacobian elements related to the location parameters betaT, beta_cov (equation A.9)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">Dmutastmut</span>  <span class="c1"># betaT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Dq</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Dmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">Dmutastmut</span>
                <span class="p">)</span>  <span class="c1"># beta_cov_i</span>

        <span class="c1"># Jacobian elements related to the scale parameters alpha0, alpha (equation A.7)</span>
        <span class="n">Dq</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span>
        <span class="p">)</span>  <span class="c1"># alpha0</span>
        <span class="c1"># If scale harmonic are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dq</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="p">)</span>  <span class="c1"># alpha</span>
        <span class="c1"># Jacobian elements related to the scale parameters alphaT and beta_cov (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span> <span class="p">:</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">*</span> <span class="n">psit1</span>  <span class="c1"># alphaT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Dq</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">:,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="o">*</span> <span class="n">psit1</span>
                <span class="p">)</span>  <span class="c1"># alpha_cov</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma0 and gamma (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">:,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
        <span class="c1"># If shape harmonics are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dq</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="n">k</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Depst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># If shape trend is included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
                <span class="p">:,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>  <span class="c1"># gammaT</span>
        <span class="c1"># If shape covariates are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Dq</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">:,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>  <span class="c1"># gamma_cov</span>

        <span class="k">return</span> <span class="n">Dq</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_Dmupsiepst</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the derivatives of the standarized maximum with respect to parameters</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        Dermut : np.ndarray</span>
<span class="sd">            Derivative of standarized maximum of location</span>
<span class="sd">        Derpsit : np.ndarray</span>
<span class="sd">            Derivative of standarized maximum of scale</span>
<span class="sd">        Derepst : np.ndarray</span>
<span class="sd">            Derivative of standarized maximum of shape</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">%</span> <span class="mi">1</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="n">Dmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">Dpsit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">Depst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>

        <span class="c1">## New Derivatives</span>
        <span class="n">Dmutastmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span>
        <span class="n">Dmutastpsit</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
        <span class="n">Dmutastepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Dpsitastpsit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span>
        <span class="n">Dpsitastepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span>

        <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Derivatives of location, scale and shape parameters respect the model parameters (beta0, beta, ...)</span>
        <span class="n">Dermut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">,</span> <span class="n">nd</span><span class="p">))</span>
        <span class="n">Derpsit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">,</span> <span class="n">nd</span><span class="p">))</span>
        <span class="n">Derepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">,</span> <span class="n">nd</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Jacobian elements related to the location parameters beta0 and beta</span>
        <span class="n">Dermut</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastmut</span>

        <span class="c1"># If location harmonics are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dermut</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Jacobian elements related to the location parameters betaT, beta_cov (equation A.9)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dermut</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">Dmutastmut</span>  <span class="c1"># betaT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Dermut</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Dmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">Dmutastmut</span>
                <span class="p">)</span>  <span class="c1"># beta_cov_i</span>

        <span class="c1"># Jacobian elements related to the scale parameters alpha0, alpha (equation A.7)</span>
        <span class="n">Derpsit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>  <span class="c1"># alpha0</span>
        <span class="c1"># If scale harmonic are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Derpsit</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="p">)</span>  <span class="c1"># alpha</span>
        <span class="c1"># Jacobian elements related to the scale parameters alphaT and beta_cov (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Derpsit</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">psit1</span>
            <span class="p">)</span>  <span class="c1"># alphaT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Derpsit</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="o">*</span> <span class="n">psit1</span>
                <span class="p">)</span>  <span class="c1"># alpha_cov</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma0 and gamma (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Derepst</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
        <span class="c1"># If shape harmonics are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Derepst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Depst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># If shape trend is included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Derepst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
            <span class="p">)</span>  <span class="c1"># gammaT</span>
        <span class="c1"># If shape covariates are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Derepst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Depst</span> <span class="o">+</span> <span class="n">Dpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>  <span class="c1"># gamma_cov</span>

        <span class="k">return</span> <span class="n">Dermut</span><span class="p">,</span> <span class="n">Derpsit</span><span class="p">,</span> <span class="n">Derepst</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_DQuantile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the quantile derivative associated with a given parameterization with respect model parameters</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        Dq : np.ndarray</span>
<span class="sd">            Quantile derivative</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">%</span> <span class="mi">1</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="n">Dqmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">Dqpsit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="n">Dqepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>

        <span class="c1"># Derivatives of the quantile function with respect to location, scale and shape parameters</span>
        <span class="n">Dqmut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="n">Dqpsit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span>
            <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Dqepst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span>
                <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Gumbel derivatives</span>
        <span class="n">Dqmut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dqpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dqepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1">## New Derivatives</span>
        <span class="n">Dmutastmut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span>
        <span class="n">Dmutastpsit</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span>
        <span class="n">Dmutastepst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">epst</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">epst</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">Dpsitastpsit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span>
        <span class="n">Dpsitastepst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="o">**</span><span class="n">epst</span><span class="p">)</span>

        <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>
        <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set the Jacobian to zero matrix</span>
        <span class="n">Dq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">,</span>
                <span class="n">nd</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Jacobian elements related to the location parameters beta0 and beta, equation (A.6) in the paper</span>
        <span class="n">Dq</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastmut</span>

        <span class="c1"># If location harmonics are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dq</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dqmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Jacobian elements related to the location parameters betaT, beta_cov (equation A.9)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">Dmutastmut</span>  <span class="c1"># betaT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">Dq</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Dqmut</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">Dmutastmut</span>
                <span class="p">)</span>  <span class="c1"># beta_cov_i</span>

        <span class="c1"># Jacobian elements related to the scale parameters alpha0, alpha (equation A.7)</span>
        <span class="n">Dq</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psit1</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">Dqpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span>
        <span class="p">)</span>  <span class="c1"># alpha0</span>
        <span class="c1"># If scale harmonic are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dq</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">psit1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">Dqpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">Dqmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="p">)</span>  <span class="c1"># alpha</span>
        <span class="c1"># Jacobian elements related to the scale parameters alphaT and beta_cov (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">,</span> <span class="p">:</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Dqpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">psit1</span>  <span class="c1"># alphaT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">Dq</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">:,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">Dqpsit</span> <span class="o">*</span> <span class="n">Dpsitastpsit</span> <span class="o">+</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastpsit</span><span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="o">*</span> <span class="n">psit1</span>
                <span class="p">)</span>  <span class="c1"># alpha_cov</span>

        <span class="c1"># Jacobian elements related to the shape parameters gamma0 and gamma (equation A.10)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">,</span>
                <span class="p">:,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">Dqepst</span> <span class="o">+</span> <span class="n">Dqpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
        <span class="c1"># If shape harmonics are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                    <span class="n">Dq</span><span class="p">[</span>
                        <span class="mi">2</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                        <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                        <span class="n">k</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Dqepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">Dqpsit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dpsitastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">Dqmut</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmutastepst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dparam</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># If shape trend is included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Dq</span><span class="p">[</span>
                <span class="mi">2</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">,</span>
                <span class="p">:,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">Dqepst</span> <span class="o">+</span> <span class="n">Dqpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="c1"># If shape covariates are included</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">Dq</span><span class="p">[</span>
                    <span class="mi">2</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
                    <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
                    <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="p">:,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Dqepst</span> <span class="o">+</span> <span class="n">Dqpsit</span> <span class="o">*</span> <span class="n">Dpsitastepst</span> <span class="o">+</span> <span class="n">Dqmut</span> <span class="o">*</span> <span class="n">Dmutastepst</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>  <span class="c1"># gamma_cov</span>

        <span class="k">return</span> <span class="n">Dq</span>

<div class="viewcode-block" id="NonStatGEV.PPplot">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.PPplot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">PPplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PP plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            If True, save the plot in &quot;Figures/&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Empirical distribution function value</span>
        <span class="n">Fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CDFGEVt</span><span class="p">()</span>
        <span class="c1"># Computing the standard errors</span>
        <span class="n">Zm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Zstandardt</span><span class="p">()</span>
        <span class="n">Dwei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dzweibull</span><span class="p">()</span>
        <span class="n">stdDwei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Dwei</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dwei</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Sort the data</span>
        <span class="n">Fmsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">Fm</span><span class="p">)</span>
        <span class="n">t_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Fm</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">Fe</span><span class="p">,</span>
            <span class="n">Fmsort</span><span class="p">,</span>
            <span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">markeredgecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">markerfacecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># If no covariables or trends, plot the confidence interval</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">Fe</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                        <span class="o">-</span><span class="n">Zm</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">stdDwei</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                        <span class="o">-</span><span class="n">Zm</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">stdDwei</span><span class="p">[</span><span class="n">t_ord</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># If dashed lines prefered</span>
            <span class="c1"># plt.plot(Fe, np.exp(-np.exp(-Zm[t_ord]+norm.ppf(1-(1-self.quanval)/2, loc=0, scale=1)*stdDwei[t_ord])), linestyle=&#39;dashed&#39;, color=self.colors[2], markersize=5)</span>
            <span class="c1"># plt.plot(Fe, np.exp(-np.exp(-Zm[t_ord]-norm.ppf(1-(1-self.quanval)/2, loc=0, scale=1)*stdDwei[t_ord])), linestyle=&#39;dashed&#39;, color=self.colors[2], markersize=5)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best model PP plot (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Empirical&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Fitted&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;square&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/PPplot_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_CDFGEVt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the GEV distribution function corresponding to the given parameters</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        F : np.ndarray</span>
<span class="sd">            Cumulative distribution function values of Non-stationary GEV for the data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">))</span>

        <span class="c1"># Evaluate the parameters</span>
        <span class="n">mut1</span><span class="p">,</span> <span class="n">psit1</span><span class="p">,</span> <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_params</span><span class="p">(</span>
            <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">,</span>
            <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span>
            <span class="n">alpha_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">,</span>
            <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">,</span>
            <span class="n">covariates_loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">covariates_sh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># WEIBULL or FRECHET distribution function</span>
        <span class="n">F</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span>
            <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># GUMBEL distribution function</span>
        <span class="n">F</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">-</span> <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">F</span>

<div class="viewcode-block" id="NonStatGEV.returnperiod_plot">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.returnperiod_plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">returnperiod_plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">annualplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">monthly_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Funtion to plot the Aggregated Return period plot for each month and the annual Return period</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        annualplot : bool, default=True</span>
<span class="sd">            Whether to plot the annual return period plot</span>
<span class="sd">        conf_int : bool, default=False</span>
<span class="sd">            Whether to plot the confidence bands for annual return periods</span>
<span class="sd">            Heavy computational time</span>
<span class="sd">        monthly_plot : bool, default=False</span>
<span class="sd">            Wheter to plot the return periods grouped by months</span>
<span class="sd">        save : bool, default=False</span>
<span class="sd">            Whether to save the plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling: Return Period plot (.returnperiod_plot())&quot;</span><span class="p">)</span>

        <span class="n">Ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="mf">1.1</span><span class="p">,</span>
                <span class="mf">1.5</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">3</span><span class="p">,</span>
                <span class="mi">4</span><span class="p">,</span>
                <span class="mi">5</span><span class="p">,</span>
                <span class="mf">7.5</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="mi">15</span><span class="p">,</span>
                <span class="mi">20</span><span class="p">,</span>
                <span class="mi">30</span><span class="p">,</span>
                <span class="mi">40</span><span class="p">,</span>
                <span class="mi">50</span><span class="p">,</span>
                <span class="mi">75</span><span class="p">,</span>
                <span class="mi">100</span><span class="p">,</span>
                <span class="mi">150</span><span class="p">,</span>
                <span class="mi">200</span><span class="p">,</span>
                <span class="mi">500</span><span class="p">,</span>
                <span class="mi">1000</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Ts = np.concatenate(</span>
        <span class="c1">#     (np.arange(2, 10, 1), np.arange(10, 100, 10), np.arange(100, 501, 100))</span>
        <span class="c1"># )</span>

        <span class="n">nts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ts</span><span class="p">)</span>
        <span class="n">quanaggrA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>
        <span class="n">quanaggr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="n">nts</span><span class="p">))</span>
        <span class="n">stdDqX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="n">nts</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">monthly_plot</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nts</span><span class="p">):</span>
                    <span class="n">quanaggr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Ts</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># DO NOT COMPUTE CONFIDENCE INTERVAL IN MONTHLY RETURN PERIODS</span>
                    <span class="c1"># stdQuan = self._ConfidInterQuanAggregate(</span>
                    <span class="c1">#     1 - 1 / Ts[j], i / 12, (i + 1) / 12</span>
                    <span class="c1"># )</span>
                    <span class="c1"># # stdQuan = 0.1</span>
                    <span class="c1"># stdDqX[i, j] = stdQuan * norm.ppf(</span>
                    <span class="c1">#     1 - (1 - self.quanval) / 2, loc=0, scale=1</span>
                    <span class="c1"># )</span>

        <span class="c1"># If annual data has to be plotted</span>
        <span class="k">if</span> <span class="n">annualplot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ReturnPeriodPlot: Annual return period.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nts</span><span class="p">):</span>
                <span class="n">quanaggrA</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Ts</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ReturnPeriodPlot: Annual return period </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> finished.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Confidence intervals</span>
            <span class="k">if</span> <span class="n">conf_int</span><span class="p">:</span>
                <span class="n">stdup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>
                <span class="n">stdlo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nts</span><span class="p">):</span>
                    <span class="n">stdQuan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConfidInterQuanAggregate</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Ts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># stdQuan = 0.1</span>
                    <span class="n">stdup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">quanaggrA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">stdQuan</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="n">stdlo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">quanaggrA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">stdQuan</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span>
                    <span class="p">)</span>

        <span class="c1">## Plot the return periods</span>
        <span class="c1"># datemax_mod = self.t % 1</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;January&quot;</span><span class="p">,</span>
            <span class="s2">&quot;February&quot;</span><span class="p">,</span>
            <span class="s2">&quot;March&quot;</span><span class="p">,</span>
            <span class="s2">&quot;April&quot;</span><span class="p">,</span>
            <span class="s2">&quot;May&quot;</span><span class="p">,</span>
            <span class="s2">&quot;June&quot;</span><span class="p">,</span>
            <span class="s2">&quot;July&quot;</span><span class="p">,</span>
            <span class="s2">&quot;August&quot;</span><span class="p">,</span>
            <span class="s2">&quot;September&quot;</span><span class="p">,</span>
            <span class="s2">&quot;October&quot;</span><span class="p">,</span>
            <span class="s2">&quot;November&quot;</span><span class="p">,</span>
            <span class="s2">&quot;December&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#FF5733&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#33FF57&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3357FF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FF33A8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#33FFF6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FFD633&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#8D33FF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FF8C33&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#33FF8C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#3366FF&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FF3333&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#33FF33&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">monthly_plot</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
                    <span class="n">Ts</span><span class="p">,</span>
                    <span class="n">quanaggr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="c1"># Anual return periods</span>
        <span class="k">if</span> <span class="n">annualplot</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">quanaggrA</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Annual&quot;</span><span class="p">)</span>
            <span class="c1"># ny = int(np.ceil(self.t[-1]))</span>
            <span class="c1"># hmax1 = np.zeros(ny)</span>
            <span class="c1"># for j in range(ny):</span>
            <span class="c1">#     hmax1[j] = np.max(</span>
            <span class="c1">#         self.xt[np.where((self.t &gt;= j) &amp; (self.t &lt; j + 1))[0]]</span>
            <span class="c1">#     )</span>

            <span class="c1"># Vectorized way</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># Create mask for each year&#39;s data</span>
            <span class="n">year_masks</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">)]</span>
            <span class="c1"># Calculate max values using masks and broadcasting</span>
            <span class="n">hmax1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">year_masks</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Remove any NaN values if present</span>
            <span class="n">hmax1</span> <span class="o">=</span> <span class="n">hmax1</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hmax1</span><span class="p">)]</span>

            <span class="n">hmaxsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">hmax1</span><span class="p">)</span>
            <span class="n">ProHsmaxsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hmaxsort</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hmaxsort</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">Tapprox</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ProHsmaxsort</span><span class="p">)</span>
            <span class="c1"># idx = np.where(Tapprox &gt;= 2)[0]</span>
            <span class="c1"># ax.semilogx(Tapprox[idx], hmaxsort[idx], &quot;ok&quot;, markersize=1.6)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
                <span class="n">Tapprox</span><span class="p">,</span> <span class="n">hmaxsort</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">conf_int</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">stdlo</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">stdup</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Return Period (Years)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">Ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
        <span class="c1"># ax.set_ylim(bottom=0)</span>
        <span class="c1"># ax.set_title(f&quot;Aggregate Quantiles ({self.var_name})&quot;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figures/ReturnPeriod_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_aggquantile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">,</span>
        <span class="n">t0</span><span class="p">,</span>
        <span class="n">t1</span><span class="p">,</span>
        <span class="n">beta0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">betaT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alphaT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gammaT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha_cov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma_cov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">list_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">list_sc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">list_sh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">covariates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to compute the aggregated quantile between two time stamps</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q :</span>
<span class="sd">            Quantile value</span>
<span class="sd">        t0 :</span>
<span class="sd">            Starting point of integration interval</span>
<span class="sd">        t1 :</span>
<span class="sd">            Ending point of integration interval</span>
<span class="sd">        beta0 : default=None</span>
<span class="sd">            Stationary part of location parameter</span>
<span class="sd">        beta : default=None</span>
<span class="sd">            Harmonic part of location parameter</span>
<span class="sd">        alpha0 : default=None,</span>
<span class="sd">            Stationary part of scale parameter</span>
<span class="sd">        alpha : default=None</span>
<span class="sd">            Harmonic part of scale parameter</span>
<span class="sd">        gamma0: default=None</span>
<span class="sd">            Stationary part of shape parameter</span>
<span class="sd">        gamma : default=None,</span>
<span class="sd">            Harmonic part of shape parameter</span>
<span class="sd">        betaT : default=None</span>
<span class="sd">            Trend part of location parameter</span>
<span class="sd">        alphaT : default=None</span>
<span class="sd">            Trend part of scale parameter</span>
<span class="sd">        gammaT : default=None</span>
<span class="sd">            Trend part of shape parameter</span>
<span class="sd">        beta_cov : default=None</span>
<span class="sd">            Covariate part of location parameter</span>
<span class="sd">        alpha_cov : default=None</span>
<span class="sd">            Covariate part of scale parameter</span>
<span class="sd">        gamma_cov : default=None</span>
<span class="sd">            Covariate part of shape parameter</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        zqout : np.ndarray</span>
<span class="sd">            Aggregated return period</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta0</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="k">if</span> <span class="n">alpha0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="k">if</span> <span class="n">gamma0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gamma0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span>
        <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
        <span class="k">if</span> <span class="n">betaT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">betaT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betaT</span>
        <span class="k">if</span> <span class="n">alphaT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alphaT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span>
        <span class="k">if</span> <span class="n">beta_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span>
        <span class="k">if</span> <span class="n">alpha_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span>
        <span class="k">if</span> <span class="n">gamma_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gamma_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span>
        <span class="k">if</span> <span class="n">list_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span>
        <span class="k">if</span> <span class="n">list_sc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span>
        <span class="k">if</span> <span class="n">list_sh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span>
        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">covariates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span>

        <span class="c1"># Deal with scalars and vectors</span>
        <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">beta_cov</span><span class="p">)</span>
        <span class="n">alpha_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">alpha_cov</span><span class="p">)</span>
        <span class="n">gamma_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">gamma_cov</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q</span><span class="p">])</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t1</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">m0</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Initial quantile aggregated integration time size must be equal than the quantile size&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">m1</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Final quantile aggregated integration time size must be equal than the quantile size&quot;</span>
            <span class="p">)</span>

        <span class="c1"># For the required period the mean value of the corresponding covariates is calculated and considered constant for the rest of the study</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cov_locint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">beta_cov</span><span class="p">)</span>
            <span class="n">cov_scint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">alpha_cov</span><span class="p">)</span>
            <span class="n">cov_shint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gamma_cov</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">beta_cov</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">cov_locint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">alpha_cov</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">cov_scint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gamma_cov</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">cov_shint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_locint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">beta_cov</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">cov_scint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">alpha_cov</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">cov_shint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">gamma_cov</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># Require quantile</span>
        <span class="n">zqout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">media</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">beta0</span><span class="p">,</span>
                <span class="n">beta</span><span class="p">,</span>
                <span class="n">betaT</span><span class="p">,</span>
                <span class="n">beta_cov</span><span class="p">,</span>
                <span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">cov_locint</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">x</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">std</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                    <span class="n">alpha0</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="p">,</span>
                    <span class="n">alphaT</span><span class="p">,</span>
                    <span class="n">alpha_cov</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">cov_scint</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">media</span> <span class="o">-</span> <span class="mi">10</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">media</span> <span class="o">+</span> <span class="mi">20</span>

        <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="c1"># function of z whose root we want</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">F</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Inicio quad()&quot;</span><span class="p">)</span>
                <span class="n">integ</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fzeroquanint</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">z</span><span class="p">,</span>
                        <span class="n">q</span><span class="p">[</span><span class="n">il</span><span class="p">],</span>
                        <span class="n">cov_locint</span><span class="p">,</span>
                        <span class="n">cov_scint</span><span class="p">,</span>
                        <span class="n">cov_shint</span><span class="p">,</span>
                        <span class="n">beta0</span><span class="p">,</span>
                        <span class="n">beta</span><span class="p">,</span>
                        <span class="n">alpha0</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="p">,</span>
                        <span class="n">gamma0</span><span class="p">,</span>
                        <span class="n">gamma</span><span class="p">,</span>
                        <span class="n">betaT</span><span class="p">,</span>
                        <span class="n">alphaT</span><span class="p">,</span>
                        <span class="n">gammaT</span><span class="p">,</span>
                        <span class="n">beta_cov</span><span class="p">,</span>
                        <span class="n">alpha_cov</span><span class="p">,</span>
                        <span class="n">gamma_cov</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">kt</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">t0</span><span class="p">[</span><span class="n">il</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="n">il</span><span class="p">]),</span>
                    <span class="n">epsabs</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
                    <span class="n">epsrel</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fin quad()&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">integ</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">il</span><span class="p">])</span> <span class="o">/</span> <span class="mf">12.0</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># sol = root_scalar(</span>
                <span class="c1">#     F,</span>
                <span class="c1">#     x0=media,</span>
                <span class="c1">#     x1=media + 1.0,  # secant starting points</span>
                <span class="c1">#     method=&quot;secant&quot;,</span>
                <span class="c1">#     xtol=1e-6,</span>
                <span class="c1">#     rtol=1e-6,</span>
                <span class="c1">#     maxiter=200,</span>
                <span class="c1"># )</span>

                <span class="n">sol</span> <span class="o">=</span> <span class="n">root_scalar</span><span class="p">(</span>
                    <span class="n">F</span><span class="p">,</span>
                    <span class="n">bracket</span><span class="o">=</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;toms748&quot;</span><span class="p">,</span>
                    <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">root</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">:</span>
                        <span class="n">zqout</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">root</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zqout</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># &quot;False zero&quot; check</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zqout</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">zqout</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">zqout</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fzeroquanint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">zq</span><span class="p">,</span>
        <span class="n">q</span><span class="p">,</span>
        <span class="n">indicesint</span><span class="p">,</span>
        <span class="n">indices2int</span><span class="p">,</span>
        <span class="n">indices3int</span><span class="p">,</span>
        <span class="n">beta0</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">,</span>
        <span class="n">alpha0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">gamma0</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">,</span>
        <span class="n">betaT</span><span class="p">,</span>
        <span class="n">alphaT</span><span class="p">,</span>
        <span class="n">gammaT</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="p">,</span>
        <span class="n">alpha_cov</span><span class="p">,</span>
        <span class="n">gamma_cov</span><span class="p">,</span>
        <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ktold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auxiliar function to solve the quantile</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        zn : np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Inicio _fzeroquanint()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ktold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ktold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span>

        <span class="c1"># Evaluate the location parameter at each time t as a function of the actual values of the parameters given by p</span>
        <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
            <span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">indicesint</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Evaluate the scale parameter at each time t as a function of the actual values of the parameters given by p</span>
        <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">alpha0</span><span class="p">,</span>
                <span class="n">alpha</span><span class="p">,</span>
                <span class="n">alphaT</span><span class="p">,</span>
                <span class="n">alpha_cov</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">indices2int</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Evaluate the sahpe parameter at each time t as a function of the actual values of the parameters given by p</span>
        <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
            <span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">indices3int</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ktold</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mut1</span><span class="p">)</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">kt2</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">kt2</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kt2</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate the auxiliary variable</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="n">zq</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>
        <span class="c1"># Since the z-values must be greater than zero in order to avoid numerical problems their values are set to be greater than 1e-4</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span>
        <span class="c1"># GUMBEL case</span>
        <span class="n">zn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fin _fzeroquanint()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fzeroderiquanint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">zq</span><span class="p">,</span>
        <span class="n">q</span><span class="p">,</span>
        <span class="n">indicesint</span><span class="p">,</span>
        <span class="n">indices2int</span><span class="p">,</span>
        <span class="n">indices3int</span><span class="p">,</span>
        <span class="n">beta0</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">,</span>
        <span class="n">alpha0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">gamma0</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">,</span>
        <span class="n">betaT</span><span class="p">,</span>
        <span class="n">alphaT</span><span class="p">,</span>
        <span class="n">gammaT</span><span class="p">,</span>
        <span class="n">beta_cov</span><span class="p">,</span>
        <span class="n">alpha_cov</span><span class="p">,</span>
        <span class="n">gamma_cov</span><span class="p">,</span>
        <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ktold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auxiliar Function to solve the quantile derivative</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        zn : np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ktold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ktold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kt</span>

        <span class="c1"># Evaluate the location parameter at each time t as a function of the actual values of the parameters given by p</span>
        <span class="n">mut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
            <span class="n">beta0</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">,</span>
            <span class="n">betaT</span><span class="p">,</span>
            <span class="n">beta_cov</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">indicesint</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Evaluate the scale parameter at each time t as a function of the actual values of the parameters given by p</span>
        <span class="n">psit1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
                <span class="n">alpha0</span><span class="p">,</span>
                <span class="n">alpha</span><span class="p">,</span>
                <span class="n">alphaT</span><span class="p">,</span>
                <span class="n">alpha_cov</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">indices2int</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Evaluate the sahpe parameter at each time t as a function of the actual values of the parameters given by p</span>
        <span class="n">epst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parametro</span><span class="p">(</span>
            <span class="n">gamma0</span><span class="p">,</span>
            <span class="n">gamma</span><span class="p">,</span>
            <span class="n">gammaT</span><span class="p">,</span>
            <span class="n">gamma_cov</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">indices3int</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="n">t</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The values whose shape parameter is almost cero corresponds to the GUMBEL distribution, locate their positions if they exist</span>
        <span class="n">posG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The remaining values correspond to WEIBULL or FRECHET</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">epst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># The corresponding GUMBEl values are set to 1 to avoid numerical problems, note that for those cases the GUMBEL expressions are used</span>
        <span class="n">epst</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ktold</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mut1</span><span class="p">)</span>

        <span class="n">mut</span> <span class="o">=</span> <span class="n">mut1</span>
        <span class="n">psit</span> <span class="o">=</span> <span class="n">psit1</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">kt2</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">psit</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">psit1</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">*</span> <span class="n">kt2</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">**</span> <span class="n">epst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># Modify the parameters to include Gumbel</span>
        <span class="n">mut</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kt2</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span>

        <span class="c1"># Evaluate the auxiliary variable</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="p">(</span><span class="n">zq</span> <span class="o">-</span> <span class="n">mut</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">epst</span> <span class="o">*</span> <span class="n">xn</span>
        <span class="c1"># Since the z-values must be greater than zero in order to avoid numerical problems their values are set to be greater than 1e-4</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">epst</span><span class="p">)</span> <span class="o">/</span> <span class="n">psit</span>
        <span class="c1"># GUMBEL case</span>
        <span class="n">zn</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xn</span><span class="p">[</span><span class="n">posG</span><span class="p">])</span> <span class="o">/</span> <span class="n">psit</span><span class="p">[</span><span class="n">posG</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">zn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ConfidInterQuanAggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auxiliar function to compute the std for the aggregated quantiles</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        stdQuan : np.ndarray</span>
<span class="sd">            Standard deviation of quantile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Total length of the data</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">2</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span>
        <span class="p">)</span>

        <span class="c1"># Initialize the Jacobian</span>
        <span class="n">jacob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">epsi</span> <span class="o">=</span> <span class="mf">1e-4</span>

        <span class="c1"># beta0 derivative</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta0</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># beta derivatives</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">beta1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
                <span class="n">beta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
                <span class="n">beta2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="n">beta1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># betaT derivative</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">betaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">betaT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">betaT</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># beta_cov derivative</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">beta_covlb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span>
                    <span class="n">beta_covub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span>
                    <span class="n">beta_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">)</span>
                    <span class="n">beta_covub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">)</span>
                    <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                            <span class="n">q</span><span class="p">,</span>
                            <span class="n">t0</span><span class="p">,</span>
                            <span class="n">t1</span><span class="p">,</span>
                            <span class="n">beta_cov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">beta_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                            <span class="n">list_loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                            <span class="n">q</span><span class="p">,</span>
                            <span class="n">t0</span><span class="p">,</span>
                            <span class="n">t1</span><span class="p">,</span>
                            <span class="n">beta_cov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">beta_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                            <span class="n">list_loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># alpha0 derivative</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alpha0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># alpha derivatives</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">alpha1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
                <span class="n">alpha2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
                <span class="n">alpha2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="n">alpha1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># alphaT derivative</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># alpha_cov derivative</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alpha_covlb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span>
                    <span class="n">alpha_covub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span>
                    <span class="n">alpha_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">)</span>
                    <span class="n">alpha_covub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">)</span>
                    <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                            <span class="n">q</span><span class="p">,</span>
                            <span class="n">t0</span><span class="p">,</span>
                            <span class="n">t1</span><span class="p">,</span>
                            <span class="n">alpha_cov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">alpha_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                            <span class="n">list_sc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                            <span class="n">q</span><span class="p">,</span>
                            <span class="n">t0</span><span class="p">,</span>
                            <span class="n">t1</span><span class="p">,</span>
                            <span class="n">alpha_cov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">alpha_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                            <span class="n">list_sc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># gamma0 derivative</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">gamma0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">gamma1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
                <span class="n">gamma2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
                <span class="n">gamma2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="n">gamma1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="c1"># gammaT derivative</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">gammaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">alphaT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">):</span>
                <span class="n">aux</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gamma_covlb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span>
                    <span class="n">gamma_covub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span>
                    <span class="n">gamma_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">epsi</span><span class="p">)</span>
                    <span class="n">gamma_covub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsi</span><span class="p">)</span>
                    <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                            <span class="n">q</span><span class="p">,</span>
                            <span class="n">t0</span><span class="p">,</span>
                            <span class="n">t1</span><span class="p">,</span>
                            <span class="n">gamma_cov</span><span class="o">=</span><span class="n">gamma_covlb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">list_sh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggquantile</span><span class="p">(</span>
                            <span class="n">q</span><span class="p">,</span>
                            <span class="n">t0</span><span class="p">,</span>
                            <span class="n">t1</span><span class="p">,</span>
                            <span class="n">gamma_cov</span><span class="o">=</span><span class="n">gamma_covub</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">list_sh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">epsi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jacob</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Computing the standard deviations for the quantiles</span>
        <span class="n">stdQuan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jacob</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">invI0</span> <span class="o">@</span> <span class="n">jacob</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stdQuan</span>

<div class="viewcode-block" id="NonStatGEV.summary">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.NonStatGEV.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a summary of the fitted model, including parameter estimates, standard errors and fit statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">std_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_params</span>
        <span class="n">param_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">z_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fitted Time-Dependent GEV model for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="c1"># Header format</span>
        <span class="n">param_header</span> <span class="o">=</span> <span class="s2">&quot;Parameter&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">estimate_header</span> <span class="o">=</span> <span class="s2">&quot;Estimate&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">se_header</span> <span class="o">=</span> <span class="s2">&quot;Std. Error&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ci_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quanval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% CI&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param_header</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">estimate_header</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">se_header</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ci_header</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Location Parameters&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="c1"># Parameter line format</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">format_line</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">std_err</span><span class="p">):</span>
            <span class="n">ci_low</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">std_err</span> <span class="o">*</span> <span class="n">z_norm</span>
            <span class="n">ci_up</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">std_err</span> <span class="o">*</span> <span class="n">z_norm</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">&gt;12.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">std_err</span><span class="si">:</span><span class="s2">&gt;15.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">ci_low</span><span class="si">:</span><span class="s1">&gt;8.4f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">ci_up</span><span class="si">:</span><span class="s1">&gt;8.4f</span><span class="si">}</span><span class="s1">]&#39;</span><span class="si">:</span><span class="s2">&gt;25</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Location parameters</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">format_line</span><span class="p">(</span><span class="s2">&quot;Beta0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta0</span><span class="p">,</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]))</span>
        <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmu</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Beta</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (sin)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Beta</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (cos)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_line</span><span class="p">(</span><span class="s2">&quot;BetaT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">betaT</span><span class="p">,</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]))</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">list_loc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">beta_cov</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scale Parameters&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">format_line</span><span class="p">(</span><span class="s2">&quot;Alpha0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha0</span><span class="p">,</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]))</span>
        <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npsi</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Alpha</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (sin)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Alpha</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (cos)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_line</span><span class="p">(</span><span class="s2">&quot;AlphaT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphaT</span><span class="p">,</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]))</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alpha_cov</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Shape Parameters&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngamma0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_line</span><span class="p">(</span><span class="s2">&quot;Gamma0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0</span><span class="p">,</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]))</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngamma</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Gamma</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (sin)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Gamma</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (cos)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrend_sh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_line</span><span class="p">(</span><span class="s2">&quot;GammaT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaT</span><span class="p">,</span> <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]))</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nind_sh</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">format_line</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">list_sh</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gamma_cov</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">std_params</span><span class="p">[</span><span class="n">param_idx</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">param_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fit Statistics&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">stats_width</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Log-likelihood:&#39;</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">stats_width</span><span class="si">}}</span><span class="s2"> </span><span class="si">{</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;negloglikelihood&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;AIC:&#39;</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">stats_width</span><span class="si">}}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;AIC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Number of parameters:&#39;</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">stats_width</span><span class="si">}}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;n_params&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="bsimp">
<a class="viewcode-back" href="../../../bluemath_tk.distributions.html#bluemath_tk.distributions.nonstat_gev.bsimp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bsimp</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    BSIMP   Numerically evaluate integral, low order method.</span>
<span class="sd">    I = BSIMP(&#39;F&#39;,A,B) approximates the integral of F(X) from A to B</span>
<span class="sd">    within a relative error of 1e-3 using an iterative</span>
<span class="sd">    Simpson&#39;s rule.  &#39;F&#39; is a string containing the name of the</span>
<span class="sd">    function.  Function F must return a vector of output values if given</span>
<span class="sd">    a vector of input values.%</span>
<span class="sd">    I = BSIMP(&#39;F&#39;,A,B,EPSILON) integrates to a total error of EPSILON.  %</span>
<span class="sd">    I = BSIMP(&#39;F&#39;,A,B,N,EPSILON,TRACE,TRACETOL) integrates to a</span>
<span class="sd">    relative error of EPSILON,</span>
<span class="sd">    beginning with n subdivisions of the interval [A,B],for non-zero</span>
<span class="sd">    TRACE traces the function</span>
<span class="sd">    evaluations with a point plot.</span>
<span class="sd">    [I,cnt] = BSIMP(F,a,b,epsilon) also returns a function evaluation count.%</span>
<span class="sd">    Roberto Minguez Solana%   Copyright (c) 2001 by Universidad de Cantabria</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>

    <span class="c1"># The number of initial subintervals must be pair</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Step 1:</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

    <span class="c1"># Step 3:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># print(&quot;y size: &quot;, y.size)</span>
    <span class="c1"># print(&quot;n: &quot;, n)</span>
    <span class="c1"># TODO:</span>
    <span class="c1"># if trace:</span>

    <span class="n">auxI</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ainit</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="n">auxI1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">auxI2</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">auxI1</span> <span class="o">=</span> <span class="n">auxI1</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">auxI2</span> <span class="o">=</span> <span class="n">auxI2</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">cnt</span> <span class="o">=</span> <span class="n">n</span>

    <span class="c1"># Step 4</span>
    <span class="n">integral</span> <span class="o">=</span> <span class="p">(</span><span class="n">ainit</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">auxI1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">auxI2</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">auxtot</span> <span class="o">=</span> <span class="n">auxI1</span> <span class="o">+</span> <span class="n">auxI2</span>

    <span class="c1"># Step 5</span>
    <span class="n">integral1</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Step 6</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Step 7</span>
        <span class="n">integral1</span> <span class="o">=</span> <span class="n">integral</span>
        <span class="c1"># Step 8</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="n">j</span><span class="p">,</span> <span class="n">b</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="n">j</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">auxI</span> <span class="o">=</span> <span class="n">auxI</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)])</span>

        <span class="c1"># Step 9</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="p">(</span><span class="n">ainit</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">auxI</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">auxtot</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span>

        <span class="c1"># Step 10</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="c1"># Step 11</span>
        <span class="n">auxtot</span> <span class="o">=</span> <span class="n">auxtot</span> <span class="o">+</span> <span class="n">auxI</span>
        <span class="n">auxI</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Error</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integral1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">integral</span> <span class="o">-</span> <span class="n">integral1</span><span class="p">)</span> <span class="o">/</span> <span class="n">integral1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integral</span> <span class="o">-</span> <span class="n">integral1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">integral</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, GeoOcean Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>