

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bluemath_tk.tcs.tracks &mdash; Bluemath-Toolkit  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/thebelab.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Bluemath-Toolkit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">bluemath_tk</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Bluemath-Toolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bluemath_tk.tcs.tracks</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bluemath_tk.tcs.tracks</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">polyfit</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..config.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_paths</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EARTH_RADIUS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.geo</span><span class="w"> </span><span class="kn">import</span> <span class="n">geodesic_distance</span><span class="p">,</span> <span class="n">geodesic_distance_azimuth</span><span class="p">,</span> <span class="n">shoot</span>

<span class="n">PATHS</span> <span class="o">=</span> <span class="n">get_paths</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Configuration dictionaries and constants for IBTrACS data</span>
<span class="n">centers_config_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;USA&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;usa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;SA&quot;</span><span class="p">,</span> <span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">,</span> <span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;NI&quot;</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;TOKYO&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;tokyo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;lightcoral&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;CMA&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;cma&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;lime&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;HKO&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;hko&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;NEWDELHI&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;newdelhi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;WP&quot;</span><span class="p">,</span> <span class="s2">&quot;NI&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;REUNION&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;reunion&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;SI&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;BOM&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;bom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;WELLINGTON&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;wellington&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;slategrey&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;NADI&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;nadi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;SP&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;WMO&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;wmo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;SA&quot;</span><span class="p">,</span> <span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">,</span> <span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;NI&quot;</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;FORECAST&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;forecast&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basins&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AL&quot;</span><span class="p">,</span> <span class="s2">&quot;LS&quot;</span><span class="p">,</span> <span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;CP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">,</span> <span class="s2">&quot;IO&quot;</span><span class="p">,</span> <span class="s2">&quot;SH&quot;</span><span class="p">],</span>
        <span class="s2">&quot;windfac&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">all_centers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;USA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOKYO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CMA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NEWDELHI&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REUNION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BOM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WELLINGTON&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NADI&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WMO&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">all_basins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;SA&quot;</span><span class="p">,</span> <span class="s2">&quot;EP&quot;</span><span class="p">,</span> <span class="s2">&quot;WP&quot;</span><span class="p">,</span> <span class="s2">&quot;SP&quot;</span><span class="p">,</span> <span class="s2">&quot;NI&quot;</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="get_center_information">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.get_center_information">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_center_information</span><span class="p">(</span><span class="n">center</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;WMO&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the center information from the configuration parameters for IBTrACS data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    center : str, optional</span>
<span class="sd">        The name of the center to get information for. Default is &quot;WMO&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Union[str, None]]</span>
<span class="sd">        A dictionary containing the center information with the following keys:</span>
<span class="sd">        - source: Center ID</span>
<span class="sd">        - basin: Basin identifier</span>
<span class="sd">        - time: Time variable name</span>
<span class="sd">        - longitude: Longitude variable name</span>
<span class="sd">        - latitude: Latitude variable name</span>
<span class="sd">        - pressure: Pressure variable name</span>
<span class="sd">        - maxwinds: Maximum winds variable name</span>
<span class="sd">        - rmw: Radius of maximum winds variable name (if available)</span>
<span class="sd">        - dist2land: Distance to land variable name</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the specified center is not found in the configuration parameters.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; info = get_center_information(&quot;USA&quot;)</span>
<span class="sd">    &gt;&gt;&gt; info[&quot;source&quot;]</span>
<span class="sd">    &#39;usa&#39;</span>
<span class="sd">    &gt;&gt;&gt; info[&quot;rmw&quot;]</span>
<span class="sd">    &#39;usa_rmw&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">centers_config_params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Center </span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2"> not found. Available centers: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">centers_config_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;basin&quot;</span><span class="p">:</span> <span class="s2">&quot;basin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="s2">&quot;WMO&quot;</span>
        <span class="k">else</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_lon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="s2">&quot;WMO&quot;</span>
        <span class="k">else</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_lat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_pres&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxwinds&quot;</span><span class="p">:</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_wind&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rmw&quot;</span><span class="p">:</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_rmw&quot;</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;USA&quot;</span><span class="p">,</span> <span class="s2">&quot;REUNION&quot;</span><span class="p">,</span> <span class="s2">&quot;BOM&quot;</span><span class="p">]</span>
        <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;dist2land&quot;</span><span class="p">:</span> <span class="s2">&quot;dist2land&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="check_and_plot_track_data">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.check_and_plot_track_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_and_plot_track_data</span><span class="p">(</span><span class="n">track_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the track data for missing values and plot the track.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    track_data : xr.Dataset</span>
<span class="sd">        The track data to check in IBTrACS format. Must contain variables</span>
<span class="sd">        for time, longitude, latitude, pressure, and maximum winds for</span>
<span class="sd">        each center.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plt.Figure</span>
<span class="sd">        Figure object containing four subplots:</span>
<span class="sd">        1. Storm coordinates (lon vs lat)</span>
<span class="sd">        2. Minimum central pressure time series</span>
<span class="sd">        3. Maximum sustained winds time series</span>
<span class="sd">        4. Radii of maximum winds time series (if available)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Longitude values are converted to [0-360º] convention</span>
<span class="sd">    - Wind speeds are converted to 1-minute average using center-specific factors</span>
<span class="sd">    - Variables that are entirely NaN are omitted from plots</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">all_centers</span><span class="p">:</span>
        <span class="c1"># dictionary for IBTrACS center</span>
        <span class="n">center_info</span> <span class="o">=</span> <span class="n">get_center_information</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="c1"># get var time</span>
        <span class="n">ytime</span> <span class="o">=</span> <span class="n">track_data</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># remove NaTs (time)</span>
        <span class="n">st_lon</span> <span class="o">=</span> <span class="n">track_data</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>
        <span class="n">st_lat</span> <span class="o">=</span> <span class="n">track_data</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>
        <span class="n">st_prs</span> <span class="o">=</span> <span class="n">track_data</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>
        <span class="n">st_win</span> <span class="o">=</span> <span class="n">track_data</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;maxwinds&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]:</span>
            <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">track_data</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>
        <span class="n">st_tim</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>
        <span class="c1"># longitude convention [0-360º]</span>
        <span class="n">st_lon</span><span class="p">[</span><span class="n">st_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
        <span class="c1"># winds are converted to 1-min avg</span>
        <span class="n">st_win</span> <span class="o">=</span> <span class="n">st_win</span> <span class="o">/</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;windfac&quot;</span><span class="p">]</span>
        <span class="c1"># plot center data (full NaN variables ommitted)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>

        <span class="c1"># Plot storm data</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">st_lon</span><span class="p">,</span> <span class="n">st_lat</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Storm coordinates&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude (º)&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude (º)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_prs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">st_tim</span><span class="p">,</span> <span class="n">st_prs</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Minimum central pressure [mbar]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_win</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">st_tim</span><span class="p">,</span> <span class="n">st_win</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Maximum sustained winds [kt]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">st_tim</span><span class="p">,</span> <span class="n">st_rmw</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Radii of max winds [nmile]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="c1"># plot attributes</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="filter_track_by_basin">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.filter_track_by_basin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_track_by_basin</span><span class="p">(</span><span class="n">tracks_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">id_basin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter the tracks data by basin.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tracks_data : xr.Dataset</span>
<span class="sd">        The tracks data to filter in IBTrACS format.</span>
<span class="sd">        Must contain a &#39;basin&#39; variable.</span>
<span class="sd">    id_basin : str</span>
<span class="sd">        The basin ID to filter by (e.g., &#39;NA&#39;, &#39;SP&#39;, etc.)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        The filtered tracks data containing only storms from the specified basin</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; sp_tracks = filter_track_by_basin(tracks_data, &quot;SP&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(sp_tracks.storm.size)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: check whether just [0, :] is needed, as it is the only one used</span>
    <span class="k">return</span> <span class="n">tracks_data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span>
        <span class="n">storm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tracks_data</span><span class="o">.</span><span class="n">basin</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="n">id_basin</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="ibtracs_fit_pmin_wmax">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.ibtracs_fit_pmin_wmax">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ibtracs_fit_pmin_wmax</span><span class="p">(</span><span class="n">ibtracs_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate polynomial fit coefficients for pressure-wind relationship.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ibtracs_data : xr.Dataset</span>
<span class="sd">        The IBTrACS dataset containing storm track data. Must include pressure</span>
<span class="sd">        and wind variables for each center.</span>
<span class="sd">    N : int, optional</span>
<span class="sd">        The order of the polynomial fit. Default is 3.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        A dataset containing:</span>
<span class="sd">        - coef_fit : Polynomial coefficients (center, basin, N+1)</span>
<span class="sd">        - pres_data : Pressure data used for fitting</span>
<span class="sd">        - wind_data : Wind data used for fitting</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Maximum wind speeds are converted to 1-min average for all RSMC centers</span>
<span class="sd">    - The polynomial fit is of the form: p = a₀ + a₁w + a₂w² + ... + aₙwⁿ</span>
<span class="sd">      where p is pressure and w is wind speed</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; fit_data = ibtracs_fit_pmin_wmax(ibtracs_data, N=3)</span>
<span class="sd">    &gt;&gt;&gt; print(fit_data.coef_fit.shape)  # (n_centers, n_basins, N+1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">PATHS</span><span class="p">[</span><span class="s2">&quot;SHYTCWAVES_COEFS&quot;</span><span class="p">])</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File could not be opened: </span><span class="si">{</span><span class="n">PATHS</span><span class="p">[</span><span class="s1">&#39;SHYTCWAVES_COEFS&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">coef_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_centers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_basins</span><span class="p">),</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">pres_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_centers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_basins</span><span class="p">),</span> <span class="mi">200000</span><span class="p">))</span>
        <span class="n">wind_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">all_centers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_basins</span><span class="p">),</span> <span class="mi">200000</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">center</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_centers</span><span class="p">):</span>
            <span class="n">center_info</span> <span class="o">=</span> <span class="n">get_center_information</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">basin</span> <span class="ow">in</span> <span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]:</span>
                <span class="c1"># filter tracks data by basin</span>
                <span class="n">filtered_tracks</span> <span class="o">=</span> <span class="n">filter_track_by_basin</span><span class="p">(</span>
                    <span class="n">tracks_data</span><span class="o">=</span><span class="n">ibtracs_data</span><span class="p">,</span> <span class="n">id_basin</span><span class="o">=</span><span class="n">basin</span>
                <span class="p">)</span>
                <span class="c1"># extract and reshape basin data: pressure, wind, landbasin</span>
                <span class="n">newshape</span> <span class="o">=</span> <span class="n">filtered_tracks</span><span class="o">.</span><span class="n">storm</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">filtered_tracks</span><span class="o">.</span><span class="n">date_time</span><span class="o">.</span><span class="n">size</span>
                <span class="n">landbasin</span> <span class="o">=</span> <span class="n">filtered_tracks</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">newshape</span>
                <span class="p">)</span>
                <span class="n">Pbasin</span> <span class="o">=</span> <span class="n">filtered_tracks</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">newshape</span>
                <span class="p">)</span>
                <span class="n">Wbasin</span> <span class="o">=</span> <span class="n">filtered_tracks</span><span class="p">[</span><span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;maxwinds&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">newshape</span>
                <span class="p">)</span>
                <span class="c1"># winds are converted to 1-min avg [kt]</span>
                <span class="n">Wbasin</span> <span class="o">/=</span> <span class="n">center_info</span><span class="p">[</span><span class="s2">&quot;windfac&quot;</span><span class="p">]</span>
                <span class="n">PWbasin_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">Pbasin</span><span class="p">,</span> <span class="n">Wbasin</span><span class="p">,</span> <span class="n">landbasin</span><span class="p">))</span>
                <span class="c1"># index for removing NaNs (including landmask)</span>
                <span class="n">ix_nonan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">PWbasin_s</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">PWbasin_s</span> <span class="o">=</span> <span class="n">PWbasin_s</span><span class="p">[</span><span class="n">ix_nonan</span><span class="p">]</span>
                <span class="c1"># Fitting Polynomial Regression to the dataset</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">PWbasin_s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">PWbasin_s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
                <span class="c1"># store coefficients</span>
                <span class="n">ibasin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">basin</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_basins</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coef_fit</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span> <span class="n">ibasin</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">u</span>
                <span class="n">pres_data</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span> <span class="n">ibasin</span><span class="p">,</span> <span class="p">:</span> <span class="n">PWbasin_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">PWbasin_s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">wind_data</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span> <span class="n">ibasin</span><span class="p">,</span> <span class="p">:</span> <span class="n">PWbasin_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">PWbasin_s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># dataset</span>
        <span class="n">xds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;coef&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;basin&quot;</span><span class="p">,</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">),</span> <span class="n">coef_fit</span><span class="p">),</span>
                <span class="s2">&quot;pres&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;basin&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">),</span> <span class="n">pres_data</span><span class="p">),</span>
                <span class="s2">&quot;wind&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;basin&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">),</span> <span class="n">wind_data</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_centers</span><span class="p">),</span>
                <span class="s2">&quot;basin&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_basins</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">xds</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Fitting polynomial coefficients (Pmin, Wmax)&quot;</span>
        <span class="n">xds</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pressure (mbar), Wind speed (kt, 1-min avg)&quot;</span>

        <span class="k">return</span> <span class="n">xds</span></div>



<div class="viewcode-block" id="get_category">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.get_category">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_category</span><span class="p">(</span><span class="n">ycpres</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate storm category based on central pressure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ycpres : np.ndarray</span>
<span class="sd">        Array of central pressures in millibars (mbar).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Array of storm categories:</span>
<span class="sd">        - 6: Missing data (pressure = 0 or NaN)</span>
<span class="sd">        - 5: Category 5 (pressure &lt; 920 mbar)</span>
<span class="sd">        - 4: Category 4 (920 ≤ pressure &lt; 944 mbar)</span>
<span class="sd">        - 3: Category 3 (944 ≤ pressure &lt; 964 mbar)</span>
<span class="sd">        - 2: Category 2 (964 ≤ pressure &lt; 979 mbar)</span>
<span class="sd">        - 1: Category 1 (979 ≤ pressure &lt; 1000 mbar)</span>
<span class="sd">        - 0: Tropical Storm/Depression (pressure ≥ 1000 mbar)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses np.select for vectorized operations. Categories are based on the</span>
<span class="sd">    Saffir-Simpson Hurricane Wind Scale pressure thresholds.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; pressures = np.array([915, 950, 980, 1005, np.nan])</span>
<span class="sd">    &gt;&gt;&gt; get_category(pressures)</span>
<span class="sd">    array([5, 3, 1, 0, 6])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">&lt;</span> <span class="mi">920</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">&lt;</span> <span class="mi">944</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">&lt;</span> <span class="mi">964</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">&lt;</span> <span class="mi">979</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ycpres</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span></div>



<div class="viewcode-block" id="wind2rmw">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.wind2rmw">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">wind2rmw</span><span class="p">(</span><span class="n">wmax</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">vmean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">latitude</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate radius of maximum winds using Knaff et al. (2016) formula.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wmax : np.ndarray</span>
<span class="sd">        Maximum sustained winds in knots</span>
<span class="sd">    vmean : np.ndarray</span>
<span class="sd">        Mean translational speed in knots</span>
<span class="sd">    latitude : np.ndarray</span>
<span class="sd">        Latitude of the storm center in degrees</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Radius of maximum winds (RMW) in nautical miles</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Implements the Knaff et al. (2016) formula for estimating RMW:</span>
<span class="sd">    1. Subtracts translational speed from observed maximum wind speed</span>
<span class="sd">    2. Converts 10m wind speed to gradient level wind speed using beta factor</span>
<span class="sd">    3. Applies empirical formula accounting for wind speed and latitude</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Knaff, J. A., et al. (2016). &quot;Estimation of Tropical Cyclone Wind Structure</span>
<span class="sd">    Parameters from Satellite Imagery&quot;, Weather and Forecasting.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; rmw = wind2rmw(np.array([100]), np.array([10]), np.array([25]))</span>
<span class="sd">    array([26.51])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pifac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">180</span>  <span class="c1"># pi/180</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># conversion factor of wind speed</span>

    <span class="c1"># Subtract translational speed from observed maximum wind speed</span>
    <span class="n">vkt</span> <span class="o">=</span> <span class="n">wmax</span> <span class="o">-</span> <span class="n">vmean</span>  <span class="c1"># [kt]</span>

    <span class="c1"># Convert 10m wind speed to gradient level wind speed</span>
    <span class="n">vgrad</span> <span class="o">=</span> <span class="n">vkt</span> <span class="o">/</span> <span class="n">beta</span>  <span class="c1"># [kt]</span>

    <span class="c1"># Knaff et al. (2016) formula</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">218.3784</span>
        <span class="o">-</span> <span class="mf">1.2014</span> <span class="o">*</span> <span class="n">vgrad</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">vgrad</span> <span class="o">/</span> <span class="mf">10.9844</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">vgrad</span> <span class="o">/</span> <span class="mf">35.3052</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">-</span> <span class="mf">145.509</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">latitude</span> <span class="o">*</span> <span class="n">pifac</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># [nmile]</span>

    <span class="k">return</span> <span class="n">rm</span></div>



<div class="viewcode-block" id="get_vmean">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.get_vmean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_vmean</span><span class="p">(</span>
    <span class="n">lat1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">lon1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">lat2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">lon2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">deltat</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate storm translation speed and direction between two points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat1 : Union[float, np.ndarray]</span>
<span class="sd">        Latitude of starting point(s) in degrees</span>
<span class="sd">    lon1 : Union[float, np.ndarray]</span>
<span class="sd">        Longitude of starting point(s) in degrees</span>
<span class="sd">    lat2 : Union[float, np.ndarray]</span>
<span class="sd">        Latitude of ending point(s) in degrees</span>
<span class="sd">    lon2 : Union[float, np.ndarray]</span>
<span class="sd">        Longitude of ending point(s) in degrees</span>
<span class="sd">    deltat : Union[float, np.ndarray]</span>
<span class="sd">        Time step(s) in hours</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[Union[float, np.ndarray], Union[float, np.ndarray], Union[float, np.ndarray], Union[float, np.ndarray]]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - gamma_h : Forward direction in degrees from North</span>
<span class="sd">        - vmean : Translation speed in km/h</span>
<span class="sd">        - vu : x-component of translation velocity in km/h</span>
<span class="sd">        - vy : y-component of translation velocity in km/h</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses great circle distance calculation to determine distance between points.</span>
<span class="sd">    Translation speed is calculated by dividing distance by time step.</span>
<span class="sd">    Direction components are calculated using trigonometry.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; gamma, v, vx, vy = get_vmean(0, 0, 0, 1, 6)</span>
<span class="sd">    (270.0, 18.55, 18.55, 5.68e-15)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arcl_h</span><span class="p">,</span> <span class="n">gamma_h</span> <span class="o">=</span> <span class="n">geodesic_distance_azimuth</span><span class="p">(</span><span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">)</span>  <span class="c1"># great circle</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">arcl_h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">EARTH_RADIUS</span>  <span class="c1"># distance between coordinates [km]</span>
    <span class="n">vmean</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">deltat</span>  <span class="c1"># translation speed [km/h]</span>

    <span class="n">vx</span> <span class="o">=</span> <span class="n">vmean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">gamma_h</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">vy</span> <span class="o">=</span> <span class="n">vmean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">gamma_h</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gamma_h</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span>  <span class="c1"># [º], [km/h]</span></div>



<div class="viewcode-block" id="wind2pres">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.wind2pres">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">wind2pres</span><span class="p">(</span>
    <span class="n">xds_coef</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">st_wind</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">st_center</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">st_basin</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert maximum wind speeds to minimum central pressure using fitted coefficients.</span>
<span class="sd">    As many other functions in this module, this works for IBTrACS data for the moment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xds_coef : xr.Dataset</span>
<span class="sd">        Dataset containing polynomial fitting coefficients for Pmin-Wmax relationship.</span>
<span class="sd">    st_wind : np.ndarray</span>
<span class="sd">        Storm maximum winds in knots (1-min average).</span>
<span class="sd">    st_center : str</span>
<span class="sd">        Storm center/agency identifier (e.g., &#39;WMO&#39;, &#39;TOKYO&#39;).</span>
<span class="sd">    st_basin : str</span>
<span class="sd">        Storm basin identifier (e.g., &#39;NA&#39;, &#39;WP&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Predicted minimum central pressure values in millibars</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses polynomial regression coefficients to estimate minimum central pressure</span>
<span class="sd">    from maximum wind speeds. The polynomial is of the form:</span>
<span class="sd">    p = a₀ + a₁w + a₂w² + ... + aₙwⁿ</span>
<span class="sd">    where p is pressure and w is wind speed.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; pres = wind2pres(coef_dataset, np.array([100]), &#39;WMO&#39;, &#39;NA&#39;)</span>
<span class="sd">    array([955.2])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pmin_pred</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">iwind</span> <span class="ow">in</span> <span class="n">st_wind</span><span class="p">:</span>
        <span class="c1"># select Pmin-Wmax coefficients</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">xds_coef</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">st_center</span><span class="p">,</span> <span class="n">basin</span><span class="o">=</span><span class="n">st_basin</span><span class="p">)</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>

        <span class="c1"># aisle equation</span>
        <span class="n">coeff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">iwind</span>

        <span class="c1"># pressure root</span>
        <span class="n">pmin_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">coeff</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">coeff</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pmin_pred</span><span class="p">)</span>  <span class="c1"># [mbar]</span></div>



<div class="viewcode-block" id="resample_storm_6h">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.resample_storm_6h">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resample_storm_6h</span><span class="p">(</span><span class="n">storm</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample storm data to 6-hour intervals.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    storm : xr.Dataset</span>
<span class="sd">        Storm dataset containing time series data with arbitrary time intervals</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Resampled storm dataset with 6-hour intervals</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function:</span>
<span class="sd">    1. Removes NaT (Not a Time) values from time coordinate</span>
<span class="sd">    2. Removes NaN values from WMO pressure data</span>
<span class="sd">    3. Resets lon/lat coordinates</span>
<span class="sd">    4. Resamples all variables to 6-hour intervals using linear interpolation</span>
<span class="sd">    5. Preserves the original basin identifier</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; resampled = resample_storm_6h(storm_data)</span>
<span class="sd">    &gt;&gt;&gt; np.all(np.diff(resampled.time) == np.timedelta64(6, &#39;h&#39;))</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">storm</span> <span class="o">=</span> <span class="n">storm</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">date_time</span><span class="o">=~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">storm</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">storm</span> <span class="o">=</span> <span class="n">storm</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">date_time</span><span class="o">=~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">storm</span><span class="o">.</span><span class="n">wmo_pres</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">storm</span> <span class="o">=</span> <span class="n">storm</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">])</span>
    <span class="n">ibasin</span> <span class="o">=</span> <span class="n">storm</span><span class="o">.</span><span class="n">basin</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">storm</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">storm</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;date_time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;6H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">storm</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;time&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ibasin</span><span class="p">]</span> <span class="o">*</span> <span class="n">storm</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">storm</span></div>



<div class="viewcode-block" id="historic_track_preprocessing">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.historic_track_preprocessing">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">historic_track_preprocessing</span><span class="p">(</span>
    <span class="n">xds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">center</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;WMO&quot;</span><span class="p">,</span>
    <span class="n">forecast_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">database_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">st_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess historical storm track data from IBTrACS or forecast sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xds : xr.Dataset</span>
<span class="sd">        Historical storm track dataset with storm dimension.</span>
<span class="sd">    center : str, optional</span>
<span class="sd">        IBTrACS center code (e.g., &#39;WMO&#39;, &#39;TOKYO&#39;). Default is &quot;WMO&quot;.</span>
<span class="sd">    forecast_on : bool, optional</span>
<span class="sd">        Whether track is forecasted (not IBTrACS). Default is False.</span>
<span class="sd">    database_on : bool, optional</span>
<span class="sd">        Whether to keep data only at 0,6,12,18 hours. Default is False.</span>
<span class="sd">    st_param : bool, optional</span>
<span class="sd">        Whether to keep data as original. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Preprocessed storm track data with columns:</span>
<span class="sd">        - center : Storm center identifier</span>
<span class="sd">        - basin : Storm basin identifier</span>
<span class="sd">        - dist2land : Distance to nearest land (km)</span>
<span class="sd">        - longitude : Storm longitude (0-360°)</span>
<span class="sd">        - latitude : Storm latitude</span>
<span class="sd">        - move : Forward direction (degrees)</span>
<span class="sd">        - mean_velocity : Translation speed (kt)</span>
<span class="sd">        - pressure : Central pressure (mbar)</span>
<span class="sd">        - maxwinds : Maximum winds (kt, 1-min avg)</span>
<span class="sd">        - rmw : Radius of maximum winds (nmile)</span>
<span class="sd">        - category : Storm category (0-6)</span>
<span class="sd">        - timestep : Time step (hours)</span>
<span class="sd">        - storm_vmean : Mean translation speed (kt)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Processing steps include:</span>
<span class="sd">    1. Removing NaT/NaN values from time and pressure data</span>
<span class="sd">    2. Converting longitudes to [0°-360°] convention</span>
<span class="sd">    3. Rounding dates to nearest hour</span>
<span class="sd">    4. Calculating translation speed and direction</span>
<span class="sd">    5. Converting wind speeds to 1-min average</span>
<span class="sd">    6. Determining storm category based on pressure</span>

<span class="sd">    For forecast tracks:</span>
<span class="sd">    - Basin IDs are converted to IBTrACS equivalents</span>
<span class="sd">    - Missing pressures are estimated from wind speeds using fitted coefficients</span>
<span class="sd">    - Southern hemisphere basins are determined by latitude and longitude</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = historic_track_preprocessing(track_data, center=&#39;WMO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Track duration: {len(df)} time steps&quot;)</span>
<span class="sd">    Track duration: 48</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Storm category: {df[&#39;category&#39;].iloc[0]}&quot;)</span>
<span class="sd">    Storm category: 3</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># dictionary for IBTrACS center</span>
    <span class="n">d_vns</span> <span class="o">=</span> <span class="n">get_center_information</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>

    <span class="c1"># get names of variables</span>
    <span class="n">nm_tim</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
    <span class="n">nm_bas</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]</span>
    <span class="n">nm_lon</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span>
    <span class="n">nm_lat</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span>
    <span class="n">nm_prs</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
    <span class="n">nm_win</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;maxwinds&quot;</span><span class="p">]</span>
    <span class="n">nm_rmw</span> <span class="o">=</span> <span class="n">d_vns</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span>

    <span class="c1"># get var time</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_tim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># dates format: datetime64</span>

    <span class="c1"># remove NaTs (time)</span>
    <span class="n">ydist</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># distance to land [km]</span>
    <span class="n">ybasin</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_bas</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># basin</span>
    <span class="n">ylat_tc</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_lat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># latitude</span>
    <span class="n">ylon_tc</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_lon</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># longitude</span>
    <span class="n">ycpres</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_prs</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># pressure [mbar]</span>
    <span class="n">ywind</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_win</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># wind speed [kt]</span>
    <span class="k">if</span> <span class="n">nm_rmw</span><span class="p">:</span>
        <span class="n">yradii</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_rmw</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># rmw [nmile]</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>

    <span class="c1"># remove common NaNs (pressure &amp; wind)</span>
    <span class="n">posnonan_p_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ywind</span><span class="p">))))</span>
    <span class="p">)</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">ydist</span> <span class="o">=</span> <span class="n">ydist</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">ybasin</span> <span class="o">=</span> <span class="n">ybasin</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">ylat_tc</span> <span class="o">=</span> <span class="n">ylat_tc</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">ylon_tc</span> <span class="o">=</span> <span class="n">ylon_tc</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">ycpres</span> <span class="o">=</span> <span class="n">ycpres</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">ywind</span> <span class="o">=</span> <span class="n">ywind</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nm_rmw</span><span class="p">:</span>
        <span class="n">yradii</span> <span class="o">=</span> <span class="n">yradii</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nm_rmw</span><span class="p">:</span>
        <span class="n">yradii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ycpres</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># [np.nan] * ycpres.size</span>

    <span class="c1">###########################################################################</span>
    <span class="c1"># forecast input may lack pressure</span>
    <span class="k">if</span> <span class="n">forecast_on</span><span class="p">:</span>
        <span class="c1"># convert basin ids (IBTrACS equivalent)</span>
        <span class="n">dict_basin_forecast</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AL&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LS&quot;</span><span class="p">:</span> <span class="s2">&quot;SA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EP&quot;</span><span class="p">:</span> <span class="s2">&quot;EP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CP&quot;</span><span class="p">:</span> <span class="s2">&quot;WP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WP&quot;</span><span class="p">:</span> <span class="s2">&quot;WP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SH&quot;</span><span class="p">:</span> <span class="s2">&quot;SP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IO&quot;</span><span class="p">:</span> <span class="s2">&quot;NI&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ybasin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dict_basin_forecast</span><span class="p">[</span><span class="n">ybas</span><span class="p">]</span> <span class="k">for</span> <span class="n">ybas</span> <span class="ow">in</span> <span class="n">ybasin</span><span class="p">])</span>
        <span class="n">ybasin</span><span class="p">[(</span><span class="n">ylat_tc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ylon_tc</span> <span class="o">&lt;</span> <span class="mi">135</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;SI&quot;</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># ibtracs fitting coefficients path</span>
            <span class="n">xds_coef</span> <span class="o">=</span> <span class="n">ibtracs_fit_pmin_wmax</span><span class="p">()</span>

            <span class="c1"># fill pressure gaps</span>
            <span class="n">ycpres</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span> <span class="o">=</span> <span class="n">wind2pres</span><span class="p">(</span>
                <span class="n">xds_coef</span><span class="p">,</span> <span class="n">ywind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)],</span> <span class="n">center</span><span class="p">,</span> <span class="n">ybasin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">ybasin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">(</span><span class="n">ybas</span><span class="p">)</span> <span class="k">for</span> <span class="n">ybas</span> <span class="ow">in</span> <span class="n">ybasin</span><span class="p">])</span>
    <span class="c1">###########################################################################</span>

    <span class="c1"># remove NaNs (pressure)</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="n">st_dist2land</span> <span class="o">=</span> <span class="n">ydist</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="n">ybasin</span> <span class="o">=</span> <span class="n">ybasin</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="n">st_lat</span> <span class="o">=</span> <span class="n">ylat_tc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="n">st_lon</span> <span class="o">=</span> <span class="n">ylon_tc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="n">st_pres</span> <span class="o">=</span> <span class="n">ycpres</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="n">st_wind</span> <span class="o">=</span> <span class="n">ywind</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">nm_rmw</span><span class="p">:</span>
        <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">yradii</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nm_rmw</span><span class="p">:</span>
        <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">st_pres</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># [np.nan] * st_pres.size</span>

    <span class="c1"># conflicting times</span>
    <span class="n">dft</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">ytime</span><span class="p">})</span>
    <span class="n">dft</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dft</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="n">dft</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># duplicate times</span>
    <span class="n">pos_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># keep 0,3,6,9,12,15,18 hours (remove in between data)</span>
    <span class="c1"># TODO: option to interpolate to fixed target hours</span>
    <span class="k">if</span> <span class="n">database_on</span><span class="p">:</span>
        <span class="n">pos_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">18</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">18</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">hr</span> <span class="o">==</span> <span class="mi">21</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># for parameterized tracks hours can be random</span>
    <span class="k">if</span> <span class="n">st_param</span><span class="p">:</span>
        <span class="n">pos_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># remove duplicates</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">pos_in</span><span class="p">,</span> <span class="n">pos_out</span><span class="p">)</span>  <span class="c1"># pos_in[pos_in != pos_out].ravel()</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">st_dist2land</span> <span class="o">=</span> <span class="n">st_dist2land</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">ybasin</span> <span class="o">=</span> <span class="n">ybasin</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">st_lat</span> <span class="o">=</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">st_lon</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">st_pres</span> <span class="o">=</span> <span class="n">st_pres</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">st_wind</span> <span class="o">=</span> <span class="n">st_wind</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">st_rmw</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>

    <span class="c1"># only when storm data available</span>
    <span class="k">if</span> <span class="n">st_pres</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># longitude convention: [0º,360º]</span>
        <span class="n">st_lon</span><span class="p">[</span><span class="n">st_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">st_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>

        <span class="c1"># round dates to hour ---&gt; half hour</span>
        <span class="n">round_to</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">st_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ytime</span><span class="p">)):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[s]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">min</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
            <span class="n">rounding</span> <span class="o">=</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">round_to</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="n">round_to</span> <span class="o">*</span> <span class="n">round_to</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rounding</span> <span class="o">-</span> <span class="n">seconds</span><span class="p">,</span> <span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
            <span class="n">st_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">st_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">st_time</span><span class="p">)</span>

        <span class="c1"># storm coordinates timestep [hours]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">st_time</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">st_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># calculate Vmean</span>
        <span class="n">st_vmean</span><span class="p">,</span> <span class="n">st_move</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># consecutive storm coordinates</span>
            <span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># translation speed</span>
            <span class="n">gamma_h</span><span class="p">,</span> <span class="n">vel_mean</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_vmean</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">st_vmean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vel_mean</span> <span class="o">/</span> <span class="mf">1.852</span><span class="p">)</span>  <span class="c1"># translation speed [km/h to kt]</span>
            <span class="n">st_move</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma_h</span><span class="p">)</span>  <span class="c1"># forward direction [º]</span>
        <span class="n">st_vmean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">st_move</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># mean value</span>
        <span class="n">vmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">st_vmean</span><span class="p">)</span>  <span class="c1"># [kt]</span>

        <span class="c1"># storm category</span>
        <span class="n">categ</span> <span class="o">=</span> <span class="n">get_category</span><span class="p">(</span><span class="n">st_pres</span><span class="p">)</span>

        <span class="c1"># convert (X)-min to 1-min avg winds (depends on center)</span>
        <span class="n">st_wind</span> <span class="o">=</span> <span class="n">st_wind</span> <span class="o">/</span> <span class="n">centers_config_params</span><span class="p">[</span><span class="n">center</span><span class="p">][</span><span class="s2">&quot;windfac&quot;</span><span class="p">]</span>

        <span class="c1"># get basin string</span>
        <span class="n">st_basin</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ybasin</span><span class="p">]</span>

        <span class="c1"># store storm variables</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">st_time</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="s2">&quot;basin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dist2land&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;move&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mean_velocity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pressure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxwinds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rmw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;storm_vmean&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_basin</span>
        <span class="k">if</span> <span class="s2">&quot;dist2land&quot;</span> <span class="ow">in</span> <span class="n">xds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_dist2land</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_lon</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_lat</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_move</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mean_velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_vmean</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_pres</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;maxwinds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_wind</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_rmw</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categ</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;storm_vmean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmean</span>

        <span class="n">df</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dist2land&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
            <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="s2">&quot;kt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="s2">&quot;mbar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;maxwinds&quot;</span><span class="p">:</span> <span class="s2">&quot;kt, 1-min average sustained winds (converted from X-min)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rmw&quot;</span><span class="p">:</span> <span class="s2">&quot;nmile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="s2">&quot;hour&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="s2">&quot;basin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dist2land&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;move&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mean_velocity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pressure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxwinds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rmw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;storm_vmean&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="historic_track_interpolation">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.historic_track_interpolation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">historic_track_interpolation</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dt_comp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">great_circle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">wind_estimate_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
    <span class="n">radi_estimate_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolate storm track variables to computational time steps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Storm track DataFrame with historical data.</span>
<span class="sd">    dt_comp : float</span>
<span class="sd">        Computation time step in minutes.</span>
<span class="sd">    y0 : float, optional</span>
<span class="sd">        Target latitude coordinate. Default is None.</span>
<span class="sd">    x0 : float, optional</span>
<span class="sd">        Target longitude coordinate. Default is None.</span>
<span class="sd">    great_circle : bool, optional</span>
<span class="sd">        Whether to use great circle distances. Default is True.</span>
<span class="sd">    wind_estimate_on : bool, optional</span>
<span class="sd">        Whether to use empirical estimates instead of historical winds. Default is False.</span>
<span class="sd">    fit : bool, optional</span>
<span class="sd">        Whether to estimate winds when wind=0. Default is False.</span>
<span class="sd">    interpolation : bool, optional</span>
<span class="sd">        Whether to interpolate storm variables. Default is True.</span>
<span class="sd">    mode : str, optional</span>
<span class="sd">        Value selection for constant segments (&#39;first&#39; or &#39;mean&#39;). Default is &quot;first&quot;.</span>
<span class="sd">    radi_estimate_on : bool, optional</span>
<span class="sd">        Whether to estimate missing RMW values. Default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[pd.DataFrame, np.ndarray]</span>
<span class="sd">        - DataFrame with interpolated storm track variables.</span>
<span class="sd">        - Array of interpolated time coordinates.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Interpolates track points to match computational time step</span>
<span class="sd">    2. Estimates missing values using empirical relationships:</span>
<span class="sd">        - Maximum winds from pressure (Pmin-Wmax relationship)</span>
<span class="sd">        - Radius of maximum winds (Knaff et al. 2016)</span>
<span class="sd">    3. Can use either linear interpolation or constant segments</span>
<span class="sd">    4. Preserves metadata and adds computational parameters</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; st, times = historic_track_interpolation(track_data, dt_comp=30)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Interpolated points: {len(st)}&quot;)</span>
<span class="sd">    Interpolated points: 144</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># historic storm variables</span>
    <span class="n">st_time</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># datetime format</span>
    <span class="n">st_center</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">st_basin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>
    <span class="n">st_dist2land</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># [km]</span>
    <span class="n">st_lon</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>
    <span class="n">st_lat</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>
    <span class="n">st_vmean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mean_velocity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># [kt]</span>
    <span class="n">st_pres</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># [mbar]</span>
    <span class="n">st_wind</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;maxwinds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># [kt, 1-min avg]</span>
    <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># [nmile]</span>
    <span class="n">st_step</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>  <span class="c1"># [hour]</span>
    <span class="n">wind_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">st_pres</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">rmw_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">st_pres</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># select Pmin-Wmax polynomial fitting coefficients (IBTrACS center,basin)</span>
    <span class="n">xds_coef</span> <span class="o">=</span> <span class="n">ibtracs_fit_pmin_wmax</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">xds_coef</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="n">st_center</span><span class="p">,</span>
            <span class="n">basin</span><span class="o">=</span><span class="n">st_basin</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">xds_coef</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="n">st_center</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
            <span class="n">basin</span><span class="o">=</span><span class="n">st_basin</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;bytes&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>

    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coefs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coefs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">coefs</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">wind_estimate</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">p1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">st_pres</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">st_pres</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">st_pres</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p4</span>
    <span class="p">)</span>

    <span class="c1"># maxwinds gaps filled with Pmin-Wmax coefficients</span>
    <span class="n">posnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_wind</span><span class="p">))</span>  <span class="c1"># np.where(st_wind==np.nan)[0]</span>
    <span class="n">poszero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">st_wind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_wind</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="n">wind_estimate_on</span><span class="p">:</span>  <span class="c1"># wind NOT provided</span>
        <span class="n">wind_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">st_wind</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">st_wind</span> <span class="o">=</span> <span class="n">wind_estimate</span>
    <span class="c1">###########################################################################</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_wind</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># wind with some NaNs</span>
        <span class="k">if</span> <span class="n">fit</span> <span class="ow">and</span> <span class="n">posnan</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># data filled (for wind=0)</span>
            <span class="n">wind_fill</span><span class="p">[</span><span class="n">posnan</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">st_wind</span><span class="p">[</span><span class="n">posnan</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_estimate</span><span class="p">[</span><span class="n">posnan</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">fit</span> <span class="ow">and</span> <span class="n">poszero</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># wind provided</span>
        <span class="n">wind_fill</span><span class="p">[</span><span class="n">poszero</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">st_wind</span><span class="p">[</span><span class="n">poszero</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_estimate</span><span class="p">[</span><span class="n">poszero</span><span class="p">]</span>
    <span class="c1">###########################################################################</span>
    <span class="c1">#    else:                                             # wind provided</span>
    <span class="c1">#        pos = np.where(st_wind==0)[0]</span>
    <span class="c1">#        if fit and pos.size&gt;0:    # data filled (for wind=0)</span>
    <span class="c1">#            wind_fill[pos] = True</span>
    <span class="c1">#            st_wind[pos]   = wind_estimate[pos]</span>

    <span class="c1"># radii of maximum winds gaps filled with Knaff et al. (2016) estimate</span>
    <span class="n">rmw_estimate</span> <span class="o">=</span> <span class="n">wind2rmw</span><span class="p">(</span><span class="n">st_wind</span><span class="p">,</span> <span class="n">st_vmean</span><span class="p">,</span> <span class="n">st_lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">radi_estimate_on</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>  <span class="c1"># all</span>
            <span class="n">rmw_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">rmw_estimate</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">rmw_estimate</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># some</span>
            <span class="n">rmw_fill</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">st_rmw</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rmw_estimate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rmw</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># storm variables (original values or mean values)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">st_pres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">st_pres</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_pres</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">st_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">st_wind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_wind</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">st_rmw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">st_rmw</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># number of time steps between consecutive interpolated storm coordinates</span>
    <span class="c1"># to match SWAN computational timestep</span>
    <span class="n">ts_h</span> <span class="o">=</span> <span class="n">st_step</span>  <span class="c1"># hours</span>
    <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">st_step</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">dt_comp</span>  <span class="c1"># number of intervals</span>

    <span class="c1"># initialize interpolated variables</span>
    <span class="n">bas</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">move</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">vu</span><span class="p">,</span> <span class="n">vy</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">p0</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">rmw</span><span class="p">,</span> <span class="n">vmaxfill</span><span class="p">,</span> <span class="n">rmwfill</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">time_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># time array for SWAN input</span>
        <span class="n">date_ini</span> <span class="o">=</span> <span class="n">st_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">time_input0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">date_ini</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">min&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt_comp</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">time_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_input</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_input0</span><span class="p">))</span>

        <span class="c1"># consecutive storm coordinates</span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># translation speed</span>
        <span class="n">arcl_h</span><span class="p">,</span> <span class="n">gamma_h</span> <span class="o">=</span> <span class="n">geodesic_distance_azimuth</span><span class="p">(</span><span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">arcl_h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">EARTH_RADIUS</span>  <span class="c1"># distance between coordinates [km]</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># distance during time step [km]</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">ts_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># time period during time step [h]</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">tx</span> <span class="o">/</span> <span class="mf">3.6</span>  <span class="c1"># translation speed [km/h to m/s]</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">vx</span> <span class="o">/</span> <span class="mf">0.5144</span>  <span class="c1"># translation speed [m/s to kt]</span>

        <span class="c1"># interpolate at timesteps</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">bas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_basin</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_dist2land</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># append interpolated lon, lat</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">great_circle</span><span class="p">:</span>
                <span class="n">glon</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">lon1</span>
                    <span class="o">-</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="p">(</span><span class="n">EARTH_RADIUS</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma_h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">j</span>
                <span class="p">)</span>
                <span class="n">glat</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">lat1</span>
                    <span class="o">-</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="p">(</span><span class="n">EARTH_RADIUS</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma_h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">j</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">glon</span><span class="p">,</span> <span class="n">glat</span><span class="p">,</span> <span class="n">baz</span> <span class="o">=</span> <span class="n">shoot</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">gamma_h</span> <span class="o">+</span> <span class="mi">180</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glon</span><span class="p">)</span>
            <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glat</span><span class="p">)</span>

            <span class="c1"># append storm track parameters</span>
            <span class="n">move</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma_h</span><span class="p">)</span>
            <span class="n">vmean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>
            <span class="n">vu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">gamma_h</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span>
            <span class="n">vy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">gamma_h</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span>

            <span class="c1"># append pmin, wind, rmw (interpolated/constant)</span>
            <span class="k">if</span> <span class="n">interpolation</span><span class="p">:</span>
                <span class="n">p0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_pres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">st_pres</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">st_pres</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vmax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_wind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">st_wind</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">st_wind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">rmw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">st_rmw</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">st_rmw</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">nts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vmaxfill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wind_fill</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">wind_fill</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">rmwfill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmw_fill</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rmw_fill</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_pres</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vmax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_wind</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">rmw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_rmw</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">vmaxfill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wind_fill</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">rmwfill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmw_fill</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># longitude convention [0º,360º]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">lon</span><span class="p">[</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>

    <span class="c1"># method attribute</span>
    <span class="n">n_hour</span> <span class="o">=</span> <span class="n">dt_comp</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="k">if</span> <span class="n">interpolation</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;interpolation (</span><span class="si">{0}</span><span class="s2">h)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_hour</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;segment (</span><span class="si">{0}</span><span class="s2">h, mean value)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_hour</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;segment (</span><span class="si">{0}</span><span class="s2">h, node value)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_hour</span><span class="p">)</span>

    <span class="c1"># storm track (pd.DataFrame)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">time_input</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="s2">&quot;basin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dist2land&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vfx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vfy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;p0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vmax&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rmw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vmaxfill&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rmwfill&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_center</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bas</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>  <span class="c1"># distance to nearest land [km]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>  <span class="c1"># longitude coordinate</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>  <span class="c1"># latitude coordinate</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">move</span>  <span class="c1"># gamma, forward direction</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmean</span>  <span class="c1"># translational speed [kt]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vfx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vu</span>  <span class="c1"># x-component</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vfy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vy</span>  <span class="c1"># y-component</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;pn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1013</span>  <span class="c1"># average pressure at the surface [mbar]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;p0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p0</span>  <span class="c1"># minimum central pressure [mbar]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>  <span class="c1"># maximum winds [kt, 1-min avg]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmw</span>  <span class="c1"># radii of maximum winds [nmile]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vmaxfill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmaxfill</span>  <span class="c1"># True if maxwinds filled with Pmin-Vmax</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;rmwfill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmwfill</span>  <span class="c1"># True if radii filled with Knaff 2016</span>

    <span class="c1"># add metadata</span>
    <span class="n">st</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
        <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="n">st_center</span><span class="p">,</span>
        <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vf&quot;</span><span class="p">:</span> <span class="s2">&quot;kt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;p0&quot;</span><span class="p">:</span> <span class="s2">&quot;mbar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="s2">&quot;kt, 1-min avg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rmw&quot;</span><span class="p">:</span> <span class="s2">&quot;nmile&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="n">x0</span><span class="p">,</span>
        <span class="s2">&quot;y0&quot;</span><span class="p">:</span> <span class="n">y0</span><span class="p">,</span>
        <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">st</span><span class="p">,</span> <span class="n">time_input</span></div>



<div class="viewcode-block" id="track_triming">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.track_triming">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">track_triming</span><span class="p">(</span>
    <span class="n">st</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lat00</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lon00</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lat01</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lon01</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trim storm track to specified geographical bounds.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    st : pd.DataFrame</span>
<span class="sd">        Storm track DataFrame containing time series data.</span>
<span class="sd">    lat00 : float</span>
<span class="sd">        Southern latitude bound in degrees.</span>
<span class="sd">    lon00 : float</span>
<span class="sd">        Western longitude bound in degrees.</span>
<span class="sd">    lat01 : float</span>
<span class="sd">        Northern latitude bound in degrees.</span>
<span class="sd">    lon01 : float</span>
<span class="sd">        Eastern longitude bound in degrees.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Trimmed storm track containing only points within the specified bounds</span>
<span class="sd">        and preserving continuous time segments.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Identifies all track points within the specified bounds</span>
<span class="sd">    2. Finds the earliest and latest times for points within bounds</span>
<span class="sd">    3. Returns all track points between these times to maintain continuity</span>
<span class="sd">    4. Preserves original metadata in the returned DataFrame</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; trimmed = track_triming(track_data, 20, -80, 30, -60)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Points in bounds: {len(trimmed)}&quot;)</span>
<span class="sd">    Points in bounds: 24</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lo</span><span class="p">,</span> <span class="n">la</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">[:],</span> <span class="n">st</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>

    <span class="c1"># select track coordinates within the target domain area</span>
    <span class="n">st_trim</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">iloc</span><span class="p">[(</span><span class="n">lo</span> <span class="o">&lt;=</span> <span class="n">lon01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;=</span> <span class="n">lon00</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">la</span> <span class="o">&lt;=</span> <span class="n">lat01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">la</span> <span class="o">&gt;=</span> <span class="n">lat00</span><span class="p">)]</span>

    <span class="c1"># get min/max times within the area</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">st_trim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">st_trim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># select all the time window</span>
    <span class="n">st_trim</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">iloc</span><span class="p">[(</span><span class="n">st</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)]</span>

    <span class="c1"># add metadata</span>
    <span class="n">st_trim</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">attrs</span>

    <span class="k">return</span> <span class="n">st_trim</span></div>



<div class="viewcode-block" id="track_triming_circle">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.track_triming_circle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">track_triming_circle</span><span class="p">(</span>
    <span class="n">st</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">plon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">plat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radii</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trim storm track to points within a circular domain.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    st : pd.DataFrame</span>
<span class="sd">        Storm track DataFrame containing time series data.</span>
<span class="sd">    plon : float</span>
<span class="sd">        Longitude of circle center in degrees.</span>
<span class="sd">    plat : float</span>
<span class="sd">        Latitude of circle center in degrees.</span>
<span class="sd">    radii : float</span>
<span class="sd">        Radius of circular domain in degrees.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Trimmed storm track containing only points within the circular domain</span>
<span class="sd">        and preserving continuous time segments.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Calculates geodesic distance from each track point to circle center</span>
<span class="sd">    2. Identifies points within the specified radius</span>
<span class="sd">    3. Returns continuous time segment containing all points within radius</span>
<span class="sd">    4. Preserves original metadata in the returned DataFrame</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; trimmed = track_triming_circle(track_data, -75, 25, 5)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Points in circle: {len(trimmed)}&quot;)</span>
<span class="sd">    Points in circle: 18</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lo</span><span class="p">,</span> <span class="n">la</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">[:],</span> <span class="n">st</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>

    <span class="c1"># stack storm longitude, latitude</span>
    <span class="n">lonlat_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">lo</span><span class="p">,</span> <span class="n">la</span><span class="p">))</span>

    <span class="c1"># calculate geodesic distance (degree)</span>
    <span class="n">geo_dist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lon_ps</span><span class="p">,</span> <span class="n">lat_ps</span> <span class="ow">in</span> <span class="n">lonlat_s</span><span class="p">:</span>
        <span class="n">geo_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geodesic_distance</span><span class="p">(</span><span class="n">lat_ps</span><span class="p">,</span> <span class="n">lon_ps</span><span class="p">,</span> <span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">))</span>
    <span class="n">geo_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">geo_dist</span><span class="p">)</span>

    <span class="c1"># find storm inside circle and calculate parameters</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">geo_dist</span> <span class="o">&lt;</span> <span class="n">radii</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">geo_dist</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># storm inside circle</span>
        <span class="n">ix_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">geo_dist</span> <span class="o">&lt;</span> <span class="n">radii</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:]</span>
        <span class="c1"># select track coordinates within the target domain area</span>
        <span class="n">st_trim</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ix_in</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">st_trim</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">]</span>

    <span class="c1"># get min/max times within the area</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">st_trim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">st_trim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># select all the time window</span>
    <span class="n">st_trim</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">iloc</span><span class="p">[(</span><span class="n">st</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)]</span>

    <span class="c1"># add metadata</span>
    <span class="n">st_trim</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">attrs</span>

    <span class="k">return</span> <span class="n">st_trim</span></div>



<div class="viewcode-block" id="stopmotion_trim_circle">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.stopmotion_trim_circle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stopmotion_trim_circle</span><span class="p">(</span>
    <span class="n">df_seg</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">plon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">plat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radii</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trim storm track segments to those intersecting a circular domain.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_seg : pd.DataFrame</span>
<span class="sd">        DataFrame containing storm track segments with start/end coordinates.</span>
<span class="sd">    plon : float</span>
<span class="sd">        Longitude of circle center in degrees.</span>
<span class="sd">    plat : float</span>
<span class="sd">        Latitude of circle center in degrees.</span>
<span class="sd">    radii : float</span>
<span class="sd">        Radius of circular domain in degrees.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Trimmed DataFrame containing only segments that intersect the circular domain.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Calculates geodesic distances from both endpoints of each segment to circle center</span>
<span class="sd">    2. Takes minimum distance to determine if segment intersects circle</span>
<span class="sd">    3. Returns continuous time segment containing all intersecting segments</span>
<span class="sd">    4. Preserves original metadata in the returned DataFrame</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; trimmed = stopmotion_trim_circle(segments, -75, 25, 5)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Segments intersecting circle: {len(trimmed)}&quot;)</span>
<span class="sd">    Segments intersecting circle: 8</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lo0</span><span class="p">,</span> <span class="n">la0</span> <span class="o">=</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">lon_i</span><span class="o">.</span><span class="n">values</span><span class="p">[:],</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">lat_i</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>
    <span class="n">lo1</span><span class="p">,</span> <span class="n">la1</span> <span class="o">=</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">lon_t</span><span class="o">.</span><span class="n">values</span><span class="p">[:],</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">lat_t</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>

    <span class="c1"># stack storm longitude, latitude</span>
    <span class="n">lonlat_s0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">lo0</span><span class="p">,</span> <span class="n">la0</span><span class="p">))</span>
    <span class="n">lonlat_s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">lo1</span><span class="p">,</span> <span class="n">la1</span><span class="p">))</span>

    <span class="c1"># calculate geodesic distance (degree)</span>
    <span class="n">geo_dist0</span><span class="p">,</span> <span class="n">geo_dist1</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lon_ps</span><span class="p">,</span> <span class="n">lat_ps</span> <span class="ow">in</span> <span class="n">lonlat_s0</span><span class="p">:</span>
        <span class="n">geo_dist0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geodesic_distance</span><span class="p">(</span><span class="n">lat_ps</span><span class="p">,</span> <span class="n">lon_ps</span><span class="p">,</span> <span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">))</span>
    <span class="n">geo_dist0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">geo_dist0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lon_ps</span><span class="p">,</span> <span class="n">lat_ps</span> <span class="ow">in</span> <span class="n">lonlat_s1</span><span class="p">:</span>
        <span class="n">geo_dist1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geodesic_distance</span><span class="p">(</span><span class="n">lat_ps</span><span class="p">,</span> <span class="n">lon_ps</span><span class="p">,</span> <span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">))</span>
    <span class="n">geo_dist1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">geo_dist1</span><span class="p">)</span>

    <span class="c1"># get minimum distance of the two target endpoints</span>
    <span class="n">geo_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">geo_dist0</span><span class="p">,</span> <span class="n">geo_dist1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># find storm inside circle and calculate parameters</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">geo_dist</span> <span class="o">&lt;</span> <span class="n">radii</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">geo_dist</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># storm inside circle</span>
        <span class="n">ix_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">geo_dist</span> <span class="o">&lt;</span> <span class="n">radii</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:]</span>
        <span class="c1"># select track coordinates within the target domain area</span>
        <span class="n">st_trim</span> <span class="o">=</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ix_in</span><span class="p">]</span>

        <span class="c1"># get min/max times within the area</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">st_trim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">st_trim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># select all the time window</span>
        <span class="n">st_trim</span> <span class="o">=</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[(</span><span class="n">df_seg</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_seg</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">)]</span>

        <span class="c1"># add metadata</span>
        <span class="n">st_trim</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">df_seg</span><span class="o">.</span><span class="n">attrs</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># empty dataframe</span>
        <span class="n">st_trim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df_seg</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">st_trim</span></div>



<div class="viewcode-block" id="track_extent">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.track_extent">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">track_extent</span><span class="p">(</span>
    <span class="n">st</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">time_input</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">dt_comp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">time_extent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">48.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extend storm track data for wave propagation analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    st : pd.DataFrame</span>
<span class="sd">        Storm track DataFrame containing time series data.</span>
<span class="sd">    time_input : np.ndarray</span>
<span class="sd">        Array of time coordinates.</span>
<span class="sd">    dt_comp : float</span>
<span class="sd">        Computational time step in minutes.</span>
<span class="sd">    time_extent : float, optional</span>
<span class="sd">        Additional time to extend simulation in hours. Default is 48.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[pd.DataFrame, pd.DataFrame]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - st_new : Extended storm track DataFrame.</span>
<span class="sd">        - we : Wave event DataFrame with empty fields for wave parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Calculates total simulation period (storm + propagation)</span>
<span class="sd">    2. Creates extended time array with specified time step</span>
<span class="sd">    3. Fills storm data in initial period</span>
<span class="sd">    4. Creates empty wave event DataFrame for entire period</span>
<span class="sd">    5. Preserves metadata and adds computational time step override</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; st_ext, wave_evt = track_extent(track_data, times, 30, time_extent=24)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Extended duration: {len(st_ext)} time steps&quot;)</span>
<span class="sd">    Extended duration: 96 time steps</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># total simulation period (hours): storm + propagation</span>
    <span class="n">time_storm</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
        <span class="s2">&quot;timedelta64[h]&quot;</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">time_storm</span> <span class="o">+</span> <span class="n">time_extent</span>

    <span class="c1"># original track period</span>
    <span class="n">size_ini</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>
    <span class="n">date_ini</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># total simulation period</span>
    <span class="n">size_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">dt_comp</span><span class="p">)</span>
    <span class="n">time_input_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">date_ini</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">size_new</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">MIN&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt_comp</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">st_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">time_input_new</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1"># combine</span>
    <span class="n">st_new</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="n">size_ini</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]:</span>
        <span class="n">st_new</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;y0&quot;</span><span class="p">]:</span>
        <span class="n">st_new</span><span class="o">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;y0&quot;</span><span class="p">]</span>

    <span class="c1"># [OPTIONAL] override SWAN storm case computational delta time</span>
    <span class="n">st_new</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;override_dtcomp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">MIN&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt_comp</span><span class="p">)</span>

    <span class="c1"># generate wave event (empty)</span>
    <span class="n">we</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">time_input_new</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hs&quot;</span><span class="p">,</span> <span class="s2">&quot;t02&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;spr&quot;</span><span class="p">,</span> <span class="s2">&quot;U10&quot;</span><span class="p">,</span> <span class="s2">&quot;V10&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">we</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">we</span><span class="p">[</span><span class="s2">&quot;tide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">st_new</span><span class="p">,</span> <span class="n">we</span></div>



<span class="c1">###############################################################################</span>
<span class="c1"># HYTCWAVES</span>
<span class="c1"># PARAMETERIZED storm tracks</span>
<span class="c1"># Given the storm parameters (HyTCWaves methodology) the track coordinates are</span>
<span class="c1"># calculated at each swan computational timestep</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="entrance_coords">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.entrance_coords">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">entrance_coords</span><span class="p">(</span>
    <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">R</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lon0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lon1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lat0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lat1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate storm entrance coordinates at computational domain boundary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delta : float</span>
<span class="sd">        Storm track angle parameter in degrees.</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Storm forward direction in degrees.</span>
<span class="sd">    x0 : float</span>
<span class="sd">        Site longitude coordinate in degrees.</span>
<span class="sd">    y0 : float</span>
<span class="sd">        Site latitude coordinate in degrees.</span>
<span class="sd">    R : float</span>
<span class="sd">        Radius of influence in degrees.</span>
<span class="sd">    lon0 : float</span>
<span class="sd">        Western longitude bound of computational domain.</span>
<span class="sd">    lon1 : float</span>
<span class="sd">        Eastern longitude bound of computational domain.</span>
<span class="sd">    lat0 : float</span>
<span class="sd">        Southern latitude bound of computational domain.</span>
<span class="sd">    lat1 : float</span>
<span class="sd">        Northern latitude bound of computational domain.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[float, float]</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">        - x1 : Entrance longitude coordinate in degrees.</span>
<span class="sd">        - y1 : Entrance latitude coordinate in degrees.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Calculates entrance point on the radius of influence</span>
<span class="sd">    2. Determines angles to domain corners from entrance point</span>
<span class="sd">    3. Uses storm direction to determine intersection with domain boundary</span>
<span class="sd">    4. Returns coordinates where storm track enters computational domain</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; x1, y1 = entrance_coords(45, 270, -75, 25, 5, -80, -70, 20, 30)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Entrance point: ({x1:.1f}°, {y1:.1f}°)&quot;)</span>
<span class="sd">    Entrance point: (-78.5°, 27.5°)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># enter point in the radius</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="c1"># calculate angles that determine the storm boundary entrance  [degrees]</span>
    <span class="n">ang_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">lon1</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lat1</span> <span class="o">-</span> <span class="n">yc</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># upper right corner</span>
    <span class="n">ang_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">lon1</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lat0</span> <span class="o">-</span> <span class="n">yc</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">180</span>  <span class="c1"># lower right</span>
    <span class="n">ang_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">lon0</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lat0</span> <span class="o">-</span> <span class="n">yc</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">180</span>  <span class="c1"># lower left</span>
    <span class="n">ang_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">lon0</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lat1</span> <span class="o">-</span> <span class="n">yc</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">360</span>  <span class="c1"># upper left</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&gt;</span> <span class="n">ang_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&lt;</span> <span class="n">ang_2</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">lon1</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&gt;</span> <span class="n">ang_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&lt;</span> <span class="n">ang_3</span><span class="p">):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">lat0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&gt;</span> <span class="n">ang_3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&lt;</span> <span class="n">ang_4</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">lon0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&gt;</span> <span class="n">ang_4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">&lt;</span> <span class="n">ang_1</span><span class="p">):</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">lat1</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span></div>



<div class="viewcode-block" id="track_site_parameters">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.track_site_parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">track_site_parameters</span><span class="p">(</span>
    <span class="n">step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">pmin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">vmean</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lon0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lon1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lat0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lat1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">R</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">date_ini</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">center</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;WMO&quot;</span><span class="p">,</span>
    <span class="n">basin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SP&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate parameterized storm track within study area.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    step : float</span>
<span class="sd">        Computational time step in minutes.</span>
<span class="sd">    pmin : float</span>
<span class="sd">        Minimum central pressure in millibars.</span>
<span class="sd">    vmean : float</span>
<span class="sd">        Mean translation speed in knots.</span>
<span class="sd">    delta : float</span>
<span class="sd">        Storm track angle parameter in degrees.</span>
<span class="sd">    gamma : float</span>
<span class="sd">        Storm forward direction in degrees.</span>
<span class="sd">    x0 : float</span>
<span class="sd">        Site longitude coordinate in degrees.</span>
<span class="sd">    y0 : float</span>
<span class="sd">        Site latitude coordinate in degrees.</span>
<span class="sd">    lon0 : float</span>
<span class="sd">        Western longitude bound of computational domain.</span>
<span class="sd">    lon1 : float</span>
<span class="sd">        Eastern longitude bound of computational domain.</span>
<span class="sd">    lat0 : float</span>
<span class="sd">        Southern latitude bound of computational domain.</span>
<span class="sd">    lat1 : float</span>
<span class="sd">        Northern latitude bound of computational domain.</span>
<span class="sd">    R : float</span>
<span class="sd">        Radius of influence in degrees.</span>
<span class="sd">    date_ini : str</span>
<span class="sd">        Initial date in format &#39;YYYY-MM-DD HH:MM&#39;.</span>
<span class="sd">    center : str, optional</span>
<span class="sd">        IBTrACS center code. Default is &quot;WMO&quot;.</span>
<span class="sd">    basin : str, optional</span>
<span class="sd">        Storm basin identifier. Default is &quot;SP&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Storm track DataFrame with columns:</span>
<span class="sd">        - lon : Storm longitude coordinates</span>
<span class="sd">        - lat : Storm latitude coordinates</span>
<span class="sd">        - move : Forward direction (gamma)</span>
<span class="sd">        - vf : Translation speed (kt)</span>
<span class="sd">        - vfx : x-component of velocity</span>
<span class="sd">        - vfy : y-component of velocity</span>
<span class="sd">        - pn : Surface pressure (1013 mbar)</span>
<span class="sd">        - p0 : Minimum central pressure</span>
<span class="sd">        - vmax : Maximum winds (kt, 1-min avg)</span>
<span class="sd">        - rmw : Radius of maximum winds (nmile)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Calculates entrance coordinates at domain boundary</span>
<span class="sd">    2. Generates track points at computational time steps</span>
<span class="sd">    3. Estimates maximum winds from pressure using fitted coefficients</span>
<span class="sd">    4. Estimates radius of maximum winds using Knaff et al. (2016)</span>
<span class="sd">    5. Preserves metadata including site coordinates and radius</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; track = track_site_parameters(</span>
<span class="sd">    ...     step=30, pmin=950, vmean=10, delta=45, gamma=270,</span>
<span class="sd">    ...     x0=-75, y0=25, lon0=-80, lon1=-70, lat0=20, lat1=30,</span>
<span class="sd">    ...     R=5, date_ini=&#39;2020-09-01 00:00&#39;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Track points: {len(track)}&quot;)</span>
<span class="sd">    Track points: 96</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># storm entrance coordinates at the domain boundary</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">entrance_coords</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lat1</span><span class="p">)</span>

    <span class="c1"># calculate computational timestep storm coordinates</span>
    <span class="c1"># Note: velocity input in shoot function must be km/h</span>
    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">glon</span><span class="p">,</span> <span class="n">glat</span><span class="p">,</span> <span class="n">baz</span> <span class="o">=</span> <span class="n">shoot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">+</span> <span class="mi">180</span><span class="p">,</span> <span class="n">vmean</span> <span class="o">*</span> <span class="mf">1.852</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">step</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">glon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">glon</span> <span class="o">+=</span> <span class="mi">360</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">glon</span> <span class="o">&lt;</span> <span class="n">lon1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">glon</span> <span class="o">&gt;</span> <span class="n">lon0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">glat</span> <span class="o">&lt;</span> <span class="n">lat1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">glat</span> <span class="o">&gt;</span> <span class="n">lat0</span><span class="p">):</span>
        <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glon</span><span class="p">)</span>
        <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glat</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">glon</span><span class="p">,</span> <span class="n">glat</span><span class="p">,</span> <span class="n">baz</span> <span class="o">=</span> <span class="n">shoot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">+</span> <span class="mi">180</span><span class="p">,</span> <span class="n">vmean</span> <span class="o">*</span> <span class="mf">1.852</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">step</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">glon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">glon</span> <span class="o">+=</span> <span class="mi">360</span>
    <span class="n">frec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>

    <span class="c1"># select Pmin-Vmax polynomial fitting coefficients (IBTrACS center,basin)</span>
    <span class="n">xds_coef</span> <span class="o">=</span> <span class="n">ibtracs_fit_pmin_wmax</span><span class="p">()</span>
    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">xds_coef</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">basin</span><span class="o">=</span><span class="n">basin</span><span class="p">)</span><span class="o">.</span><span class="n">coef</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>
    <span class="n">wind_estimate</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">p1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p4</span>
    <span class="p">)</span>

    <span class="c1"># radii of maximum winds is filled with Knaff (2016) estimate</span>
    <span class="n">rmw_estimate</span> <span class="o">=</span> <span class="n">wind2rmw</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">wind_estimate</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">vmean</span><span class="p">),</span> <span class="n">lat</span>
    <span class="p">)</span>

    <span class="c1"># velocity components</span>
    <span class="n">vfx</span> <span class="o">=</span> <span class="n">vmean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">gamma</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>  <span class="c1"># [kt]</span>
    <span class="n">vfy</span> <span class="o">=</span> <span class="n">vmean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">gamma</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>  <span class="c1"># [kt]</span>

    <span class="c1"># time array for SWAN input</span>
    <span class="n">time_input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date_ini</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">frec</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">MIN&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>

    <span class="c1"># storm track (pd.DataFrame)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">time_input</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;vf&quot;</span><span class="p">,</span> <span class="s2">&quot;vfx&quot;</span><span class="p">,</span> <span class="s2">&quot;vfy&quot;</span><span class="p">,</span> <span class="s2">&quot;pn&quot;</span><span class="p">,</span> <span class="s2">&quot;p0&quot;</span><span class="p">,</span> <span class="s2">&quot;vmax&quot;</span><span class="p">,</span> <span class="s2">&quot;rmw&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span>  <span class="c1"># gamma, forward direction</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmean</span>  <span class="c1"># translation speed [kt]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vfx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vfx</span>  <span class="c1"># x-component</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vfy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vfy</span>  <span class="c1"># y-component</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;pn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1013</span>  <span class="c1"># average pressure at the surface [mbar]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;p0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmin</span>  <span class="c1"># minimum central pressure [mbar]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wind_estimate</span>  <span class="c1"># maximum winds [kt, 1-min avg]</span>
    <span class="n">st</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmw_estimate</span>  <span class="c1"># radii of maximum winds [nmile]</span>

    <span class="c1"># add metadata</span>
    <span class="n">st</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vf&quot;</span><span class="p">:</span> <span class="s2">&quot;kt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;p0&quot;</span><span class="p">:</span> <span class="s2">&quot;mbar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="s2">&quot;kt, 1-min avg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rmw&quot;</span><span class="p">:</span> <span class="s2">&quot;nmile&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="n">x0</span><span class="p">,</span>
        <span class="s2">&quot;y0&quot;</span><span class="p">:</span> <span class="n">y0</span><span class="p">,</span>
        <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">st</span></div>



<span class="c1">###############################################################################</span>
<span class="c1"># synthetic tracks</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="nakajo_track_preprocessing">
<a class="viewcode-back" href="../../../bluemath_tk.tcs.html#bluemath_tk.tcs.tracks.nakajo_track_preprocessing">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nakajo_track_preprocessing</span><span class="p">(</span><span class="n">xds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;WMO&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess synthetic storm track data from Nakajo format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xds : xr.Dataset</span>
<span class="sd">        Synthetic storm track dataset with storm dimension in Nakajo format.</span>
<span class="sd">        Must contain variables for time, longitude (ylon_TC), latitude (ylat_TC),</span>
<span class="sd">        and pressure (yCPRES).</span>
<span class="sd">    center : str, optional</span>
<span class="sd">        IBTrACS center code. Default is &quot;WMO&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Preprocessed storm track data with columns:</span>
<span class="sd">        - center : Storm center identifier</span>
<span class="sd">        - basin : Storm basin identifier (determined from coordinates)</span>
<span class="sd">        - dist2land : Distance to nearest land (fixed at 100 km)</span>
<span class="sd">        - longitude : Storm longitude (0-360°)</span>
<span class="sd">        - latitude : Storm latitude</span>
<span class="sd">        - move : Forward direction (degrees)</span>
<span class="sd">        - mean_velocity : Translation speed (kt)</span>
<span class="sd">        - pressure : Central pressure (mbar)</span>
<span class="sd">        - maxwinds : Maximum winds (kt, not provided)</span>
<span class="sd">        - rmw : Radius of maximum winds (not provided)</span>
<span class="sd">        - category : Storm category (0-6)</span>
<span class="sd">        - timestep : Time step (hours)</span>
<span class="sd">        - storm_vmean : Mean translation speed (kt)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function:</span>
<span class="sd">    1. Removes NaT (Not a Time) values from time coordinate</span>
<span class="sd">    2. Removes NaN values from pressure data</span>
<span class="sd">    3. Converts longitudes to [0°-360°] convention</span>
<span class="sd">    4. Determines basin based on storm coordinates</span>
<span class="sd">    5. Rounds dates to nearest hour</span>
<span class="sd">    6. Calculates translation speed and direction</span>
<span class="sd">    7. Determines storm category based on pressure</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; processed = nakajo_track_preprocessing(nakajo_data, center=&#39;WMO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Track duration: {len(processed)} time steps&quot;)</span>
<span class="sd">    Track duration: 48</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Storm category: {processed[&#39;category&#39;].iloc[0]}&quot;)</span>
<span class="sd">    Storm category: 3</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get names of variables</span>
    <span class="n">nm_tim</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    <span class="n">nm_lon</span> <span class="o">=</span> <span class="s2">&quot;ylon_TC&quot;</span>
    <span class="n">nm_lat</span> <span class="o">=</span> <span class="s2">&quot;ylat_TC&quot;</span>
    <span class="n">nm_prs</span> <span class="o">=</span> <span class="s2">&quot;yCPRES&quot;</span>

    <span class="c1"># get var time</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_tim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># dates format: datetime64</span>

    <span class="c1"># remove NaTs (time)</span>
    <span class="n">ylat_tc</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_lat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># latitude</span>
    <span class="n">ylon_tc</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_lon</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># longitude</span>
    <span class="n">ycpres</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">nm_prs</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>  <span class="c1"># pressure [mbar]</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnat</span><span class="p">(</span><span class="n">ytime</span><span class="p">)]</span>

    <span class="c1"># remove common NaNs (pressure)</span>
    <span class="n">posnonan_p_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ycpres</span><span class="p">)))</span>
    <span class="n">ytime</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">st_lat</span> <span class="o">=</span> <span class="n">ylat_tc</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">st_lon</span> <span class="o">=</span> <span class="n">ylon_tc</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>
    <span class="n">st_pres</span> <span class="o">=</span> <span class="n">ycpres</span><span class="p">[</span><span class="n">posnonan_p_w</span><span class="p">]</span>

    <span class="c1">###########################################################################</span>
    <span class="c1"># longitude convention: [0º,360º]</span>
    <span class="n">st_lon</span><span class="p">[</span><span class="n">st_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">st_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>

    <span class="c1"># get basin</span>
    <span class="n">ybasin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ytime</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S10&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ytime</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">ilo</span><span class="p">,</span> <span class="n">ila</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">135</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SI&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">135</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">290</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SP&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">290</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SA&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NI&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WP&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">260</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;EP&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ila</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&gt;</span> <span class="mi">260</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ilo</span> <span class="o">&lt;</span> <span class="mi">275</span><span class="p">):</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;EP&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ybasin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>

    <span class="c1">###########################################################################</span>

    <span class="c1"># only when storm data available</span>
    <span class="k">if</span> <span class="n">st_pres</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># round dates to hour</span>
        <span class="n">round_to</span> <span class="o">=</span> <span class="mi">3600</span>
        <span class="n">st_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ytime</span><span class="p">)):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">ytime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[s]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">min</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
            <span class="n">rounding</span> <span class="o">=</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">round_to</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="n">round_to</span> <span class="o">*</span> <span class="n">round_to</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rounding</span> <span class="o">-</span> <span class="n">seconds</span><span class="p">,</span> <span class="o">-</span><span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
            <span class="n">st_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">st_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">st_time</span><span class="p">)</span>

        <span class="c1"># storm coordinates timestep [hours]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">st_time</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">st_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># calculate Vmean</span>
        <span class="n">st_vmean</span><span class="p">,</span> <span class="n">st_move</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># consecutive storm coordinates</span>
            <span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lon</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">st_lat</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># translation speed</span>
            <span class="n">gamma_h</span><span class="p">,</span> <span class="n">vel_mean</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_vmean</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">st_vmean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vel_mean</span> <span class="o">/</span> <span class="mf">1.852</span><span class="p">)</span>  <span class="c1"># translation speed [km/h to kt]</span>
            <span class="n">st_move</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma_h</span><span class="p">)</span>  <span class="c1"># forward direction [º]</span>
        <span class="n">st_vmean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">st_move</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># mean value</span>
        <span class="n">vmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">st_vmean</span><span class="p">)</span>  <span class="c1"># [kt]</span>

        <span class="c1"># storm category</span>
        <span class="n">categ</span> <span class="o">=</span> <span class="n">get_category</span><span class="p">(</span><span class="n">st_pres</span><span class="p">)</span>

        <span class="c1"># get basin string</span>
        <span class="n">st_basin</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ybasin</span><span class="p">]</span>

        <span class="c1"># store storm variables</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">st_time</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="s2">&quot;basin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dist2land&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;move&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mean_velocity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pressure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxwinds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rmw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;storm_vmean&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>  <span class="c1"># hypothesis winds 1-min</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;basin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_basin</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dist2land&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_lon</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_lat</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_move</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mean_velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_vmean</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_pres</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;maxwinds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rmw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categ</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;storm_vmean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmean</span>

        <span class="n">df</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dist2land&quot;</span><span class="p">:</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
            <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="s2">&quot;kt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="s2">&quot;mbar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;maxwinds&quot;</span><span class="p">:</span> <span class="s2">&quot;kt, 1-min average sustained winds (converted from X-min)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rmw&quot;</span><span class="p">:</span> <span class="s2">&quot;nmile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="s2">&quot;hour&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="s2">&quot;basin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dist2land&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;move&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mean_velocity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pressure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxwinds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rmw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;storm_vmean&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, GeoOcean Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>